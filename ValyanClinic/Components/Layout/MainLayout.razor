@inherits LayoutComponentBase
@implements IDisposable
@inject NavigationManager Navigation

<div class="app-layout">
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" @onclick="ToggleSidebar" aria-label="Toggle navigation menu">
        <span class="hamburger"></span>
        <span class="hamburger"></span>
        <span class="hamburger"></span>
    </button>

    <!-- Backdrop for mobile -->
    @if (isSidebarOpen)
    {
        <div class="sidebar-backdrop" @onclick="CloseSidebar" role="presentation"></div>
    }

    <!-- Sidebar -->
    <aside class="sidebar @(isSidebarOpen ? "open" : "")" role="navigation" aria-label="Main navigation">
        <div class="sidebar-header">
            <div class="sidebar-title">ValyanMed</div>
            <button class="sidebar-close" @onclick="CloseSidebar" aria-label="Close navigation menu">×</button>
        </div>
        <nav class="sidebar-nav">
            @foreach (var parent in Menu)
            {
                <details class="menu-group" @key="parent.GetHashCode()" @(parent.Expanded ? "open" : null)>
                    <summary class="menu-parent">
                        <span>@parent.Text</span>
                    </summary>

                    @if (parent.Children.Count > 0)
                    {
                        <ul class="menu-children">
                            @foreach (var child in parent.Children)
                            {
                                <li class="menu-item" @key="child.GetHashCode()">
                                    @if (child.Children.Count == 0)
                                    {
                                        <NavLink href="@child.Path" class="menu-link" ActiveClass="active-link" @onclick="OnLinkClick">
                                            @child.Text
                                        </NavLink>
                                    }
                                    else
                                    {
                                        <details @key="child.GetHashCode()">
                                            <summary class="menu-submenu">
                                                <span>@child.Text</span>
                                            </summary>
                                            <ul class="menu-subchildren">
                                                @foreach (var sub in child.Children)
                                                {
                                                    <li @key="sub.GetHashCode()">
                                                        <NavLink href="@sub.Path" class="menu-link" ActiveClass="active-link" @onclick="OnLinkClick">
                                                            @sub.Text
                                                        </NavLink>
                                                    </li>
                                                }
                                            </ul>
                                        </details>
                                    }
                                </li>
                            }
                        </ul>
                    }
                </details>
            }
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content @(isSidebarOpen ? "sidebar-open" : "")" role="main">
        <!-- Header -->
        <header class="main-header">
            <div class="header-content">
                <div class="header-title">Aplicatie ValyanMed</div>
                <div class="header-subtitle">Sistem de management medical</div>
            </div>
        </header>

        <!-- Page Content -->
        <div class="page-content">
            <ErrorBoundary>
                <ChildContent>
                    @Body
                </ChildContent>
                <ErrorContent>
                    <div class="error-container">
                        <div class="error-message">
                            <span class="error-icon">⚠️</span>
                            <div>
                                <strong>A aparut o eroare neasteptata</strong>
                                <div>Va rugam sa reimprospatatai pagina sau sa contactati suportul tehnic.</div>
                            </div>
                        </div>
                        <button class="btn-secondary" @onclick="RefreshPage">
                            Reimprospateaza pagina
                        </button>
                    </div>
                </ErrorContent>
            </ErrorBoundary>
        </div>
    </main>
</div>

@code {
    private bool isSidebarOpen = false;
    private List<MenuItem> Menu { get; set; } = new();

    protected override void OnInitialized()
    {
        try
        {
            Menu = new()
            {
                new MenuItem("Managementul Pacientilor") { Expanded = true, Children =
                    {
                        new MenuItem("Lista Pacienti", "/parinte1/copil1"),
                        new MenuItem("Inregistrare Noua", "/parinte1/copil2"),
                        new MenuItem("Dosare Medicale")
                        {
                            Children =
                            {
                                new MenuItem("Consultatii", "/parinte1/copil3/copil1"),
                                new MenuItem("Investigatii", "/parinte1/copil3/copil2"),
                            }
                        }
                    }
                },
                new MenuItem("Programari")
                {
                    Children =
                    {
                        new MenuItem("Calendar", "/parinte2/copil1"),
                        new MenuItem("Programari Noi", "/parinte2/copil2"),
                        new MenuItem("Gestionare Programari", "/parinte2/copil3"),
                    }
                },
                new MenuItem("Facturare & Plati")
                {
                    Children =
                    {
                        new MenuItem("Facturi", "/parinte3/copil1"),
                        new MenuItem("Plati", "/parinte3/copil2"),
                        new MenuItem("Rapoarte Financiare", "/parinte3/copil3"),
                    }
                },
                new MenuItem("Stocuri & Inventar")
                {
                    Children =
                    {
                        new MenuItem("Medicamente", "/parinte4/copil1"),
                        new MenuItem("Consumabile", "/parinte4/copil2"),
                        new MenuItem("Echipamente", "/parinte4/copil3"),
                    }
                },
                new MenuItem("Administrare")
                {
                    Children =
                    {
                        new MenuItem("Utilizatori", "/utilizatori"),
                        new MenuItem("Administrare Personal")
                        {
                            Children =
                            {
                                new MenuItem("Administrare Personal", "/administrare/personal"),
                                new MenuItem("Administrare Personal Medical", "/administrare/personal-medical"),
                            }
                        },
                        new MenuItem("Setari Clinica", "/parinte5/copil2"),
                        new MenuItem("Backup & Securitate", "/parinte5/copil3"),
                    }
                },
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing menu: {ex.Message}");
            Menu = new(); // Fallback to empty menu
        }
    }

    private void ToggleSidebar()
    {
        try
        {
            isSidebarOpen = !isSidebarOpen;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error toggling sidebar: {ex.Message}");
        }
    }

    private void CloseSidebar()
    {
        try
        {
            isSidebarOpen = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error closing sidebar: {ex.Message}");
        }
    }

    private void OnLinkClick()
    {
        try
        {
            // Inchide sidebar-ul pe mobile cand se face click pe un link
            if (isSidebarOpen)
            {
                isSidebarOpen = false;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error handling link click: {ex.Message}");
        }
    }

    private void RefreshPage()
    {
        try
        {
            Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error refreshing page: {ex.Message}");
        }
    }

    public void Dispose()
    {
        // Cleanup resources if needed
        Menu?.Clear();
    }

    private class MenuItem
    {
        public string Text { get; set; } = string.Empty;
        public string? Path { get; set; }
        public bool Expanded { get; set; }
        public List<MenuItem> Children { get; set; } = new();

        public MenuItem(string text, string? path = null)
        {
            Text = text;
            Path = path;
        }

        public override int GetHashCode()
        {
            return HashCode.Combine(Text, Path);
        }
    }
}
