@*
    Tab Investigații - Consultație (Design simplificat cu 3 carduri)
    Include: Imagistice, Explorări Funcționale, Endoscopii - fiecare în card separat
    Cu dropdown categorie -> dropdown investigație dependent -> observații
*@
@using ValyanClinic.Application.DTOs.Investigatii
@using Syncfusion.Blazor.DropDowns

<div class="tab-pane @(IsActive ? "active" : "")" id="tab-investigatii">
    
    <!-- ========== GRID CU 3 CARDURI ========== -->
    <div class="investigatii-cards-grid">
        
        <!-- CARD 1: INVESTIGAȚII IMAGISTICE -->
        <div class="investigatie-card">
            <div class="card-header imagistice">
                <i class="fas fa-x-ray"></i>
                <span>Investigatii Imagistice</span>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Categorie</label>
                    <SfDropDownList TValue="string"
                                    TItem="string"
                                    @bind-Value="_selectedCategorieImagistice"
                                    DataSource="@_categoriiImagistice"
                                    Placeholder="Selecteaza categoria..."
                                    AllowFiltering="true">
                        <DropDownListEvents TValue="string" TItem="string"
                                            ValueChange="OnCategorieImagisticeChanged" />
                    </SfDropDownList>
                </div>
                <div class="form-group">
                    <label class="form-label">Investigatie</label>
                    <SfDropDownList TValue="Guid?"
                                    TItem="NomenclatorInvestigatieImagisticaDto"
                                    @bind-Value="_selectedImagisticaId"
                                    DataSource="@_filteredImagistice"
                                    Placeholder="Selecteaza investigatie..."
                                    AllowFiltering="true"
                                    Enabled="@(!string.IsNullOrEmpty(_selectedCategorieImagistice))">
                        <DropDownListFieldSettings Value="Id" Text="Denumire" />
                        <DropDownListEvents TValue="Guid?" TItem="NomenclatorInvestigatieImagisticaDto"
                                            ValueChange="OnImagisticaSelected" />
                    </SfDropDownList>
                </div>
                <div class="form-group">
                    <label class="form-label">Observatii</label>
                    <input type="text" class="form-control" 
                           @bind="_observatiiImagistice" 
                           placeholder="Observatii..." />
                </div>
                <div class="card-actions">
                    <button type="button" class="btn btn-primary btn-sm" 
                            @onclick="AddImagisticaAsync"
                            disabled="@(!_selectedImagisticaId.HasValue)">
                        <i class="fas fa-plus"></i> Adauga
                    </button>
                </div>
                
                <!-- Lista investigații adăugate -->
                @if (_investigatiiImagisticeRecomandate.Any())
                {
                    <div class="added-items">
                        @foreach (var inv in _investigatiiImagisticeRecomandate)
                        {
                            <div class="chip-item">
                                <span class="chip-text">@inv.DenumireInvestigatie</span>
                                @if (!string.IsNullOrEmpty(inv.RegiuneAnatomica))
                                {
                                    <span class="chip-obs">(@inv.RegiuneAnatomica)</span>
                                }
                                <button type="button" class="chip-delete" @onclick="() => DeleteImagisticaAsync(inv.Id)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- CARD 2: EXPLORĂRI FUNCȚIONALE -->
        <div class="investigatie-card">
            <div class="card-header explorari">
                <i class="fas fa-heartbeat"></i>
                <span>Explorari Functionale</span>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Categorie</label>
                    <SfDropDownList TValue="string"
                                    TItem="string"
                                    @bind-Value="_selectedCategorieExplorari"
                                    DataSource="@_categoriiExplorari"
                                    Placeholder="Selecteaza categoria..."
                                    AllowFiltering="true">
                        <DropDownListEvents TValue="string" TItem="string"
                                            ValueChange="OnCategorieExplorariChanged" />
                    </SfDropDownList>
                </div>
                <div class="form-group">
                    <label class="form-label">Explorare</label>
                    <SfDropDownList TValue="Guid?"
                                    TItem="NomenclatorExplorareFuncDto"
                                    @bind-Value="_selectedExplorareId"
                                    DataSource="@_filteredExplorari"
                                    Placeholder="Selecteaza explorare..."
                                    AllowFiltering="true"
                                    Enabled="@(!string.IsNullOrEmpty(_selectedCategorieExplorari))">
                        <DropDownListFieldSettings Value="Id" Text="Denumire" />
                        <DropDownListEvents TValue="Guid?" TItem="NomenclatorExplorareFuncDto"
                                            ValueChange="OnExplorareSelected" />
                    </SfDropDownList>
                </div>
                <div class="form-group">
                    <label class="form-label">Observatii</label>
                    <input type="text" class="form-control" 
                           @bind="_observatiiExplorari" 
                           placeholder="Observatii..." />
                </div>
                <div class="card-actions">
                    <button type="button" class="btn btn-primary btn-sm" 
                            @onclick="AddExplorareAsync"
                            disabled="@(!_selectedExplorareId.HasValue)">
                        <i class="fas fa-plus"></i> Adauga
                    </button>
                </div>
                
                <!-- Lista explorări adăugate -->
                @if (_explorariRecomandate.Any())
                {
                    <div class="added-items">
                        @foreach (var exp in _explorariRecomandate)
                        {
                            <div class="chip-item">
                                <span class="chip-text">@exp.DenumireExplorare</span>
                                @if (!string.IsNullOrEmpty(exp.IndicatiiClinice))
                                {
                                    <span class="chip-obs">(@exp.IndicatiiClinice)</span>
                                }
                                <button type="button" class="chip-delete" @onclick="() => DeleteExplorareAsync(exp.Id)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- CARD 3: ENDOSCOPII -->
        <div class="investigatie-card">
            <div class="card-header endoscopii">
                <i class="fas fa-microscope"></i>
                <span>Endoscopii</span>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Categorie</label>
                    <SfDropDownList TValue="string"
                                    TItem="string"
                                    @bind-Value="_selectedCategorieEndoscopii"
                                    DataSource="@_categoriiEndoscopii"
                                    Placeholder="Selecteaza categoria..."
                                    AllowFiltering="true">
                        <DropDownListEvents TValue="string" TItem="string"
                                            ValueChange="OnCategorieEndoscopiiChanged" />
                    </SfDropDownList>
                </div>
                <div class="form-group">
                    <label class="form-label">Endoscopie</label>
                    <SfDropDownList TValue="Guid?"
                                    TItem="NomenclatorEndoscopieDto"
                                    @bind-Value="_selectedEndoscopieId"
                                    DataSource="@_filteredEndoscopii"
                                    Placeholder="Selecteaza endoscopie..."
                                    AllowFiltering="true"
                                    Enabled="@(!string.IsNullOrEmpty(_selectedCategorieEndoscopii))">
                        <DropDownListFieldSettings Value="Id" Text="Denumire" />
                        <DropDownListEvents TValue="Guid?" TItem="NomenclatorEndoscopieDto"
                                            ValueChange="OnEndoscopieSelected" />
                    </SfDropDownList>
                </div>
                <div class="form-group">
                    <label class="form-label">Observatii</label>
                    <input type="text" class="form-control" 
                           @bind="_observatiiEndoscopii" 
                           placeholder="Observatii..." />
                </div>
                <div class="card-actions">
                    <button type="button" class="btn btn-primary btn-sm" 
                            @onclick="AddEndoscopieAsync"
                            disabled="@(!_selectedEndoscopieId.HasValue)">
                        <i class="fas fa-plus"></i> Adauga
                    </button>
                </div>
                
                <!-- Lista endoscopii adăugate -->
                @if (_endoscopiiRecomandate.Any())
                {
                    <div class="added-items">
                        @foreach (var endo in _endoscopiiRecomandate)
                        {
                            <div class="chip-item">
                                <span class="chip-text">@endo.DenumireEndoscopie</span>
                                @if (!string.IsNullOrEmpty(endo.IndicatiiClinice))
                                {
                                    <span class="chip-obs">(@endo.IndicatiiClinice)</span>
                                }
                                <button type="button" class="chip-delete" @onclick="() => DeleteEndoscopieAsync(endo.Id)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- ========== CÂMPURI TEXT LEGACY ========== -->
    <div class="section-card legacy-section">
        <h5 class="section-title">
            <i class="fas fa-edit"></i>
            Note Investigatii (Text Liber)
        </h5>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label>Investigatii Laborator</label>
                    <textarea class="form-control" rows="3" 
                              placeholder="Hemoleucograma, VSH, transaminaze..."
                              @bind="Model.InvestigatiiLaborator"
                              @oninput="OnFieldChanged"></textarea>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label>Investigatii Imagistice (note)</label>
                    <textarea class="form-control" rows="3" 
                              placeholder="Radiografie, ecografie, CT..."
                              @bind="Model.InvestigatiiImagistice"
                              @oninput="OnFieldChanged"></textarea>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label>EKG</label>
                    <textarea class="form-control" rows="3" 
                              placeholder="Ritm sinusal, fara modificari ST-T..."
                              @bind="Model.InvestigatiiEKG"
                              @oninput="OnFieldChanged"></textarea>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label>Alte Investigatii</label>
                    <textarea class="form-control" rows="3" 
                              placeholder="Alte investigatii efectuate..."
                              @bind="Model.AlteInvestigatii"
                              @oninput="OnFieldChanged"></textarea>
                </div>
            </div>
        </div>
    </div>

    @* Section Completed Indicator *@
    @if (IsSectionCompleted)
    {
        <div class="section-completed-indicator">
            <i class="fas fa-check-circle"></i>
            <span>Sectiune completata</span>
        </div>
    }
</div>
