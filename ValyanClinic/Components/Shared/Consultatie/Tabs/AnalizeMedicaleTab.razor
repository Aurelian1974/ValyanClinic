@using ValyanClinic.Application.ViewModels
@using ValyanClinic.Application.Services.Analize
@using ValyanClinic.Application.Features.Analize.Models
@using ValyanClinic.Components.Shared.Medical
@using Syncfusion.Blazor.DropDowns
@*
    Tab Analize Medicale pentru consultație
    Include: Analize recomandate + Analize efectuate (cu rezultate)
    Folosește secțiune inline expandabilă pentru adăugare (fără modal)
*@

<div class="analize-tab-container">
    
    <!-- ========== SECȚIUNEA 1: ANALIZE RECOMANDATE ========== -->
    <div class="form-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="fas fa-clipboard-list"></i>
                Analize Recomandate
                @if (AnalizeRecomandate.Any())
                {
                    <span class="badge-count">@AnalizeRecomandate.Count</span>
                }
            </h3>
            <button type="button" 
                    class="btn @(_showAddForm ? "btn-secondary" : "btn-primary") btn-sm" 
                    @onclick="ToggleAddForm">
                @if (_showAddForm)
                {
                    <i class="fas fa-times"></i>
                    <span>Închide</span>
                }
                else
                {
                    <i class="fas fa-plus"></i>
                    <span>Adaugă Analiză</span>
                }
            </button>
        </div>

        <!-- ========== FORMULAR INLINE EXPANDABIL ========== -->
        @if (_showAddForm)
        {
            <div class="add-analiza-inline @(_showAddForm ? "expanded" : "")">
                <div class="inline-form-header">
                    <i class="fas fa-flask"></i>
                    <span>Adaugă Analiză Recomandată</span>
                </div>
                
                @if (!string.IsNullOrEmpty(_formErrorMessage))
                {
                    <div class="alert alert-danger alert-sm">
                        <i class="fas fa-exclamation-triangle"></i>
                        @_formErrorMessage
                    </div>
                }

                <div class="inline-form-body">
                    <div class="form-row-3">
                        <div class="form-group form-group-lg">
                            <label class="form-label required">
                                <i class="fas fa-flask"></i>
                                Analiză
                            </label>
                            <SfAutoComplete @ref="_autoCompleteRef"
                                            TValue="Guid?"
                                            TItem="AnalizaMedicalaListDto"
                                            @bind-Value="_selectedAnalizaId"
                                            DataSource="@_analizeSuggestions"
                                            Placeholder="Caută analiză (ex: Hemoleucogramă, Glicemie, TSH)..."
                                            AllowFiltering="true"
                                            FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains"
                                            IgnoreAccent="true"
                                            ShowPopupButton="true"
                                            MinLength="2"
                                            CssClass="@(string.IsNullOrEmpty(_newAnaliza.NumeAnaliza) && _formSubmitted ? "e-error" : "")">
                                <AutoCompleteFieldSettings Value="AnalizaID" Text="NumeAnaliza" />
                                <AutoCompleteTemplates TItem="AnalizaMedicalaListDto">
                                    <ItemTemplate Context="item">
                                        <div class="autocomplete-item-analiza">
                                            <div class="item-main">
                                                <strong>@item.NumeAnaliza</strong>
                                                @if (!string.IsNullOrEmpty(item.NumeScurt))
                                                {
                                                    <span class="item-short">(@item.NumeScurt)</span>
                                                }
                                            </div>
                                            <div class="item-details">
                                                <span class="item-category">
                                                    <i class="fas fa-folder-open"></i> @item.NumeCategorie
                                                </span>
                                                @if (item.Pret.HasValue)
                                                {
                                                    <span class="item-price">@item.Pret.Value.ToString("N2") RON</span>
                                                }
                                            </div>
                                        </div>
                                    </ItemTemplate>
                                </AutoCompleteTemplates>
                                <AutoCompleteEvents TValue="Guid?" TItem="AnalizaMedicalaListDto"
                                                    Filtering="OnAnalizaFiltering"
                                                    ValueChange="OnAnalizaSelected" />
                            </SfAutoComplete>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-folder-open"></i>
                                Categorie
                            </label>
                            <input type="text" 
                                   class="form-control readonly-field"
                                   value="@_selectedCategorie"
                                   readonly
                                   placeholder="Se completează automat" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-flag"></i>
                                Prioritate
                            </label>
                            <select class="form-control" @bind="_newAnaliza.Prioritate">
                                <option value="Normala">Normală</option>
                                <option value="Urgent">Urgent</option>
                                <option value="Foarte urgent">Foarte Urgent</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row-cito">
                        <div class="form-group checkbox-group">
                            <label class="form-check-label">
                                <input type="checkbox" 
                                       class="form-check-input"
                                       @bind="_newAnaliza.EsteCito" />
                                <span class="cito-label">
                                    <i class="fas fa-exclamation-circle text-danger"></i>
                                    CITO (Foarte Urgent)
                                </span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="inline-form-footer">
                    <button type="button" 
                            class="btn btn-outline-secondary btn-sm" 
                            @onclick="CancelAddForm"
                            disabled="@_isSaving">
                        <i class="fas fa-times"></i>
                        Anulează
                    </button>
                    <button type="button" 
                            class="btn btn-success btn-sm" 
                            @onclick="HandleAddAnaliza"
                            disabled="@_isSaving">
                        @if (_isSaving)
                        {
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Se salvează...</span>
                        }
                        else
                        {
                            <i class="fas fa-check"></i>
                            <span>Adaugă</span>
                        }
                    </button>
                </div>
            </div>
        }

        <!-- ========== LISTA ANALIZE RECOMANDATE (DOUĂ TABELE) ========== -->
        @if (AnalizeRecomandate.Any())
        {
            <div class="analize-tables-container">
                <!-- Tabel Stânga -->
                <div class="analize-table-wrapper">
                    <table class="analize-table">
                        <thead>
                            <tr>
                                <th class="col-categorie">Categorie</th>
                                <th class="col-denumire">Denumire Analiză</th>
                                <th class="col-actions"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var analiza in GetAnalizeStanga())
                            {
                                <tr class="@(analiza.EsteCito ? "row-cito" : "")">
                                    <td class="col-categorie">
                                        <span class="categorie-badge">@analiza.TipAnaliza</span>
                                    </td>
                                    <td class="col-denumire">
                                        <div class="denumire-content">
                                            <span class="denumire-text">@analiza.NumeAnaliza</span>
                                            @if (analiza.EsteCito)
                                            {
                                                <span class="cito-indicator" title="CITO - Foarte Urgent">
                                                    <i class="fas fa-exclamation-circle"></i>
                                                </span>
                                            }
                                        </div>
                                    </td>
                                    <td class="col-actions">
                                        <button type="button" class="btn-icon-sm btn-icon-danger" @onclick="() => DeleteAnaliza(analiza.Id)" title="Șterge">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Tabel Dreapta -->
                <div class="analize-table-wrapper">
                    <table class="analize-table">
                        <thead>
                            <tr>
                                <th class="col-categorie">Categorie</th>
                                <th class="col-denumire">Denumire Analiză</th>
                                <th class="col-actions"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var analiza in GetAnalizeDreapta())
                            {
                                <tr class="@(analiza.EsteCito ? "row-cito" : "")">
                                    <td class="col-categorie">
                                        <span class="categorie-badge">@analiza.TipAnaliza</span>
                                    </td>
                                    <td class="col-denumire">
                                        <div class="denumire-content">
                                            <span class="denumire-text">@analiza.NumeAnaliza</span>
                                            @if (analiza.EsteCito)
                                            {
                                                <span class="cito-indicator" title="CITO - Foarte Urgent">
                                                    <i class="fas fa-exclamation-circle"></i>
                                                </span>
                                            }
                                        </div>
                                    </td>
                                    <td class="col-actions">
                                        <button type="button" class="btn-icon-sm btn-icon-danger" @onclick="() => DeleteAnaliza(analiza.Id)" title="Șterge">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
        else if (!_showAddForm)
        {
            <div class="no-data-message">
                <i class="fas fa-clipboard-list"></i>
                <span>Nu există analize recomandate pentru această consultație</span>
            </div>
        }
    </div>

    <!-- ========== SECȚIUNEA 2: ANALIZE EFECTUATE (IMPORT DIN PDF) ========== -->
    <div class="form-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="fas fa-flask"></i>
                Analize Efectuate (Rezultate)
                @if (AnalizeEfectuate.Any())
                {
                    <span class="badge-count">@AnalizeEfectuate.Count</span>
                }
            </h3>
            <button type="button" class="btn btn-primary btn-sm" @onclick="ShowImportAnalizaModal">
                <i class="fas fa-file-pdf"></i>
                Importă din PDF
            </button>
        </div>
        
        @if (AnalizeEfectuateGroups.Any())
        {
            <AnalizeMedicaleViewer Groups="@AnalizeEfectuateGroups" IsLoading="@_isLoading" />
        }
        else
        {
            <div class="no-data-message">
                <i class="fas fa-info-circle"></i>
                <span>Importați rezultatele analizelor din PDF-ul buletinului de laborator</span>
            </div>
        }
    </div>

    @* Section Completed Indicator *@
    @if (IsSectionCompleted)
    {
        <div class="section-completed-indicator">
            <i class="fas fa-check-circle"></i>
            <span>Secțiune completată</span>
        </div>
    }
</div>

<!-- Import PDF Modal -->
<ImportAnalizePdfModal 
    @ref="_importPdfModal"
    OnImportComplete="OnImportAnalizePdfComplete" />
