@*
    Tab pentru Diagnostic
    Include diagnostic pozitiv, diferențial, etiologic și coduri ICD-10
    v2.0: Inline search (fără drag & drop)
*@
@using ValyanClinic.Application.Features.ICD10Management.DTOs

<div class="tab-content-section">
    <div class="section-title">
        <i class="fas fa-diagnoses"></i>
        <h4>Diagnostic</h4>
    </div>
    
    @* Diagnostic Pozitiv *@
    <div class="form-group">
        <label class="form-label required">
            Diagnostic pozitiv
        </label>
        <textarea class="form-control" 
                  rows="3"
                  placeholder="Descrieți diagnosticul principal stabilit..."
                  @bind="Model.DiagnosticPozitiv"
                  @oninput="OnFieldChanged">
        </textarea>
        @if (ShowValidation && string.IsNullOrWhiteSpace(Model.DiagnosticPozitiv))
        {
            <div class="invalid-feedback d-block">
                <i class="fas fa-exclamation-circle"></i>
                Diagnosticul este obligatoriu
            </div>
        }
    </div>
    
    @* Cod ICD-10 Principal - Inline Search *@
    <div class="form-group">
        <label class="form-label">
            <i class="fas fa-tag text-primary"></i>
            Cod ICD-10 Principal
        </label>
        
        @if (string.IsNullOrEmpty(Model.CoduriICD10))
        {
            <div class="icd10-inline-search">
                <div class="icd10-search-wrapper">
                    <input type="text" 
                           class="form-control icd10-search-input" 
                           placeholder="Căutați cod ICD-10 (ex: I10, J18, diabet)..."
                           @bind="SearchTermPrincipal"
                           @bind:event="oninput"
                           @bind:after="OnSearchPrincipalAsync" />
                    @if (IsSearchingPrincipal)
                    {
                        <span class="search-spinner"><i class="fas fa-spinner fa-spin"></i></span>
                    }
                </div>
                
                @if (SearchResultsPrincipal.Any())
                {
                    <div class="icd10-search-results">
                        @foreach (var item in SearchResultsPrincipal.Take(6))
                        {
                            <div class="icd10-result-item" @onclick="() => SelectICD10Principal(item)">
                                <span class="icd10-code">@item.Code</span>
                                <span class="icd10-desc">@item.ShortDescription</span>
                                <i class="fas fa-plus-circle text-success select-icon"></i>
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <div class="icd10-selected-chip principal">
                <i class="fas fa-check-circle text-success"></i>
                <span class="chip-code">@Model.CoduriICD10</span>
                <button type="button" class="btn-remove" @onclick="ClearICD10Principal" title="Șterge codul">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        }
    </div>
    
    @* Diagnostic Diferențial *@
    <div class="form-group">
        <label class="form-label">
            Diagnostic diferențial
        </label>
        <textarea class="form-control" 
                  rows="3"
                  placeholder="Liste diagnostice alternative care trebuie excluse..."
                  @bind="Model.DiagnosticDiferential"
                  @oninput="OnFieldChanged">
        </textarea>
        <small class="form-text text-muted">
            <i class="fas fa-info-circle"></i>
            Diagnostice cu simptomatologie similară care trebuie luate în considerare
        </small>
    </div>
    
    @* Diagnostic Etiologic *@
    <div class="form-group">
        <label class="form-label">
            Diagnostic etiologic
        </label>
        <textarea class="form-control" 
                  rows="2"
                  placeholder="Cauza bolii (ex: infecțioasă, traumatică, genetică...)..."
                  @bind="Model.DiagnosticEtiologic"
                  @oninput="OnFieldChanged">
        </textarea>
    </div>
    
    @* Cod ICD-10 Secundar - Inline Search *@
    <div class="form-group">
        <label class="form-label">
            <i class="fas fa-plus text-primary"></i>
            Cod ICD-10 Secundar
        </label>
        
        @if (string.IsNullOrEmpty(Model.CoduriICD10Secundare))
        {
            <div class="icd10-inline-search">
                <div class="icd10-search-wrapper">
                    <input type="text" 
                           class="form-control icd10-search-input" 
                           placeholder="Căutați cod ICD-10 secundar..."
                           @bind="SearchTermSecundar"
                           @bind:event="oninput"
                           @bind:after="OnSearchSecundarAsync" />
                    @if (IsSearchingSecundar)
                    {
                        <span class="search-spinner"><i class="fas fa-spinner fa-spin"></i></span>
                    }
                </div>
                
                @if (SearchResultsSecundar.Any())
                {
                    <div class="icd10-search-results">
                        @foreach (var item in SearchResultsSecundar.Take(6))
                        {
                            <div class="icd10-result-item" @onclick="() => SelectICD10Secundar(item)">
                                <span class="icd10-code">@item.Code</span>
                                <span class="icd10-desc">@item.ShortDescription</span>
                                <i class="fas fa-plus-circle text-success select-icon"></i>
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <div class="icd10-selected-chip secundar">
                <i class="fas fa-plus text-primary"></i>
                <span class="chip-code">@Model.CoduriICD10Secundare</span>
                <button type="button" class="btn-remove" @onclick="ClearICD10Secundar" title="Șterge codul">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        }
    </div>
    
    @if (OnSectionCompleted.HasDelegate && IsComplete)
    {
        <div class="section-complete-indicator">
            <i class="fas fa-check-circle"></i>
            <span>Secțiune completată</span>
        </div>
    }
</div>
