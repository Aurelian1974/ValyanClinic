@*
    Secondary Diagnoses List - Compact & Elegant Design
    Features:
    - Inline compact design (no large cards)
    - Quick add with minimal space
    - Collapsible entries
    - Modern chip-based display
*@
@using ValyanClinic.Components.Shared.ICD10
@using Syncfusion.Blazor.RichTextEditor

<div class="secondary-diagnoses-container">
    <!-- Compact Header with inline Add button -->
    <div class="secondary-header-compact">
        <div class="header-left">
            <i class="fas fa-list-ul"></i>
            <span class="header-title">Diagnostic Secundar</span>
            <span class="header-counter">@SecondaryDiagnoses.Count/10</span>
        </div>
        
        @if (!IsMaxReached)
        {
            <button type="button" class="btn-add-compact" @onclick="AddSecondaryDiagnosis" title="Adaugă diagnostic secundar">
                <i class="fas fa-plus"></i>
                <span>Adaugă</span>
            </button>
        }
    </div>

    <!-- Diagnoses List - Compact Inline Style -->
    <div class="diagnoses-list-compact">
        @if (!SecondaryDiagnoses.Any())
        {
            <div class="empty-state-compact">
                <i class="fas fa-plus-circle"></i>
                <span>Click "Adaugă" pentru a adăuga diagnostice secundare</span>
            </div>
        }
        else
        {
            @foreach (var (diagnosis, index) in SecondaryDiagnoses.Select((d, i) => (d, i)))
            {
                <div class="diagnosis-entry @(_expandedIndex == index ? "expanded" : "") @(ShowValidation && !ValidateDiagnosis(diagnosis) ? "invalid" : "")">
                    <!-- Compact Row (always visible) -->
                    <div class="diagnosis-row" @onclick="() => ToggleExpand(index)">
                        <div class="row-number">#@(index + 1)</div>
                        
                        <div class="row-content">
                            @if (diagnosis.ICD10Codes.Any())
                            {
                                <div class="icd-codes-preview">
                                    @foreach (var icdCode in diagnosis.ICD10Codes.Take(3))
                                    {
                                        <span class="code-mini-badge">@icdCode.Code</span>
                                    }
                                    @if (diagnosis.ICD10Codes.Count > 3)
                                    {
                                        <span class="code-more">+@(diagnosis.ICD10Codes.Count - 3)</span>
                                    }
                                </div>
                            }
                            
                            <span class="row-description @(string.IsNullOrWhiteSpace(diagnosis.Description) ? "placeholder" : "")">
                                @(string.IsNullOrWhiteSpace(diagnosis.Description) ? "Click pentru a edita..." : TruncateText(diagnosis.Description, 60))
                            </span>
                        </div>
                        
                        <div class="row-actions">
                            <button type="button" class="btn-expand" title="@(_expandedIndex == index ? "Restrânge" : "Extinde")">
                                <i class="fas fa-chevron-@(_expandedIndex == index ? "up" : "down")"></i>
                            </button>
                            <button type="button" class="btn-delete" @onclick="() => RemoveSecondaryDiagnosis(index)" @onclick:stopPropagation title="Șterge">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Expandable Details Panel -->
                    @if (_expandedIndex == index)
                    {
                        <div class="diagnosis-details-panel">
                            <!-- ICD10 Search -->
                            <div class="detail-section">
                                <label class="detail-label">
                                    <i class="fas fa-tag"></i> Coduri ICD-10
                                    <span class="codes-count">(@diagnosis.ICD10Codes.Count/10)</span>
                                </label>
                                
                                @if (diagnosis.ICD10Codes.Count < 10)
                                {
                                    <div class="icd-search-compact">
                                        <ICD10SearchBox Placeholder="Caută și adaugă cod ICD-10..."
                                                        OnCodeSelected="(code) => AddICD10Code(diagnosis, code)"
                                                        CurrentUserId="@CurrentUserId"
                                                        MinSearchLength="2"
                                                        MaxResults="8" />
                                    </div>
                                }
                                
                                @if (diagnosis.ICD10Codes.Any())
                                {
                                    <div class="selected-codes-compact">
                                        @foreach (var icd10Code in diagnosis.ICD10Codes)
                                        {
                                            <div class="code-tag">
                                                <span class="tag-code">@icd10Code.Code</span>
                                                <span class="tag-name">@TruncateText(icd10Code.ShortDescription, 35)</span>
                                                <button type="button" class="btn-remove-tag" @onclick="() => RemoveICD10Code(diagnosis, icd10Code)" title="Elimină">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                            
                            <!-- Description -->
                            <div class="detail-section">
                                <label class="detail-label">
                                    <i class="fas fa-align-left"></i> Descriere
                                    @if (ShowValidation && string.IsNullOrWhiteSpace(diagnosis.Description))
                                    {
                                        <span class="required-indicator">* obligatoriu</span>
                                    }
                                </label>
                                <div class="rte-container">
                                    <SfRichTextEditor @bind-Value="diagnosis.Description"
                                                      Placeholder="Descrieți diagnosticul secundar..."
                                                      ShowCharCount="true"
                                                      EnableResize="true">
                                        <RichTextEditorToolbarSettings Items="@_rteTools" />
                                    </SfRichTextEditor>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        }
    </div>
    
    <!-- Bottom limit indicator -->
    @if (IsMaxReached)
    {
        <div class="limit-indicator">
            <i class="fas fa-check-circle"></i>
            <span>Ați atins limita maximă de 10 diagnostice secundare</span>
        </div>
    }
</div>
