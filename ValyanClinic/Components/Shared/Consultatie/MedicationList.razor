@*
    ComponentÄƒ pentru gestionarea listei de medicamente prescrise
    âœ… NEW: Medication management with ANM nomenclator autocomplete
*@

<div class="medication-section">
    <div class="section-subtitle">
        <i class="fas fa-pills"></i>
        <h5>Plan Terapeutic - Medicamente Prescrise</h5>
    </div>

    @* Tabel medicamente *@
    @if (Medications != null && Medications.Any())
    {
        <div class="medication-table-wrapper">
            <table class="medication-table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Medicament</th>
                        <th style="width: 15%;">Dozaj</th>
                        <th style="width: 15%;">FrecvenÈ›Äƒ</th>
                        <th style="width: 15%;">DuratÄƒ</th>
                        <th style="width: 15%;">Cantitate</th>
                        <th style="width: 10%;">AcÈ›iuni</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var medication in Medications)
                    {
                        @if (EditingMedicationId == medication.Id)
                        {
                            @* ROW IN EDIT MODE *@
                            <tr class="editing-row">
                                <td>
                                    <input type="text" 
                                           class="form-control form-control-sm"
                                           @bind="EditingMedication.Name" />
                                    <input type="text" 
                                           class="form-control form-control-sm mt-1"
                                           placeholder="ObservaÈ›ii..."
                                           @bind="EditingMedication.Notes" />
                                </td>
                                <td>
                                    <input type="text" 
                                           class="form-control form-control-sm"
                                           @bind="EditingMedication.Dose" />
                                </td>
                                <td>
                                    <input type="text" 
                                           class="form-control form-control-sm"
                                           @bind="EditingMedication.Frequency" />
                                </td>
                                <td>
                                    <input type="text" 
                                           class="form-control form-control-sm"
                                           @bind="EditingMedication.Duration" />
                                </td>
                                <td>
                                    <input type="text" 
                                           class="form-control form-control-sm"
                                           @bind="EditingMedication.Quantity" />
                                </td>
                                <td>
                                    <div class="btn-group-vertical btn-group-sm">
                                        <button type="button" 
                                                class="btn btn-sm btn-success mb-1"
                                                @onclick="SaveEdit"
                                                title="SalveazÄƒ modificÄƒrile">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button type="button" 
                                                class="btn btn-sm btn-secondary"
                                                @onclick="CancelEdit"
                                                title="AnuleazÄƒ">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                        else
                        {
                            @* ROW IN VIEW MODE *@
                            <tr>
                                <td>
                                    <strong>@medication.Name</strong>
                                    @if (!string.IsNullOrEmpty(medication.Notes))
                                    {
                                        <br />
                                        <small class="text-muted">@medication.Notes</small>
                                    }
                                </td>
                                <td>@medication.Dose</td>
                                <td>@medication.Frequency</td>
                                <td>@medication.Duration</td>
                                <td>@medication.Quantity</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" 
                                                class="btn btn-sm btn-warning"
                                                @onclick="() => StartEdit(medication)"
                                                title="EditeazÄƒ medicament">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" 
                                                class="btn btn-sm btn-danger"
                                                @onclick="() => RemoveMedication(medication.Id)"
                                                title="È˜terge medicament">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="no-medications-message">
            <i class="fas fa-info-circle"></i>
            <span>Nu au fost adÄƒugate medicamente. UtilizaÈ›i formularul de mai jos pentru a adÄƒuga.</span>
        </div>
    }

    @* Formular adÄƒugare medicament nou *@
    <div class="add-medication-form">
        <h6><i class="fas fa-plus-circle"></i> AdaugÄƒ Medicament</h6>
        
        <div class="form-row">
            @* Autocomplete medicament din nomenclator ANM *@
            <div class="form-group col-md-6">
                <label class="form-label required">
                    Denumire medicament
                </label>
                <input type="text" 
                       class="form-control @ValidationCss"
                       placeholder="CautÄƒ medicament din nomenclator ANM..."
                       value="@NewMedication.Name"
                       @oninput="OnMedicationSearchInput" />
                
                @* Dropdown autocomplete *@
                @if (ShowAutocomplete && MedicationSearchResults.Any())
                {
                    <div class="autocomplete-dropdown">
                        <div class="autocomplete-header">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> 
                                @MedicationSearchResults.Count rezultat(e) gÄƒsit(e)
                            </small>
                        </div>
                        @foreach (var result in MedicationSearchResults)
                        {
                            <div class="autocomplete-item" 
                                 @onclick="() => SelectMedication(result)">
                                <div class="medication-name">@result.DenumireComerciala</div>
                                @if (!string.IsNullOrEmpty(result.DCI))
                                {
                                    <div class="medication-dci">DCI: @result.DCI</div>
                                }
                                @if (!string.IsNullOrEmpty(result.FormaFarmaceutica))
                                {
                                    <div class="medication-form">@result.FormaFarmaceutica @result.Concentratie</div>
                                }
                                @if (!string.IsNullOrEmpty(result.Ambalaj))
                                {
                                    <div class="medication-packaging">ðŸ“¦ @result.Ambalaj</div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="form-group col-md-3">
                <label class="form-label">Dozaj</label>
                <input type="text" 
                       class="form-control"
                       placeholder="ex: 500mg"
                       @bind="NewMedication.Dose" />
            </div>

            <div class="form-group col-md-3">
                <label class="form-label">FrecvenÈ›Äƒ</label>
                <input type="text" 
                       class="form-control"
                       placeholder="ex: 1x3/zi"
                       @bind="NewMedication.Frequency" />
            </div>
        </div>

        <div class="form-row">
            <div class="form-group col-md-4">
                <label class="form-label">DuratÄƒ tratament</label>
                <input type="text" 
                       class="form-control"
                       placeholder="ex: 7 zile"
                       @bind="NewMedication.Duration" />
            </div>

            <div class="form-group col-md-4">
                <label class="form-label">Cantitate</label>
                <input type="text" 
                       class="form-control"
                       placeholder="ex: 1 cutie"
                       @bind="NewMedication.Quantity" />
            </div>

            <div class="form-group col-md-4">
                <label class="form-label">ObservaÈ›ii</label>
                <input type="text" 
                       class="form-control"
                       placeholder="DupÄƒ masÄƒ, cu apÄƒ..."
                       @bind="NewMedication.Notes" />
            </div>
        </div>

        <div class="form-actions">
            <button type="button" 
                    class="btn btn-primary"
                    @onclick="AddMedication"
                    disabled="@(!NewMedication.IsValid)">
                <i class="fas fa-plus"></i> AdaugÄƒ Medicament
            </button>
            <button type="button" 
                    class="btn btn-secondary"
                    @onclick="ClearForm">
                <i class="fas fa-times"></i> AnuleazÄƒ
            </button>
        </div>
    </div>
</div>
