@rendermode InteractiveServer
@using ValyanClinic.Application.Features.ICD10Management.DTOs
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Navigations

<!-- ICD-10 CARD cu DRAG & DROP -->
<div class="icd10-card">
    <div class="icd10-card-header">
        <h5 class="icd10-card-title">
            <i class="fas fa-diagnoses"></i>
            Coduri ICD-10 (Drag & Drop)
        </h5>
    </div>

    <div class="icd10-card-body">
        <div class="icd10-layout">
            <!-- ==================== STÂNGA: DROP ZONES ==================== -->
            <div class="icd10-drop-zones">
                
                <!-- PRINCIPAL DROP ZONE -->
                <div class="drop-zone-container">
                    <label class="drop-zone-label">
                        <i class="fas fa-star"></i>
                        Cod ICD-10 Principal
                    </label>
                    <div class="drop-zone drop-zone-primary @(IsPrincipalDragOver ? "drag-over" : "")"
                         ondragover="event.preventDefault();"
                         @ondrop="HandleDropPrincipal"
                         @ondragenter="() => IsPrincipalDragOver = true"
                         @ondragleave="() => IsPrincipalDragOver = false">
                        
                        @if (string.IsNullOrEmpty(CoduriICD10Principal))
                        {
                            <div class="drop-zone-placeholder">
                                <i class="fas fa-hand-pointer"></i>
                                <span>Trage codul principal aici</span>
                            </div>
                        }
                        else
                        {
                            <div class="icd10-chip icd10-chip-primary">
                                <i class="fas fa-star"></i>
                                <strong>@CoduriICD10Principal</strong>
                                <button type="button" 
                                        class="icd10-chip-remove" 
                                        @onclick="RemovePrincipal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        }
                    </div>
                </div>

                <!-- SECUNDARE DROP ZONE -->
                <div class="drop-zone-container">
                    <label class="drop-zone-label">
                        <i class="fas fa-plus-circle"></i>
                        Coduri ICD-10 Secundare
                    </label>
                    <div class="drop-zone drop-zone-secondary @(IsSecundareDragOver ? "drag-over" : "")"
                         ondragover="event.preventDefault();"
                         @ondrop="HandleDropSecundare"
                         @ondragenter="() => IsSecundareDragOver = true"
                         @ondragleave="() => IsSecundareDragOver = false">
                        
                        @if (string.IsNullOrEmpty(CoduriICD10Secundare))
                        {
                            <div class="drop-zone-placeholder">
                                <i class="fas fa-hand-pointer"></i>
                                <span>Trage codurile secundare aici (multiple)</span>
                            </div>
                        }
                        else
                        {
                            <div class="icd10-chips-container">
                                @foreach (var code in CoduriICD10Secundare.Split(',', StringSplitOptions.RemoveEmptyEntries))
                                {
                                    var trimmedCode = code.Trim();
                                    <div class="icd10-chip icd10-chip-secondary">
                                        <i class="fas fa-plus"></i>
                                        <strong>@trimmedCode</strong>
                                        <button type="button" 
                                                class="icd10-chip-remove" 
                                                @onclick="() => RemoveSecundar(trimmedCode)">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- ==================== DREAPTA: SYNCFUSION DATAGRID-URI ==================== -->
            <div class="icd10-grids">
                <SfTab CssClass="icd10-tabs">
                    <TabItems>
                        <!-- TAB 1: FAVORITE -->
                        <TabItem>
                            <ChildContent>
                                <TabHeader Text="? Favorite"></TabHeader>
                            </ChildContent>
                            <ContentTemplate>
                                <div class="grid-container">
                                    @if (FavoriteCodes != null && FavoriteCodes.Any())
                                    {
                                        <SfGrid @ref="FavoriteGridRef"
                                                DataSource="@FavoriteCodes"
                                                TValue="ICD10SearchResultDto"
                                                Height="100%"
                                                RowHeight="32"
                                                AllowPaging="true"
                                                AllowSorting="true"
                                                AllowFiltering="true"
                                                AllowGrouping="true"
                                                AllowReordering="true"
                                                AllowResizing="true"
                                                AllowTextWrap="false"
                                                ShowColumnChooser="true"
                                                Toolbar="@(new List<string>() { "Search", "ColumnChooser" })"
                                                GridLines="GridLine.Both">
                                            
                                            <GridEvents TValue="ICD10SearchResultDto" OnActionBegin="FavoriteActionBegin"></GridEvents>
                                            
                                            <GridPageSettings PageSize="10" PageSizes="@(new int[] { 5, 10, 15, 20, 25, 50 })"></GridPageSettings>
                                            
                                            <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel"></GridFilterSettings>
                                            
                                            <GridSearchSettings Fields="@(new string[] { "Code", "ShortDescription", "Category" })" 
                                                               Operator="Syncfusion.Blazor.Operator.Contains" 
                                                               IgnoreCase="true"
                                                               Key=""
                                                               IgnoreAccent="true"></GridSearchSettings>
                                            
                                            <GridGroupSettings ShowDropArea="true" 
                                                             ShowGroupedColumn="true"
                                                             ShowUngroupButton="true"
                                                             Columns="@(new string[] { })">
                                                <CaptionTemplate>
                                                    @{
                                                        var group = (context as CaptionTemplateContext);
                                                        <div><strong>@group.Key</strong> - @group.Count item(s)</div>
                                                    }
                                                </CaptionTemplate>
                                            </GridGroupSettings>
                                            
                                            <GridAggregates>
                                                <GridAggregate>
                                                    <GridAggregateColumns>
                                                        <GridAggregateColumn Field="@nameof(ICD10SearchResultDto.Code)" Type="AggregateType.Count">
                                                            <GroupFooterTemplate>
                                                                @{
                                                                    var aggregate = (context as AggregateTemplateContext);
                                                                    <div>Total în grup: <b>@aggregate?.Count</b></div>
                                                                }
                                                            </GroupFooterTemplate>
                                                            <FooterTemplate>
                                                                @{
                                                                    var aggregate = (context as AggregateTemplateContext);
                                                                    <div><strong>Total: @aggregate?.Count coduri</strong></div>
                                                                }
                                                            </FooterTemplate>
                                                        </GridAggregateColumn>
                                                    </GridAggregateColumns>
                                                </GridAggregate>
                                            </GridAggregates>
                                            
                                            <GridColumns>
                                                <GridColumn HeaderText="Drag" 
                                                           Width="80" 
                                                           TextAlign="TextAlign.Center"
                                                           AllowSorting="false"
                                                           AllowFiltering="false"
                                                           AllowGrouping="false"
                                                           AllowReordering="false"
                                                           AllowResizing="false">
                                                    <Template>
                                                        @{
                                                            var item = (context as ICD10SearchResultDto);
                                                            <button type="button" 
                                                                    class="btn-drag"
                                                                    draggable="true"
                                                                    @ondragstart="() => HandleDragStart(item)"
                                                                    title="Drag pentru a adauga">
                                                                <i class="fas fa-grip-vertical"></i>
                                                            </button>
                                                        }
                                                    </Template>
                                                </GridColumn>
                                                
                                                <GridColumn Field="@nameof(ICD10SearchResultDto.Code)" 
                                                           HeaderText="Cod ICD-10" 
                                                           Width="120" 
                                                           TextAlign="TextAlign.Left"
                                                           AllowGrouping="false"></GridColumn>
                                                
                                                <GridColumn Field="@nameof(ICD10SearchResultDto.ShortDescription)" 
                                                           HeaderText="Descriere" 
                                                           Width="280"
                                                           AllowGrouping="false"></GridColumn>
                                                
                                                <GridColumn Field="@nameof(ICD10SearchResultDto.Category)" 
                                                           HeaderText="Categorie" 
                                                           Width="140"
                                                           AllowGrouping="true"></GridColumn>
                                                
                                                <GridColumn Field="@nameof(ICD10SearchResultDto.Severity)" 
                                                           HeaderText="Severitate" 
                                                           Width="120"
                                                           AllowGrouping="true">
                                                    <Template>
                                                        @{
                                                            var item = (context as ICD10SearchResultDto);
                                                            if (!string.IsNullOrEmpty(item?.Severity))
                                                            {
                                                                <span class="severity-badge severity-@item.Severity.ToLower()">
                                                                    @GetSeverityText(item.Severity)
                                                                </span>
                                                            }
                                                        }
                                                    </Template>
                                                </GridColumn>
                                            </GridColumns>
                                        </SfGrid>
                                    }
                                    else
                                    {
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i>
                                            Se încarca codurile favorite...
                                        </div>
                                    }
                                </div>
                            </ContentTemplate>
                        </TabItem>

                        <!-- TAB 2: TOATE CODURILE -->
                        <TabItem>
                            <ChildContent>
                                <TabHeader Text="?? Toate Codurile"></TabHeader>
                            </ChildContent>
                            <ContentTemplate>
                                <div class="grid-container">
                                    @if (AllCodes != null && AllCodes.Any())
                                    {
                                        <SfGrid @ref="AllCodesGridRef"
                                                DataSource="@AllCodes"
                                                TValue="ICD10SearchResultDto"
                                                Height="100%"
                                                RowHeight="32"
                                                AllowPaging="true"
                                                AllowSorting="true"
                                                AllowFiltering="true"
                                                AllowGrouping="true"
                                                AllowReordering="true"
                                                AllowResizing="true"
                                                AllowTextWrap="false"
                                                ShowColumnChooser="true"
                                                Toolbar="@(new List<string>() { "Search", "ColumnChooser", "ExcelExport" })"
                                                GridLines="GridLine.Both">
                                            
                                            <GridEvents TValue="ICD10SearchResultDto" OnActionBegin="AllCodesActionBegin"></GridEvents>
                                            
                                            <GridPageSettings PageSize="10" PageSizes="@(new int[] { 5, 10, 15, 20, 25, 50, 100 })"></GridPageSettings>
                                            
                                            <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel"></GridFilterSettings>
                                            
                                            <GridSearchSettings Fields="@(new string[] { "Code", "ShortDescription", "LongDescription", "Category" })" 
                                                               Operator="Syncfusion.Blazor.Operator.Contains" 
                                                               IgnoreCase="true"
                                                               Key=""
                                                               IgnoreAccent="true"></GridSearchSettings>
                                            
                                            <GridGroupSettings ShowDropArea="true" 
                                                             ShowGroupedColumn="true"
                                                             ShowUngroupButton="true"
                                                             Columns="@(new string[] { })">
                                                <CaptionTemplate>
                                                    @{
                                                        var group = (context as CaptionTemplateContext);
                                                        <div><strong>@group.Key</strong> - @group.Count item(s)</div>
                                                    }
                                                </CaptionTemplate>
                                            </GridGroupSettings>
                                            
                                            <GridAggregates>
                                                <GridAggregate>
                                                    <GridAggregateColumns>
                                                        <GridAggregateColumn Field="@nameof(ICD10SearchResultDto.Code)" Type="AggregateType.Count">
                                                            <GroupFooterTemplate>
                                                                @{
                                                                    var aggregate = (context as AggregateTemplateContext);
                                                                    <div>Total în grup: <b>@aggregate?.Count</b></div>
                                                                }
                                                            </GroupFooterTemplate>
                                                            <FooterTemplate>
                                                                @{
                                                                    var aggregate = (context as AggregateTemplateContext);
                                                                    <div><strong>Total: @aggregate?.Count coduri ICD-10</strong></div>
                                                                }
                                                            </FooterTemplate>
                                                        </GridAggregateColumn>
                                                    </GridAggregateColumns>
                                                </GridAggregate>
                                            </GridAggregates>
                                            
                                            <GridColumns>
                                                <GridColumn HeaderText="Drag" 
                                                           Width="80" 
                                                           TextAlign="TextAlign.Center"
                                                           AllowSorting="false"
                                                           AllowFiltering="false"
                                                           AllowGrouping="false"
                                                           AllowReordering="false"
                                                           AllowResizing="false">
                                                    <Template>
                                                        @{
                                                            var item = (context as ICD10SearchResultDto);
                                                            <button type="button" 
                                                                    class="btn-drag"
                                                                    draggable="true"
                                                                    @ondragstart="() => HandleDragStart(item)"
                                                                    title="Drag pentru a adauga">
                                                                <i class="fas fa-grip-vertical"></i>
                                                            </button>
                                                        }
                                                    </Template>
                                                </GridColumn>
                                                
                                                <GridColumn Field="@nameof(ICD10SearchResultDto.Code)" 
                                                           HeaderText="Cod ICD-10" 
                                                           Width="120" 
                                                           TextAlign="TextAlign.Left"
                                                           IsPrimaryKey="true"
                                                           AllowGrouping="false"></GridColumn>
                                                
                                                <GridColumn Field="@nameof(ICD10SearchResultDto.ShortDescription)" 
                                                           HeaderText="Descriere Scurta" 
                                                           Width="250"
                                                           ClipMode="ClipMode.EllipsisWithTooltip"
                                                           AllowGrouping="false"></GridColumn>
                                                
                                                <GridColumn Field="@nameof(ICD10SearchResultDto.LongDescription)" 
                                                           HeaderText="Descriere Completa" 
                                                           Width="300"
                                                           ClipMode="ClipMode.EllipsisWithTooltip"
                                                           AllowGrouping="false"
                                                           Visible="false"></GridColumn>
                                                
                                                <GridColumn Field="@nameof(ICD10SearchResultDto.Category)" 
                                                           HeaderText="Categorie" 
                                                           Width="140"
                                                           AllowGrouping="true"></GridColumn>
                                                
                                                <GridColumn Field="@nameof(ICD10SearchResultDto.Severity)" 
                                                           HeaderText="Severitate" 
                                                           Width="120"
                                                           AllowGrouping="true">
                                                    <Template>
                                                        @{
                                                            var item = (context as ICD10SearchResultDto);
                                                            if (!string.IsNullOrEmpty(item?.Severity))
                                                            {
                                                                <span class="severity-badge severity-@item.Severity.ToLower()">
                                                                    @GetSeverityText(item.Severity)
                                                                </span>
                                                            }
                                                        }
                                                    </Template>
                                                </GridColumn>
                                                
                                                <GridColumn Field="@nameof(ICD10SearchResultDto.IsCommon)" 
                                                           HeaderText="Frecvent" 
                                                           Width="100"
                                                           DisplayAsCheckBox="true"
                                                           TextAlign="TextAlign.Center"
                                                           AllowGrouping="true"></GridColumn>
                                            </GridColumns>
                                        </SfGrid>
                                    }
                                    else
                                    {
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i>
                                            Se încarca toate codurile...
                                        </div>
                                    }
                                </div>
                            </ContentTemplate>
                        </TabItem>
                    </TabItems>
                </SfTab>
            </div>
        </div>
    </div>
</div>

@code {
    // Helper method for severity badge class
    private string GetSeverityClass(string? severity)
    {
        return severity switch
        {
            "Mild" => "success",
            "Moderate" => "warning",
            "Severe" => "danger",
            "Critical" => "dark",
            _ => "secondary"
        };
    }
}
