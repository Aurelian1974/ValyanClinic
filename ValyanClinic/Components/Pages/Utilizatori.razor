@page "/parinte5/copil1"
@page "/utilizatori"
@using ValyanClinic.Components.Pages.Models
@using ValyanClinic.Application.Services
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Notifications
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Popups
@using GridSelectionType = Syncfusion.Blazor.Grids.SelectionType
@using GridSelectionMode = Syncfusion.Blazor.Grids.SelectionMode
@using GridSortDirection = Syncfusion.Blazor.Grids.SortDirection
@using GridFilterType = Syncfusion.Blazor.Grids.FilterType
@inject IUserService UserService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Gestionare Utilizatori - ValyanMed</PageTitle>

<div class="users-page-container">
    <!-- Page Header -->
    <div class="users-page-header">
        <div class="header-content">
            <div class="header-text">
                <h1 class="users-page-title">
                    <i class="fas fa-users"></i>
                    Gestionare Utilizatori
                </h1>
                <p class="users-page-subtitle">
                    Administrează utilizatorii sistemului ValyanMed - adaugă, editează și gestionează permisiunile
                </p>
            </div>
            
            <div class="users-header-actions">
                <button class="btn btn-outline-primary" @onclick="ShowAddUserModal">
                    <i class="fas fa-plus"></i>
                    <span class="btn-text">Adauga Utilizator</span>
                </button>
                <button class="btn btn-outline-secondary" @onclick="RefreshData">
                    <i class="fas fa-sync-alt"></i>
                    <span class="btn-text">Actualizeaza</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Cards - COMPACTED -->
    <div class="users-stats-grid">
        @foreach (var stat in UserStatistics)
        {
            <div class="users-stat-card">
                <div class="users-stat-number">@stat.Value</div>
                <div class="users-stat-label">@stat.Label</div>
            </div>
        }
    </div>

    <!-- Toast Notification -->
    <SfToast @ref="ToastRef" Title="ValyanMed" Target="body" NewestOnTop="true" ShowProgressBar="true"></SfToast>

    <!-- Advanced Filter Panel -->
    <div class="users-advanced-filter-panel">
        <div class="filter-panel-header">
            <h3>
                <i class="fas fa-filter"></i>
                Filtrare Avansată
            </h3>
            <button class="btn btn-secondary btn-sm" @onclick="ToggleFilterPanel">
                <i class="fas @(showAdvancedFilters ? "fa-chevron-up" : "fa-chevron-down")"></i>
                <span>@(showAdvancedFilters ? "Ascunde Filtrele" : "Arată Filtrele")</span>
            </button>
        </div>
        
        @if (showAdvancedFilters)
        {
            <div class="filter-panel-content">
                <!-- First row - Rol, Status, Departament -->
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Rol:</label>
                        <SfDropDownList TItem="FilterOption<UserRole?>" TValue="UserRole?" 
                                       DataSource="@RoleFilterOptions" 
                                       @bind-Value="@SelectedRoleFilter"
                                       Placeholder="Toate rolurile"
                                       AllowFiltering="true"
                                       PopupHeight="200px"
                                       Width="150px">
                            <DropDownListFieldSettings Text="Text" Value="Value" />
                            <DropDownListEvents TItem="FilterOption<UserRole?>" TValue="UserRole?" ValueChange="OnRoleFilterChanged" />
                        </SfDropDownList>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Status:</label>
                        <SfDropDownList TItem="FilterOption<UserStatus?>" TValue="UserStatus?" 
                                       DataSource="@StatusFilterOptions" 
                                       @bind-Value="@SelectedStatusFilter"
                                       Placeholder="Toate statusurile"
                                       AllowFiltering="true"
                                       PopupHeight="200px"
                                       Width="150px">
                            <DropDownListFieldSettings Text="Text" Value="Value" />
                            <DropDownListEvents TItem="FilterOption<UserStatus?>" TValue="UserStatus?" ValueChange="OnStatusFilterChanged" />
                        </SfDropDownList>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Departament:</label>
                        <SfDropDownList TItem="string" TValue="string" 
                                       DataSource="@DepartmentFilterOptions" 
                                       @bind-Value="@SelectedDepartmentFilter"
                                       Placeholder="Toate departamentele"
                                       AllowFiltering="true"
                                       PopupHeight="200px"
                                       Width="180px">
                            <DropDownListEvents TItem="string" TValue="string" ValueChange="OnDepartmentFilterChanged" />
                        </SfDropDownList>
                    </div>
                </div>
                
                <!-- Second row - Căutare text, Perioada activitate -->
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Cautare text:</label>
                        <SfTextBox @bind-Value="@GlobalSearchText" 
                                  Placeholder="Cauta in nume, email, username..."
                                  Width="250px"
                                  ShowClearButton="true">
                            <TextBoxEvents ValueChange="OnGlobalSearchChanged" />
                        </SfTextBox>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Perioada activitate:</label>
                        <SfDropDownList TItem="string" TValue="string" 
                                       DataSource="@ActivityPeriodOptions" 
                                       @bind-Value="@SelectedActivityPeriod"
                                       Placeholder="Orice perioada"
                                       Width="180px">
                            <DropDownListEvents TItem="string" TValue="string" ValueChange="OnActivityPeriodChanged" />
                        </SfDropDownList>
                    </div>
                    
                    <!-- Empty space to maintain layout balance -->
                    <div class="filter-group"></div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn btn-primary btn-sm" @onclick="ApplyAdvancedFilters">
                        <i class="fas fa-check"></i>
                        <span>Aplica Filtrele</span>
                    </button>
                    <button class="btn btn-secondary btn-sm" @onclick="ClearAdvancedFilters">
                        <i class="fas fa-times"></i>
                        <span>Curata Filtrele</span>
                    </button>
                    <button class="btn btn-info btn-sm" @onclick="ExportFilteredData">
                        <i class="fas fa-download"></i>
                        <span>Exporta Rezultate</span>
                    </button>
                </div>
                
                <!-- Filter Results Summary -->
                <div class="filter-results-summary">
                    <div class="results-info">
                        <span class="results-count">
                            <i class="fas fa-search"></i>
                            Rezultate: <strong>@FilteredUsers.Count</strong> din <strong>@Users.Count</strong> utilizatori
                        </span>
                        @if (FilteredUsers.Count != Users.Count)
                        {
                            <span class="filtered-indicator">
                                <i class="fas fa-filter"></i>
                                Filtrare activa
                            </span>
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Main DataGrid -->
    <div class="users-grid-container">
        <SfGrid @ref="GridRef" DataSource="@FilteredUsers" 
                AllowPaging="true" 
                AllowSorting="true" 
                AllowFiltering="true"
                AllowGrouping="true"
                AllowSelection="true"
                AllowReordering="true"
                AllowResizing="true"
                Height="600"
                ShowColumnMenu="true">
            
            <!-- Grid Events -->
            <GridEvents TValue="User" 
                       RowSelected="RowSelected"
                       RowDeselected="RowDeselected">
            </GridEvents>

            <!-- Selection Settings -->
            <GridSelectionSettings Type="GridSelectionType.Multiple" Mode="GridSelectionMode.Row"></GridSelectionSettings>

            <!-- Page Settings -->
            <GridPageSettings PageSize="20" PageSizes="@PageSizes"></GridPageSettings>

            <!-- Sort Settings -->
            <GridSortSettings AllowUnsort="true">
                <GridSortColumns>
                    <GridSortColumn Field="LastName" Direction="GridSortDirection.Ascending"></GridSortColumn>
                </GridSortColumns>
            </GridSortSettings>

            <!-- Filter Settings -->
            <GridFilterSettings Type="GridFilterType.Excel" 
                              Mode="FilterBarMode.Immediate"
                              ShowFilterBarStatus="true"
                              ImmediateModeDelay="500">
            </GridFilterSettings>

            <!-- Group Settings -->
            <GridGroupSettings ShowDropArea="true" ShowToggleButton="true" ShowGroupedColumn="true">
                <GridGroupColumns>
                    <GridGroupColumn Field="Department"></GridGroupColumn>
                </GridGroupColumns>
            </GridGroupSettings>

            <!-- Columns Definition -->
            <GridColumns>
                <GridColumn Field="@nameof(User.Id)" HeaderText="ID" Width="80" TextAlign="TextAlign.Center" 
                           IsPrimaryKey="true" AllowFiltering="true" AllowReordering="false"></GridColumn>
                <GridColumn Field="@nameof(User.FirstName)" HeaderText="Nume" Width="150" AllowFiltering="true" AllowReordering="true"></GridColumn>
                <GridColumn Field="@nameof(User.LastName)" HeaderText="Prenume" Width="150" AllowFiltering="true" AllowReordering="true"></GridColumn>
                <GridColumn Field="@nameof(User.Email)" HeaderText="Email" Width="200" AllowFiltering="true" AllowReordering="true"></GridColumn>
                <GridColumn Field="@nameof(User.Username)" HeaderText="Username" Width="120" AllowFiltering="true" AllowReordering="true"></GridColumn>
                <GridColumn Field="@nameof(User.Phone)" HeaderText="Telefon" Width="120" AllowFiltering="true" AllowReordering="true"></GridColumn>
                           
                <GridColumn Field="@nameof(User.Role)" HeaderText="Rol" Width="120" AllowFiltering="true" AllowReordering="true">
                    <Template>
                        @{                                               
                            var user = context as User;
                            <span>@GetRoleDisplayName(user!.Role)</span>
                        }
                    </Template>
                </GridColumn>
                           
                <GridColumn Field="@nameof(User.Department)" HeaderText="Departament" Width="140" 
                           AllowFiltering="true" AllowReordering="true"></GridColumn>
                           
                <GridColumn Field="@nameof(User.Status)" HeaderText="Status" Width="100" 
                           AllowFiltering="true" AllowReordering="true">
                    <Template>
                        @{                                               
                            var user = context as User;
                            <span class="status-badge status-@user!.Status.ToString().ToLower()">
                                @GetStatusDisplayName(user.Status)
                            </span>
                        }
                    </Template>
                </GridColumn>
                           
                <GridColumn Field="@nameof(User.JobTitle)" HeaderText="Functie" Width="140" AllowFiltering="true" AllowReordering="true"></GridColumn>
                <GridColumn Field="@nameof(User.CreatedDate)" HeaderText="Data Crearii" Width="120" 
                           Format="dd.MM.yyyy" Type="ColumnType.Date" AllowFiltering="true" AllowReordering="true"></GridColumn>
                <GridColumn Field="@nameof(User.LastLoginDate)" HeaderText="Ultima Autentificare" Width="140" 
                           Format="dd.MM.yyyy HH:mm" Type="ColumnType.DateTime" AllowFiltering="true" AllowReordering="true"></GridColumn>
                           
                <!-- Actions Column - FROZEN RIGHT -->
                <GridColumn HeaderText="Actiuni" Width="120" AllowFiltering="false" AllowSorting="false"
                           IsFrozen="true" AllowReordering="false" TextAlign="TextAlign.Center">
                    <Template>
                        @{
                            var user = context as User;
                            <div class="action-buttons">
                                <button class="btn-action btn-view" @onclick="() => ShowUserDetailModal(user!)" 
                                        title="Vizualizeaza detaliile utilizatorului" aria-label="Vizualizeaza">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-action btn-edit" @onclick="() => EditUser(user!)" 
                                        title="Modifica utilizatorul" aria-label="Modifica">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-action btn-delete" @onclick="() => DeleteUser(user!)" 
                                        title="Sterge utilizatorul" aria-label="Sterge">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        }
                    </Template>
                </GridColumn>
            </GridColumns>
        </SfGrid>
    </div>

    <!-- User Detail Modal -->
    <SfDialog @ref="UserDetailModal" 
              Width="900px" 
              Height="600px"
              IsModal="true" 
              Visible="@IsModalVisible"
              ShowCloseIcon="true"
              AllowDragging="true"
              CssClass="user-dialog detail-dialog"
              AnimationSettings="@DialogAnimation">
        <DialogEvents Closed="OnModalClosed" />
        <DialogTemplates>
            <Header>
                <div class="modal-header-content">
                    <i class="fas fa-user-circle modal-header-icon"></i>
                    <div>
                        <h3 class="modal-header-title">@SelectedUser?.FullName</h3>
                        <p class="modal-header-subtitle">@SelectedUser?.JobTitle - @(SelectedUser != null ? GetRoleDisplayName(SelectedUser.Role) : "")</p>
                    </div>
                </div>
            </Header>
            <Content>
                @if (SelectedUser != null)
                {
                    <div class="user-detail-modal-container">
                        <div class="detail-content-modal">
                            <div class="detail-section-modal">
                                <h4><i class="fas fa-id-card"></i> Informatii Personale</h4>
                                <div class="detail-grid-modal">
                                    <div class="detail-item-modal">
                                        <label>ID Utilizator:</label>
                                        <span>@SelectedUser.Id</span>
                                    </div>
                                    <div class="detail-item-modal">
                                        <label>Email:</label>
                                        <span>@SelectedUser.Email</span>
                                    </div>
                                    <div class="detail-item-modal">
                                        <label>Username:</label>
                                        <span>@SelectedUser.Username</span>
                                    </div>
                                    <div class="detail-item-modal">
                                        <label>Telefon:</label>
                                        <span>@(SelectedUser.Phone ?? "Nu este specificat")</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="detail-section-modal">
                                <h4><i class="fas fa-building"></i> Informatii Organizationale</h4>
                                <div class="detail-grid-modal">
                                    <div class="detail-item-modal">
                                        <label>Departament:</label>
                                        <span>@(SelectedUser.Department ?? "Nu este specificat")</span>
                                    </div>
                                    <div class="detail-item-modal">
                                        <label>Functia:</label>
                                        <span>@(SelectedUser.JobTitle ?? "Nu este specificata")</span>
                                    </div>
                                    <div class="detail-item-modal">
                                        <label>Rol in sistem:</label>
                                        <span class="role-badge role-@SelectedUser.Role.ToString().ToLower()">
                                            @GetRoleDisplayName(SelectedUser.Role)
                                        </span>
                                    </div>
                                    <div class="detail-item-modal">
                                        <label>Status:</label>
                                        <span class="status-badge status-@SelectedUser.Status.ToString().ToLower()">
                                            @GetStatusDisplayName(SelectedUser.Status)
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="detail-section-modal">
                                <h4><i class="fas fa-calendar-alt"></i> Informatii Temporale</h4>
                                <div class="detail-grid-modal">
                                    <div class="detail-item-modal">
                                        <label>Data crearii:</label>
                                        <span>@SelectedUser.CreatedDate.ToString("dd.MM.yyyy HH:mm")</span>
                                    </div>
                                    <div class="detail-item-modal">
                                        <label>Ultima autentificare:</label>
                                        <span>@(SelectedUser.LastLoginDate?.ToString("dd.MM.yyyy HH:mm") ?? "Niciodata")</span>
                                    </div>
                                    <div class="detail-item-modal">
                                        <label>Activitate recenta:</label>
                                        <span>@GetActivityStatus(SelectedUser.LastLoginDate)</span>
                                    </div>
                                    <div class="detail-item-modal">
                                        <label>Vechime in sistem:</label>
                                        <span>@GetSystemAge(SelectedUser.CreatedDate)</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="detail-section-modal">
                                <h4><i class="fas fa-shield-alt"></i> Permisiuni si Securitate</h4>
                                <div class="detail-permissions-modal">
                                    <div class="permission-item-modal">
                                        <i class="fas fa-check-circle text-success"></i>
                                        <span>Acces la modulul utilizatori</span>
                                    </div>
                                    <div class="permission-item-modal">
                                        <i class="fas fa-check-circle text-success"></i>
                                        <span>Acces la rapoarte</span>
                                    </div>
                                    @if (SelectedUser.Role == UserRole.Administrator)
                                    {
                                        <div class="permission-item-modal">
                                            <i class="fas fa-check-circle text-success"></i>
                                            <span>Acces la administrare sistem</span>
                                        </div>
                                        <div class="permission-item-modal">
                                            <i class="fas fa-check-circle text-success"></i>
                                            <span>Gestionare utilizatori</span>
                                        </div>
                                    }
                                    @if (SelectedUser.Role == UserRole.Doctor)
                                    {
                                        <div class="permission-item-modal">
                                            <i class="fas fa-check-circle text-success"></i>
                                            <span>Acces la fise medicale</span>
                                        </div>
                                        <div class="permission-item-modal">
                                            <i class="fas fa-check-circle text-success"></i>
                                            <span>Prescriere medicamente</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </Content>
            <FooterTemplate>
                <div class="modal-footer-actions">
                    <button class="btn btn-primary" @onclick="() => EditUserFromModal()">
                        <i class="fas fa-edit"></i> Editeaza Utilizatorul
                    </button>
                    <button class="btn btn-secondary" @onclick="CloseUserDetailModal">
                        <i class="fas fa-times"></i> Inchide
                    </button>
                </div>
            </FooterTemplate>
        </DialogTemplates>
    </SfDialog>

    <!-- Add/Edit User Modal -->
    <SfDialog @ref="AddEditUserModal" 
              Width="800px" 
              Height="650px"
              IsModal="true" 
              Visible="@IsAddEditModalVisible"
              ShowCloseIcon="true"
              AllowDragging="true"
              CssClass="user-dialog edit-dialog"
              AnimationSettings="@DialogAnimation">
        <DialogEvents Closed="OnAddEditModalClosed" />
        <DialogTemplates>
            <Header>
                <div class="modal-header-content">
                    <i class="fas fa-user-plus modal-header-icon"></i>
                    <div>
                        <h3 class="modal-header-title">@(IsEditMode ? $"Editeaza Utilizatorul - {EditingUser?.FullName}" : "Adauga Utilizator Nou")</h3>
                        <p class="modal-header-subtitle">@(IsEditMode ? "Modifica informatiile utilizatorului existent" : "Completeaza informatiile pentru noul utilizator")</p>
                    </div>
                </div>
            </Header>
            <Content>
                <div class="add-edit-user-container">
                    <EditForm Model="@EditingUser" OnValidSubmit="SaveUser" Id="addEditForm">
                        <DataAnnotationsValidator />
                        
                        <div class="form-sections">
                            <!-- Personal Information Section -->
                            <div class="form-section">
                                <h4><i class="fas fa-id-card"></i> Informatii Personale</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="firstName">Nume <span class="required">*</span></label>
                                        <SfTextBox @bind-Value="EditingUser.FirstName" 
                                                  Placeholder="Introduceti numele"
                                                  FloatLabelType="FloatLabelType.Never">
                                        </SfTextBox>
                                        <ValidationMessage For="@(() => EditingUser.FirstName)" class="validation-error" />
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="lastName">Prenume <span class="required">*</span></label>
                                        <SfTextBox @bind-Value="EditingUser.LastName" 
                                                  Placeholder="Introduceti prenumele"
                                                  FloatLabelType="FloatLabelType.Never">
                                        </SfTextBox>
                                        <ValidationMessage For="@(() => EditingUser.LastName)" class="validation-error" />
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="email">Email <span class="required">*</span></label>
                                        <SfTextBox @bind-Value="EditingUser.Email" 
                                                  Placeholder="utilizator@valyanmed.ro"
                                                  FloatLabelType="FloatLabelType.Never">
                                        </SfTextBox>
                                        <ValidationMessage For="@(() => EditingUser.Email)" class="validation-error" />
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="phone">Telefon</label>
                                        <SfTextBox @bind-Value="EditingUser.Phone" 
                                                  Placeholder="0723456789"
                                                  FloatLabelType="FloatLabelType.Never">
                                        </SfTextBox>
                                        <ValidationMessage For="@(() => EditingUser.Phone)" class="validation-error" />
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Account Information Section -->
                            <div class="form-section">
                                <h4><i class="fas fa-user-cog"></i> Informatii Cont</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="username">Username <span class="required">*</span></label>
                                        <SfTextBox @bind-Value="EditingUser.Username" 
                                                  Placeholder="username_utilizator"
                                                  FloatLabelType="FloatLabelType.Never">
                                        </SfTextBox>
                                        <ValidationMessage For="@(() => EditingUser.Username)" class="validation-error" />
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="role">Rol in Sistem <span class="required">*</span></label>
                                        <SfDropDownList TItem="UserRole" TValue="UserRole" 
                                                       @bind-Value="EditingUser.Role"
                                                       DataSource="@AllRoles"
                                                       Placeholder="Selecteaza rolul"
                                                       FloatLabelType="FloatLabelType.Never">
                                            <DropDownListTemplates TItem="UserRole">
                                                <ItemTemplate Context="roleContext">
                                                    @GetRoleDisplayName(roleContext)
                                                </ItemTemplate>
                                            </DropDownListTemplates>
                                        </SfDropDownList>
                                        <ValidationMessage For="@(() => EditingUser.Role)" class="validation-error" />
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="status">Status</label>
                                        <SfDropDownList TItem="UserStatus" TValue="UserStatus" 
                                                       @bind-Value="EditingUser.Status"
                                                       DataSource="@AllStatuses"
                                                       Placeholder="Selecteaza statusul"
                                                       FloatLabelType="FloatLabelType.Never">
                                            <DropDownListTemplates TItem="UserStatus">
                                                <ItemTemplate Context="statusContext">
                                                    @GetStatusDisplayName(statusContext)
                                                </ItemTemplate>
                                            </DropDownListTemplates>
                                        </SfDropDownList>
                                    </div>
                                    <div class="form-group">
                                        <!-- Empty div to maintain grid layout -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Organizational Information Section -->
                            <div class="form-section">
                                <h4><i class="fas fa-building"></i> Informatii Organizationale</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="department">Departament</label>
                                        <SfDropDownList TItem="string" TValue="string" 
                                                       @bind-Value="EditingUser.Department"
                                                       DataSource="@DepartmentOptions"
                                                       Placeholder="Selecteaza departamentul"
                                                       AllowFiltering="true"
                                                       FloatLabelType="FloatLabelType.Never">
                                        </SfDropDownList>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="jobTitle">Functia</label>
                                        <SfTextBox @bind-Value="EditingUser.JobTitle" 
                                                  Placeholder="ex: Medic Specialist, Asistent Medical"
                                                  FloatLabelType="FloatLabelType.Never">
                                        </SfTextBox>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </EditForm>
                </div>
            </Content>
            <FooterTemplate>
                <div class="modal-footer-actions">
                    <button type="submit" form="addEditForm" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        @(IsEditMode ? "Actualizeaza Utilizatorul" : "Creaza Utilizatorul")
                    </button>
                    <button type="button" class="btn btn-secondary" @onclick="CloseAddEditModal">
                        <i class="fas fa-times"></i>
                        Anuleaza
                    </button>
                </div>
            </FooterTemplate>
        </DialogTemplates>
    </SfDialog>
</div>

@code {
    private List<User> Users = new();
    private List<User> FilteredUsers = new();
    private SfGrid<User>? GridRef;
    private SfToast? ToastRef;

    // Modal references and state
    private SfDialog? UserDetailModal;
    private SfDialog? AddEditUserModal;
    private User? SelectedUser = null;
    private bool IsModalVisible = false;
    
    // Add/Edit Modal Properties
    private User EditingUser = new();
    private bool IsAddEditModalVisible = false;
    private bool IsEditMode = false;
    
    private string[] PageSizes = { "10", "20", "50", "100", "All" };

    // Dialog Animation Settings
    private DialogAnimationSettings DialogAnimation = new DialogAnimationSettings 
    { 
        Effect = DialogEffect.FadeZoom, 
        Duration = 300 
    };

    // Advanced Filter Properties
    private bool showAdvancedFilters = false;
    private UserRole? SelectedRoleFilter = null;
    private UserStatus? SelectedStatusFilter = null;
    private string SelectedDepartmentFilter = "";
    private string GlobalSearchText = "";
    private string SelectedActivityPeriod = "";

    // Statistics Properties
    private List<UserStatistic> UserStatistics = new();

    // Filter Options
    private List<FilterOption<UserRole?>> RoleFilterOptions = new();
    private List<FilterOption<UserStatus?>> StatusFilterOptions = new();
    private List<string> DepartmentFilterOptions = new();
    
    // Add/Edit Form Options
    private List<UserRole> AllRoles = new();
    private List<UserStatus> AllStatuses = new();
    private List<string> DepartmentOptions = new();
    
    private List<string> ActivityPeriodOptions = new()
    {
        "Ultima saptamana",
        "Ultima luna", 
        "Ultimele 3 luni",
        "Ultimele 6 luni",
        "Ultimul an",
        "Niciodata conectati"
    };

    // Helper Classes
    private class FilterOption<T>
    {
        public string Text { get; set; } = "";
        public T Value { get; set; } = default!;
    }

    private class UserStatistic
    {
        public string Label { get; set; } = "";
        public int Value { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("DEBUG: Component initializing...");
        await LoadUsers();
        InitializeFilterOptions();
        InitializeFormOptions();
        Console.WriteLine("DEBUG: Component initialization complete");
    }

    private async Task LoadUsers()
    {
        try
        {
            Users = await UserService.GetAllUsersAsync();
            FilteredUsers = Users;
            CalculateStatistics();
            Console.WriteLine($"DEBUG: Loaded {Users.Count} users");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading users: {ex.Message}");
            await ShowToast("Eroare", "Nu s-au putut incarca utilizatorii", "e-toast-danger");
        }
    }

    private void CalculateStatistics()
    {
        UserStatistics = new List<UserStatistic>
        {
            new() { Label = "Total Utilizatori", Value = Users.Count },
            new() { Label = "Utilizatori Activi", Value = Users.Count(u => u.Status == UserStatus.Active) },
            new() { Label = "Doctori", Value = Users.Count(u => u.Role == UserRole.Doctor) },
            new() { Label = "Activi saptamana aceasta", Value = Users.Count(u => u.LastLoginDate >= DateTime.Now.AddDays(-7)) },
            new() { Label = "Asistente Medicale", Value = Users.Count(u => u.Role == UserRole.Nurse) },
            new() { Label = "Administratori", Value = Users.Count(u => u.Role == UserRole.Administrator) },
            new() { Label = "Manageri", Value = Users.Count(u => u.Role == UserRole.Manager) },
            new() { Label = "Suspendati", Value = Users.Count(u => u.Status == UserStatus.Suspended) }
        };
    }

    private void InitializeFilterOptions()
    {
        RoleFilterOptions = new List<FilterOption<UserRole?>>
        {
            new() { Text = "Toate rolurile", Value = null }
        };
        RoleFilterOptions.AddRange(Enum.GetValues<UserRole>().Select(r => 
            new FilterOption<UserRole?> { Text = GetRoleDisplayName(r), Value = r }));

        StatusFilterOptions = new List<FilterOption<UserStatus?>>
        {
            new() { Text = "Toate statusurile", Value = null }
        };
        StatusFilterOptions.AddRange(Enum.GetValues<UserStatus>().Select(s => 
            new FilterOption<UserStatus?> { Text = GetStatusDisplayName(s), Value = s }));

        DepartmentFilterOptions = new List<string>
        {
            "", "Cardiologie", "Neurologie", "Pediatrie", "Chirurgie", "Radiologie", "Laborator", "Administrare", "Management"
        };
    }

    private void InitializeFormOptions()
    {
        AllRoles = Enum.GetValues<UserRole>().ToList();
        AllStatuses = Enum.GetValues<UserStatus>().ToList();
        DepartmentOptions = new List<string>
        {
            "Cardiologie", "Neurologie", "Pediatrie", "Chirurgie", "Radiologie", 
            "Laborator", "Administrare", "Management", "Urgente", "Ginecologie"
        };
    }

    private async Task RefreshData()
    {
        await LoadUsers();
        if (GridRef != null)
        {
            await GridRef.Refresh();
        }
        await ShowToast("Succes", "Datele au fost actualizate", "e-toast-success");
    }

    private async Task ShowToast(string title, string content, string cssClass)
    {
        if (ToastRef != null)
        {
            var toastModel = new ToastModel()
            {
                Title = title,
                Content = content,
                CssClass = cssClass,
                ShowCloseButton = true,
                Timeout = 3000
            };
            await ToastRef.ShowAsync(toastModel);
        }
    }

    // Filter Methods
    private void ToggleFilterPanel()
    {
        showAdvancedFilters = !showAdvancedFilters;
        StateHasChanged();
    }

    private async Task OnRoleFilterChanged(ChangeEventArgs<UserRole?, FilterOption<UserRole?>> args)
    {
        SelectedRoleFilter = args.Value;
        await ApplyAdvancedFilters();
    }

    private async Task OnStatusFilterChanged(ChangeEventArgs<UserStatus?, FilterOption<UserStatus?>> args)
    {
        SelectedStatusFilter = args.Value;
        await ApplyAdvancedFilters();
    }

    private async Task OnDepartmentFilterChanged(ChangeEventArgs<string, string> args)
    {
        SelectedDepartmentFilter = args.Value ?? "";
        await ApplyAdvancedFilters();
    }

    private async Task OnGlobalSearchChanged(ChangedEventArgs args)
    {
        GlobalSearchText = args.Value ?? "";
        await ApplyAdvancedFilters();
    }

    private async Task OnActivityPeriodChanged(ChangeEventArgs<string, string> args)
    {
        SelectedActivityPeriod = args.Value ?? "";
        await ApplyAdvancedFilters();
    }

    private async Task ApplyAdvancedFilters()
    {
        try
        {
            FilteredUsers = Users.AsQueryable().Where(u =>
                (SelectedRoleFilter == null || u.Role == SelectedRoleFilter) &&
                (SelectedStatusFilter == null || u.Status == SelectedStatusFilter) &&
                (string.IsNullOrEmpty(SelectedDepartmentFilter) || u.Department == SelectedDepartmentFilter) &&
                (string.IsNullOrEmpty(GlobalSearchText) || 
                 u.FirstName.Contains(GlobalSearchText, StringComparison.OrdinalIgnoreCase) ||
                 u.LastName.Contains(GlobalSearchText, StringComparison.OrdinalIgnoreCase) ||
                 u.Email.Contains(GlobalSearchText, StringComparison.OrdinalIgnoreCase) ||
                 u.Username.Contains(GlobalSearchText, StringComparison.OrdinalIgnoreCase)) &&
                (string.IsNullOrEmpty(SelectedActivityPeriod) || FilterByActivityPeriod(u, SelectedActivityPeriod))
            ).Distinct().ToList();

            if (GridRef != null)
            {
                GridRef.DataSource = FilteredUsers;
                await GridRef.Refresh();
            }

            await ShowToast("Filtru aplicat", $"Gasite {FilteredUsers.Count} rezultate din {Users.Count} utilizatori", "e-toast-info");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error applying filters: {ex.Message}");
            await ShowToast("Eroare", "Eroare la aplicarea filtrelor", "e-toast-danger");
        }
    }

    private bool FilterByActivityPeriod(User user, string period)
    {
        if (user.LastLoginDate == null) 
            return period == "Niciodata conectati";

        var now = DateTime.Now;
        return period switch
        {
            "Ultima saptamana" => user.LastLoginDate >= now.AddDays(-7),
            "Ultima luna" => user.LastLoginDate >= now.AddMonths(-1),
            "Ultimele 3 luni" => user.LastLoginDate >= now.AddMonths(-3),
            "Ultimele 6 luni" => user.LastLoginDate >= now.AddMonths(-6),
            "Ultimul an" => user.LastLoginDate >= now.AddYears(-1),
            "Niciodata conectati" => false,
            _ => true
        };
    }

    private async Task ClearAdvancedFilters()
    {
        SelectedRoleFilter = null;
        SelectedStatusFilter = null;
        SelectedDepartmentFilter = "";
        GlobalSearchText = "";
        SelectedActivityPeriod = "";

        if (GridRef != null)
        {
            GridRef.DataSource = Users;
            await GridRef.Refresh();
        }

        await ShowToast("Filtre curatate", "Toate filtrele au fost eliminate", "e-toast-success");
        StateHasChanged();
    }

    private async Task ExportFilteredData()
    {
        try
        {
            await ShowToast("Export", "Functia de export va fi implementata in viitor", "e-toast-info");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Export error: {ex.Message}");
            await ShowToast("Eroare Export", "Eroare la exportul datelor", "e-toast-danger");
        }
    }

    // Grid Events
    public void RowSelected(RowSelectEventArgs<User> args) { }
    public void RowDeselected(RowDeselectEventArgs<User> args) { }
    
    // Modal Detail Methods
    private async Task ShowUserDetailModal(User user)
    {
        try
        {
            Console.WriteLine($"DEBUG: Opening modal for user {user.FullName}");
            SelectedUser = user;
            IsModalVisible = true;
            StateHasChanged();
            
            await ShowToast("Detalii", $"Afisare detalii pentru {user.FullName}", "e-toast-info");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ERROR: Error showing user detail modal: {ex.Message}");
            await ShowToast("Eroare", "Eroare la afisarea detaliilor", "e-toast-danger");
        }
    }

    private async Task CloseUserDetailModal()
    {
        try
        {
            IsModalVisible = false;
            SelectedUser = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error closing modal: {ex.Message}");
            IsModalVisible = false;
            SelectedUser = null;
            StateHasChanged();
        }
    }

    private async Task EditUserFromModal()
    {
        if (SelectedUser != null)
        {
            // Store the user data before closing detail modal
            var userToEdit = SelectedUser;
            
            // Close the detail modal first
            await CloseUserDetailModal();
            
            // Add a small delay for smooth transition
            await Task.Delay(200);
            
            // Open the edit modal with the stored user data
            await EditUser(userToEdit);
        }
    }

    // Modal Event Handlers
    private void OnModalClosed()
    {
        IsModalVisible = false;
        SelectedUser = null;
        StateHasChanged();
    }

    private void OnAddEditModalClosed()
    {
        IsAddEditModalVisible = false;
        EditingUser = new User();
        IsEditMode = false;
        StateHasChanged();
    }
    
    // Add/Edit Modal Methods
    private async Task ShowAddUserModal()
    {
        try
        {
            Console.WriteLine("DEBUG: Opening Add User Modal");
            IsEditMode = false;
            EditingUser = new User
            {
                Status = UserStatus.Active,
                CreatedDate = DateTime.Now,
                Role = UserRole.Operator
            };
            IsAddEditModalVisible = true;
            StateHasChanged();
            
            await ShowToast("Nou utilizator", "Completeaza formularul pentru a adauga un utilizator nou", "e-toast-info");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ERROR: Error showing add user modal: {ex.Message}");
            await ShowToast("Eroare", "Eroare la deschiderea formularului de adaugare", "e-toast-danger");
        }
    }

    private async Task ShowEditUserModal(User user)
    {
        try
        {
            IsEditMode = true;
            EditingUser = new User
            {
                Id = user.Id,
                FirstName = user.FirstName,
                LastName = user.LastName,
                Email = user.Email,
                Username = user.Username,
                Phone = user.Phone,
                Role = user.Role,
                Status = user.Status,
                Department = user.Department,
                JobTitle = user.JobTitle,
                CreatedDate = user.CreatedDate,
                LastLoginDate = user.LastLoginDate
            };
            IsAddEditModalVisible = true;
            StateHasChanged();
            
            await ShowToast("Editare utilizator", $"Modificati informatiile pentru {user.FullName}", "e-toast-info");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error showing edit user modal: {ex.Message}");
            await ShowToast("Eroare", "Eroare la deschiderea formularului de editare", "e-toast-danger");
        }
    }

    private async Task CloseAddEditModal()
    {
        try
        {
            IsAddEditModalVisible = false;
            EditingUser = new();
            IsEditMode = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error closing add/edit modal: {ex.Message}");
            IsAddEditModalVisible = false;
            EditingUser = new();
            IsEditMode = false;
            StateHasChanged();
        }
    }

    private async Task SaveUser()
    {
        try
        {
            if (IsEditMode)
            {
                await ShowToast("Actualizare", $"Utilizatorul {EditingUser.FullName} a fost actualizat cu succes", "e-toast-success");
                // TODO: Implement actual update logic
            }
            else
            {
                await ShowToast("Creare", $"Utilizatorul {EditingUser.FullName} a fost creat cu succes", "e-toast-success");
                // TODO: Implement actual create logic
            }
            
            await CloseAddEditModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving user: {ex.Message}");
            await ShowToast("Eroare", $"Eroare la salvarea utilizatorului: {ex.Message}", "e-toast-danger");
        }
    }

    // Action Methods
    private async Task EditUser(User user)
    {
        try
        {
            await ShowEditUserModal(user);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error editing user: {ex.Message}");
            await ShowToast("Eroare", "Eroare la editarea utilizatorului", "e-toast-danger");
        }
    }

    private async Task DeleteUser(User user)
    {
        try
        {
            var confirmDelete = await JSRuntime.InvokeAsync<bool>("confirm", 
                $"Sigur doriti sa stergeti utilizatorul {user.FullName}?");
            
            if (confirmDelete)
            {
                await ShowToast("Stergere", $"Utilizatorul {user.FullName} va fi sters", "e-toast-info");
                // TODO: Implement actual delete logic
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting user: {ex.Message}");
            await ShowToast("Eroare", "Eroare la stergerea utilizatorului", "e-toast-danger");
        }
    }

    // Display Methods
    private string GetRoleDisplayName(UserRole role) => role switch
    {
        UserRole.Administrator => "Administrator",
        UserRole.Doctor => "Doctor",
        UserRole.Nurse => "Asistent medical",
        UserRole.Receptionist => "Receptioner",
        UserRole.Operator => "Operator",
        UserRole.Manager => "Manager",
        _ => "Necunoscut"
    };

    private string GetStatusDisplayName(UserStatus status) => status switch
    {
        UserStatus.Active => "Activ",
        UserStatus.Inactive => "Inactiv",
        UserStatus.Suspended => "Suspendat",
        UserStatus.Pending => "In asteptare",
        _ => "Necunoscut"
    };

    // Helper methods for detail template
    private string GetActivityStatus(DateTime? lastLogin)
    {
        if (lastLogin == null) return "Niciodata conectat";
        
        var daysSinceLogin = (DateTime.Now - lastLogin.Value).Days;
        return daysSinceLogin switch
        {
            0 => "Activ astazi",
            1 => "Activ ieri",
            <= 7 => $"Activ acum {daysSinceLogin} zile",
            <= 30 => $"Activ acum {daysSinceLogin / 7} saptamani",
            <= 365 => $"Activ acum {daysSinceLogin / 30} luni",
            _ => $"Inactiv de peste {daysSinceLogin / 365} ani"
        };
    }

    private string GetSystemAge(DateTime createdDate)
    {
        var age = DateTime.Now - createdDate;
        if (age.TotalDays < 1) return "Sub 24 ore";
        if (age.TotalDays < 30) return $"{age.Days} zile";
        if (age.TotalDays < 365) return $"{age.Days / 30} luni";
        return $"{age.Days / 365} ani";
    }
}