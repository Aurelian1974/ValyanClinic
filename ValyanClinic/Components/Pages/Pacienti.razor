@page "/pacienti"
@using ValyanClinic.Components.Pages.Models
@using ValyanClinic.Components.Shared

<PageTitle>Pacienti - ValyanMed</PageTitle>

<PageHeader Title="Gestionare Pacienti" 
           Icon="??"
           Subtitle="@GetPatientCountSubtitle()"
           Breadcrumbs="@GetBreadcrumbs()">
    <Actions>
        <button class="btn-primary" @onclick="AddNewPatientAsync">
            <span class="btn-icon">??+</span>
            Adauga Pacient Nou
        </button>
    </Actions>
</PageHeader>

<div class="page-container">
    <!-- Loading State -->
    @if (IsLoading)
    {
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Se incarca pacientii...</p>
        </div>
        return;
    }

    <!-- Error State -->
    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="error-container">
            <div class="error-message">
                <span class="error-icon">??</span>
                @ErrorMessage
            </div>
            <button class="btn-secondary" @onclick="() => LoadPatientsAsync()">
                Reincearca
            </button>
        </div>
        return;
    }

    <!-- Search and Filters -->
    <div class="filters-card">
        <div class="filters-grid">
            <div class="filter-group">
                <label>Cautare pacient</label>
                <input type="text" @bind="SearchTerm" @bind:event="oninput" 
                       placeholder="Cauta dupa nume, email, telefon sau CNP..." class="search-input" />
            </div>
            <div class="filter-group">
                <label>Status</label>
                <select @bind="SelectedStatus" class="filter-select">
                    <option value="">Toate statusurile</option>
                    <option value="@PatientStatus.Active">Activ</option>
                    <option value="@PatientStatus.Inactive">Inactiv</option>
                    <option value="@PatientStatus.Suspended">Suspendat</option>
                </select>
            </div>
            <div class="filter-group">
                @if (FilterState.HasActiveFilters)
                {
                    <button class="btn-secondary" @onclick="() => ResetFilters()">
                        <span class="btn-icon">??</span>
                        Reseteaza Filtrele
                    </button>
                }
            </div>
        </div>
    </div>

    <!-- Results Summary -->
    <div class="results-summary">
        <div class="summary-stats">
            <div class="stat-item">
                <span class="stat-number">@GetFilteredPatients().Count()</span>
                <span class="stat-label">pacienti gasiti</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">@AllPatients.Count(p => p.Status == PatientStatus.Active)</span>
                <span class="stat-label">activi</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">@AllPatients.Count(p => p.LastVisit >= DateTime.Now.AddDays(-30))</span>
                <span class="stat-label">vizite recente</span>
            </div>
        </div>
    </div>

    <!-- Patients List -->
    <div class="data-card">
        @{
            var filteredPatients = GetFilteredPatients().ToList();
        }
        
        @if (!filteredPatients.Any())
        {
            <div class="empty-state">
                <div class="empty-icon">??</div>
                <h3>Nu au fost gasiti pacienti</h3>
                <p>Modifica criteriile de cautare sau adauga un pacient nou.</p>
                <button class="btn-primary" @onclick="AddNewPatientAsync">
                    Adauga primul pacient
                </button>
            </div>
        }
        else
        {
            <div class="data-table">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Nume Complet</th>
                            <th>Varsta</th>
                            <th>Telefon</th>
                            <th>Email</th>
                            <th>CNP</th>
                            <th>Status</th>
                            <th>Ultima Consultatie</th>
                            <th>Actiuni</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var patient in filteredPatients)
                        {
                            <tr class="patient-row">
                                <td class="patient-name">
                                    <div class="patient-info">
                                        <strong>@patient.FullName</strong>
                                        <small>ID: @patient.Id</small>
                                    </div>
                                </td>
                                <td class="patient-age">@patient.Age ani</td>
                                <td class="patient-phone">
                                    <a href="tel:@patient.Phone" class="phone-link">@patient.Phone</a>
                                </td>
                                <td class="patient-email">
                                    <a href="mailto:@patient.Email" class="email-link">@patient.Email</a>
                                </td>
                                <td class="patient-cnp">@patient.CNP</td>
                                <td class="patient-status">
                                    <span class="status-badge @GetStatusCssClass(patient.Status)">
                                        @GetStatusDisplayName(patient.Status)
                                    </span>
                                </td>
                                <td class="patient-last-visit">
                                    @patient.LastVisit.ToString("dd.MM.yyyy")
                                    <small>(@((DateTime.Now - patient.LastVisit).Days) zile)</small>
                                </td>
                                <td class="patient-actions">
                                    <div class="action-buttons">
                                        <button class="btn-icon-small btn-view" 
                                                @onclick="() => ViewPatientAsync(patient.Id)" 
                                                title="Vezi detalii pacient">
                                            ???
                                        </button>
                                        <button class="btn-icon-small btn-edit" 
                                                @onclick="() => EditPatientAsync(patient.Id)" 
                                                title="Editeaza pacient">
                                            ??
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>