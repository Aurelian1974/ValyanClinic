@page "/parinte5/copil1"
@page "/utilizatori"
@using ValyanClinic.Domain.Models
@using ValyanClinic.Domain.Enums
@using ValyanClinic.Application.Services
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Notifications
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Popups
@using GridSelectionType = Syncfusion.Blazor.Grids.SelectionType
@using GridSelectionMode = Syncfusion.Blazor.Grids.SelectionMode
@using GridSortDirection = Syncfusion.Blazor.Grids.SortDirection
@using GridFilterType = Syncfusion.Blazor.Grids.FilterType
@rendermode InteractiveServer

<PageTitle>Gestionare Utilizatori - ValyanMed</PageTitle>

<div class="users-page-container">
    
    @* Error Display *@
    @if (_state.HasError)
    {
        <div class="alert alert-danger d-flex align-items-center">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <div class="flex-1">@_state.ErrorMessage</div>
            <button class="btn-close" @onclick="_state.ClearError" aria-label="Close"></button>
        </div>
    }

    @* Page Header - RESTORED TO BEAUTIFUL ORIGINAL *@
    <div class="users-page-header">
        <div class="header-content">
            <div class="header-text">
                <h1 class="users-page-title">
                    <i class="fas fa-users"></i>
                    Gestionare Utilizatori
                </h1>
                <p class="users-page-subtitle">
                    Administreaza utilizatorii sistemului ValyanMed - adauga, editeaza si gestioneaza permisiunile
                </p>
            </div>
            
            <div class="users-header-actions">
                <button class="btn btn-outline-primary" @onclick="ShowAddUserModal">
                    <i class="fas fa-plus"></i>
                    <span class="btn-text">Adauga Utilizator</span>
                </button>
                <button class="btn btn-outline-secondary" @onclick="RefreshData">
                    <i class="fas fa-sync-alt"></i>
                    <span class="btn-text">Actualizeaza</span>
                </button>
            </div>
        </div>
    </div>

    @* Statistics Cards - RESTORED TO ALL 8 BEAUTIFUL CARDS *@
    @if (!_state.IsLoading)
    {
        <div class="users-stats-grid">
            @foreach (var stat in _models.UserStatistics)
            {
                <div class="users-stat-card">
                    <div class="users-stat-number">@stat.Value</div>
                    <div class="users-stat-label">@stat.Label</div>
                </div>
            }
        </div>
    }

    @* Toast Notification *@
    <SfToast @ref="ToastRef" Title="ValyanMed" Target="body" NewestOnTop="true" ShowProgressBar="true"></SfToast>

    @* Advanced Filter Panel - RESTORED TO FULL BEAUTIFUL VERSION *@
    <div class="users-advanced-filter-panel">
        <div class="filter-panel-header">
            <h3>
                <i class="fas fa-filter"></i>
                Filtrare Avansata
            </h3>
            <button class="btn btn-secondary btn-sm" @onclick="ToggleFilterPanel">
                <i class="fas @(_state.ShowAdvancedFilters ? "fa-chevron-up" : "fa-chevron-down")"></i>
                <span>@(_state.ShowAdvancedFilters ? "Ascunde Filtrele" : "Arata Filtrele")</span>
            </button>
        </div>
        
        @if (_state.ShowAdvancedFilters)
        {
            <div class="filter-panel-content">
                @* First row - Rol, Status, Departament *@
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Rol:</label>
                        <SfDropDownList TItem="UtilizatoriModels.FilterOption<UserRole?>" TValue="UserRole?" 
                                       DataSource="@_models.RoleFilterOptions" 
                                       @bind-Value="@_state.SelectedRoleFilter"
                                       Placeholder="Toate rolurile"
                                       AllowFiltering="true"
                                       PopupHeight="200px"
                                       Width="150px">
                            <DropDownListFieldSettings Text="Text" Value="Value" />
                            <DropDownListEvents TItem="UtilizatoriModels.FilterOption<UserRole?>" TValue="UserRole?" ValueChange="OnRoleFilterChanged" />
                        </SfDropDownList>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Status:</label>
                        <SfDropDownList TItem="UtilizatoriModels.FilterOption<UserStatus?>" TValue="UserStatus?" 
                                       DataSource="@_models.StatusFilterOptions" 
                                       @bind-Value="@_state.SelectedStatusFilter"
                                       Placeholder="Toate statusurile"
                                       AllowFiltering="true"
                                       PopupHeight="200px"
                                       Width="150px">
                            <DropDownListFieldSettings Text="Text" Value="Value" />
                            <DropDownListEvents TItem="UtilizatoriModels.FilterOption<UserStatus?>" TValue="UserStatus?" ValueChange="OnStatusFilterChanged" />
                        </SfDropDownList>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Departament:</label>
                        <SfDropDownList TItem="string" TValue="string" 
                                       DataSource="@_models.DepartmentFilterOptions" 
                                       @bind-Value="@_state.SelectedDepartmentFilter"
                                       Placeholder="Toate departamentele"
                                       AllowFiltering="true"
                                       PopupHeight="200px"
                                       Width="180px">
                            <DropDownListEvents TItem="string" TValue="string" ValueChange="OnDepartmentFilterChanged" />
                        </SfDropDownList>
                    </div>
                </div>
                
                @* Second row - Cautare text, Perioada activitate *@
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Cautare text:</label>
                        <SfTextBox @bind-Value="@_state.GlobalSearchText" 
                                  Placeholder="Cauta in nume, email, username..."
                                  Width="250px"
                                  ShowClearButton="true">
                            <TextBoxEvents ValueChange="OnGlobalSearchChanged" />
                        </SfTextBox>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Perioada activitate:</label>
                        <SfDropDownList TItem="string" TValue="string" 
                                       DataSource="@_models.ActivityPeriodOptions" 
                                       @bind-Value="@_state.SelectedActivityPeriod"
                                       Placeholder="Orice perioada"
                                       Width="180px">
                            <DropDownListEvents TItem="string" TValue="string" ValueChange="OnActivityPeriodChanged" />
                        </SfDropDownList>
                    </div>
                    
                    @* Empty space to maintain layout balance *@
                    <div class="filter-group"></div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn btn-primary btn-sm" @onclick="ApplyAdvancedFilters">
                        <i class="fas fa-check"></i>
                        <span>Aplica Filtrele</span>
                    </button>
                    <button class="btn btn-secondary btn-sm" @onclick="ClearAdvancedFilters">
                        <i class="fas fa-times"></i>
                        <span>Curata Filtrele</span>
                    </button>
                    <button class="btn btn-info btn-sm" @onclick="ExportFilteredData">
                        <i class="fas fa-download"></i>
                        <span>Exporta Rezultate</span>
                    </button>
                </div>
                
                @* Filter Results Summary *@
                <div class="filter-results-summary">
                    <div class="results-info">
                        <span class="results-count">
                            <i class="fas fa-search"></i>
                            Rezultate: <strong>@_models.FilteredUsers.Count</strong> din <strong>@_models.Users.Count</strong> utilizatori
                        </span>
                        @if (_state.IsAnyFilterActive)
                        {
                            <span class="filtered-indicator">
                                <i class="fas fa-filter"></i>
                                Filtrare activa
                            </span>
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    @* Main DataGrid *@
    @if (_state.IsLoading)
    {
        <div class="users-grid-container">
            <div class="loading-indicator text-center p-5">
                <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                <div class="mt-3">Se incarca utilizatorii...</div>
            </div>
        </div>
    }
    else
    {
        <div class="users-grid-container">
            <SfGrid @ref="GridRef" DataSource="@_models.FilteredUsers" 
                    AllowPaging="true" 
                    AllowSorting="true" 
                    AllowFiltering="true"
                    AllowGrouping="true"
                    AllowSelection="true"
                    AllowReordering="true"
                    AllowResizing="true"
                    ShowColumnMenu="true">
                
                @* Grid Events *@
                <GridEvents TValue="User" 
                           RowSelected="RowSelected"
                           RowDeselected="RowDeselected">
                </GridEvents>

                @* Selection Settings *@
                <GridSelectionSettings Type="GridSelectionType.Multiple" Mode="GridSelectionMode.Row"></GridSelectionSettings>

                @* Page Settings *@
                <GridPageSettings PageSize="20" PageSizes="@_models.PageSizes"></GridPageSettings>

                @* Sort Settings *@
                <GridSortSettings AllowUnsort="true">
                    <GridSortColumns>
                        <GridSortColumn Field="LastName" Direction="GridSortDirection.Ascending"></GridSortColumn>
                    </GridSortColumns>
                </GridSortSettings>

                @* Filter Settings *@
                <GridFilterSettings Type="GridFilterType.Excel" 
                                  Mode="FilterBarMode.Immediate"
                                  ShowFilterBarStatus="true"
                                  ImmediateModeDelay="500">
                </GridFilterSettings>

                @* Group Settings *@
                <GridGroupSettings ShowDropArea="true" ShowToggleButton="true" ShowGroupedColumn="true">
                    <GridGroupColumns>
                        <GridGroupColumn Field="Department"></GridGroupColumn>
                    </GridGroupColumns>
                </GridGroupSettings>

                @* Columns Definition - OPTIMIZED FOR SCREEN WIDTH *@
                <GridColumns>
                    <GridColumn Field="@nameof(User.Id)" HeaderText="ID" Width="50" TextAlign="TextAlign.Center" 
                               IsPrimaryKey="true" AllowFiltering="true" AllowReordering="false"></GridColumn>
                    <GridColumn Field="@nameof(User.FirstName)" HeaderText="Nume" Width="100" AllowFiltering="true" AllowReordering="true"></GridColumn>
                    <GridColumn Field="@nameof(User.LastName)" HeaderText="Prenume" Width="100" AllowFiltering="true" AllowReordering="true"></GridColumn>
                    <GridColumn Field="@nameof(User.Email)" HeaderText="Email" Width="160" AllowFiltering="true" AllowReordering="true"></GridColumn>
                    <GridColumn Field="@nameof(User.Username)" HeaderText="Username" Width="90" AllowFiltering="true" AllowReordering="true"></GridColumn>
                    <GridColumn Field="@nameof(User.Phone)" HeaderText="Telefon" Width="90" AllowFiltering="true" AllowReordering="true"></GridColumn>
                               
                    <GridColumn Field="@nameof(User.Role)" HeaderText="Rol" Width="90" AllowFiltering="true" AllowReordering="true">
                        <Template>
                            @{                                               
                                var user = context as User;
                                <span>@GetRoleDisplayName(user!.Role)</span>
                            }
                        </Template>
                    </GridColumn>
                               
                    <GridColumn Field="@nameof(User.Department)" HeaderText="Departament" Width="100" 
                               AllowFiltering="true" AllowReordering="true"></GridColumn>
                               
                    <GridColumn Field="@nameof(User.Status)" HeaderText="Status" Width="70" 
                               AllowFiltering="true" AllowReordering="true">
                        <Template>
                            @{                                               
                                var user = context as User;
                                <span class="status-badge status-@user!.Status.ToString().ToLower()">
                                    @GetStatusDisplayName(user.Status)
                                </span>
                            }
                        </Template>
                    </GridColumn>
                               
                    <GridColumn Field="@nameof(User.JobTitle)" HeaderText="Functia" Width="100" AllowFiltering="true" AllowReordering="true"></GridColumn>
                    <GridColumn Field="@nameof(User.CreatedDate)" HeaderText="Data Crearii" Width="90" 
                               Format="dd.MM.yyyy" Type="ColumnType.Date" AllowFiltering="true" AllowReordering="true"></GridColumn>
                    <GridColumn Field="@nameof(User.LastLoginDate)" HeaderText="Ultima Autent." Width="100" 
                               Format="dd.MM.yyyy" Type="ColumnType.DateTime" AllowFiltering="true" AllowReordering="true"></GridColumn>
                               
                    @* Actions Column - FROZEN RIGHT *@
                    <GridColumn HeaderText="Actiuni" Width="120" AllowFiltering="false" AllowSorting="false"
                               IsFrozen = "true" Freeze="FreezeDirection.Right" AllowReordering="false">
                        <Template>
                            @{
                                var user = context as User;
                                <div class="action-buttons">
                                    <button class="btn-action btn-view" @onclick="() => ShowUserDetailModal(user!)" 
                                            title="Vizualizeaza detaliile utilizatorului" aria-label="Vizualizeaza">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn-action btn-edit" @onclick="() => EditUser(user!)" 
                                            title="Modifica utilizatorul" aria-label="Modifica">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-action btn-delete" @onclick="() => DeleteUser(user!)" 
                                            title="Sterge utilizatorul" aria-label="Sterge">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            }
                        </Template>
                    </GridColumn>
                </GridColumns>
            </SfGrid>
        </div>
    }

    @* User Detail Modal - USING SEPARATE COMPONENT *@
    <SfDialog @ref="UserDetailModal" 
              Width="900px" 
              Height="700px"
              IsModal="true" 
              Visible="@_state.IsModalVisible"
              ShowCloseIcon="true"
              AllowDragging="true"
              CssClass="user-dialog detail-dialog"
              AnimationSettings="@DialogAnimation">
        <DialogEvents Closed="OnModalClosed" />
        <DialogTemplates>
            <Header>
                <div class="modal-header-content">
                    <i class="fas fa-user-circle modal-header-icon"></i>
                    <div>
                        <h3 class="modal-header-title">@_state.SelectedUser?.FullName</h3>
                        <p class="modal-header-subtitle">Detalii utilizator</p>
                    </div>
                </div>
            </Header>
            <Content>
                @if (_state.SelectedUser != null)
                {
                    <VizualizeazUtilizator UserId="@_state.SelectedUser.Id" />
                }
            </Content>
            <FooterTemplate>
                <div class="modal-footer-actions">
                    <button class="btn btn-primary" @onclick="EditUserFromModal">
                        <i class="fas fa-edit"></i> Editeaza Utilizatorul
                    </button>
                    <button class="btn btn-secondary" @onclick="CloseUserDetailModal">
                        <i class="fas fa-times"></i> Inchide
                    </button>
                </div>
            </FooterTemplate>
        </DialogTemplates>
    </SfDialog>

    @* Add/Edit User Modal - USING SEPARATE COMPONENT *@
    <SfDialog @ref="AddEditUserModal" 
              Width="900px" 
              Height="700px"
              IsModal="true" 
              Visible="@_state.IsAddEditModalVisible"
              ShowCloseIcon="true"
              AllowDragging="true"
              CssClass="user-dialog edit-dialog"
              AnimationSettings="@DialogAnimation">
        <DialogEvents Closed="OnAddEditModalClosed" />
        <DialogTemplates>
            <Header>
                <div class="modal-header-content">
                    <i class="fas fa-user-plus modal-header-icon"></i>
                    <div>
                        <h3 class="modal-header-title">@_state.GetModalTitle()</h3>
                        <p class="modal-header-subtitle">@_state.GetModalSubtitle()</p>
                    </div>
                </div>
            </Header>
            <Content>
                @if (_state.IsEditMode && _state.EditingUser != null)
                {
                    <AdaugaEditezUtilizator UserId="@_state.EditingUser.Id" 
                                           EditingUser="@_state.EditingUser"
                                           OnSave="@SaveUser" 
                                           OnCancel="@CloseAddEditModal" />
                }
                else
                {
                    <AdaugaEditezUtilizator OnSave="@SaveUser" 
                                           OnCancel="@CloseAddEditModal" />
                }
            </Content>
            <FooterTemplate>
                <div class="modal-footer-actions">
                    <button type="button" class="btn btn-primary" @onclick="OnFormSubmit" disabled="@_state.IsLoading">
                        <i class="fas fa-save"></i>
                        @(_state.IsEditMode ? "Actualizeaza Utilizatorul" : "Creeaza Utilizatorul")
                    </button>
                    <button type="button" class="btn btn-secondary" @onclick="CloseAddEditModal" disabled="@_state.IsLoading">
                        <i class="fas fa-times"></i>
                        Anuleaza
                    </button>
                </div>
            </FooterTemplate>
        </DialogTemplates>
    </SfDialog>

    @* JavaScript functions for opening pages in new windows *@
    <script>
        window.openUserWindow = function(url, title, width = 900, height = 700) {
            const left = (screen.width / 2) - (width / 2);
            const top = (screen.height / 2) - (height / 2);
            const options = `width=${width},height=${height},left=${left},top=${top},scrollbars=yes,resizable=yes,toolbar=no,menubar=no,location=no,status=no`;
            window.open(url, title, options);
        };
    </script>
</div>
