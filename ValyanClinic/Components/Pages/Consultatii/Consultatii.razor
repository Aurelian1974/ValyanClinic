@page "/consultatii/{ProgramareIdParam:guid}/{PacientIdParam:guid}"
@attribute [Authorize(Roles = "Doctor,Medic")]
@rendermode InteractiveServer

<PageTitle>Consultație Medicală - ValyanClinic</PageTitle>

<div class="consultatii-page">
    @* ===== PAGE HEADER ===== *@
    <header class="page-header">
        <div class="page-title">
            <h2><i class="fas fa-stethoscope"></i> Consultație Medicală</h2>
            <p class="subtitle">Programare #@ProgramareIdParam.ToString()[..8]</p>
        </div>

        <div class="header-actions">
            <div class="consultation-timer @TimerClass">
                <i class="fas fa-clock"></i>
                <span class="time">@FormatTimer(TimerSeconds)</span>
                <div class="timer-tooltip">
                    @if (TimerSeconds < 900)
                    {
                        <text>Durată optimă: 15-20 min</text>
                    }
                    else if (TimerSeconds < 1200)
                    {
                        <text>✓ Durată optimă</text>
                    }
                    else if (TimerSeconds < 1500)
                    {
                        <text>⚠️ Depășit timpul recomandat</text>
                    }
                    else
                    {
                        <text>🔴 Consultație extinsă</text>
                    }
                </div>
            </div>

            <button class="btn btn-outline" @onclick="SaveDraft" disabled="@IsSaving">
                <i class="fas fa-save"></i>
                <span>Salvează Draft</span>
            </button>

            <button class="btn btn-primary" @onclick="SaveConsultation" disabled="@IsSaving">
                <i class="fas fa-file-medical"></i>
                <span>@(IsSaving ? "Salvare..." : "Finalizează")</span>
            </button>
        </div>
    </header>

    @* ===== PATIENT CARD ===== *@
    @if (Pacient != null)
    {
        <section class="patient-card">
            <div class="patient-avatar">
                <i class="fas fa-user"></i>
            </div>

            <div class="patient-details">
                <h3 class="patient-name">@Pacient.NumeComplet</h3>

                <div class="patient-meta">
                    <span class="patient-meta-item">
                        <i class="fas fa-id-card"></i>
                        CNP: @Pacient.CNP
                    </span>

                    <span class="patient-meta-item">
                        <i class="fas fa-birthday-cake"></i>
                        @Pacient.Varsta ani
                    </span>

                    <span class="patient-meta-item">
                        <i class="fas @(Pacient.Sex == "M" ? "fa-mars" : "fa-venus")"></i>
                        @(Pacient.Sex == "M" ? "Masculin" : "Feminin")
                    </span>

                    <span class="patient-meta-item">
                        <i class="fas fa-phone"></i>
                        @Pacient.Telefon
                    </span>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(Pacient.Alergii))
            {
                <div class="patient-tags">
                    <span class="tag tag-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Alergie @Pacient.Alergii
                    </span>
                </div>
            }
        </section>
    }

    @* ===== ALLERGY ALERT ===== *@
    <div class="allergy-alert @(ShowAllergyAlert ? "active" : "")">
        <div class="allergy-alert-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="allergy-alert-content">
            <div class="allergy-alert-title">⚠️ ALERTĂ ALERGIE DETECTATĂ!</div>
            <div class="allergy-alert-message">@AllergyMessage</div>
        </div>
        <button class="allergy-alert-close" @onclick="@(() => ShowAllergyAlert = false)">
            <i class="fas fa-times"></i>
        </button>
    </div>

    @* ===== TABS CONTAINER ===== *@
    <div class="tabs-container">
        <div class="tabs-progress">
            <div class="tabs-progress-bar" style="width: @ProgressPercent%"></div>
        </div>

        <div class="tabs-header">
            <button class="tab-btn @(ActiveTabIndex == 0 ? "active" : "")" @onclick="@(async () => await OnTabClick(0))">
                <i class="fas fa-comment-medical"></i>
                <span>Motiv & Antecedente</span>
                <span class="tab-number">1</span>
            </button>

            <button class="tab-btn @(ActiveTabIndex == 1 ? "active" : "")" @onclick="@(async () => await OnTabClick(1))">
                <i class="fas fa-stethoscope"></i>
                <span>Examen Clinic & Investigații</span>
                <span class="tab-number">2</span>
            </button>

            <button class="tab-btn @(ActiveTabIndex == 2 ? "active" : "")" @onclick="@(async () => await OnTabClick(2))">
                <i class="fas fa-diagnoses"></i>
                <span>Diagnostic & Tratament</span>
                <span class="tab-number">3</span>
            </button>

            <button class="tab-btn @(ActiveTabIndex == 3 ? "active" : "")" @onclick="@(async () => await OnTabClick(3))">
                <i class="fas fa-clipboard-check"></i>
                <span>Concluzii</span>
                <span class="tab-number">4</span>
            </button>
        </div>

        <div class="tabs-content">
            @* TAB 1: MOTIV & ANTECEDENTE *@
            @if (ActiveTabIndex == 0)
            {
                <div class="tab-panel active">
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-comment-medical"></i>
                            Motivul Prezentării
                        </h3>

                        <div class="form-row">
                            <div class="form-group full-width">
                                <label class="form-label required">Motivul principal al consultației</label>
                                <div class="textarea-wrapper">
                                    <textarea class="form-textarea has-counter" rows="3" maxlength="500"
                                              @bind="Model.MotivPrezentare" @oninput="@((e) => UpdateCharCount("motiv", e.Value?.ToString()))"
                                              placeholder="Descrieți motivul prezentării pacientului..."></textarea>
                                    <span class="char-counter @GetCharCounterClass(MotivCharCount, 500)">
                                        @MotivCharCount / 500
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-book-medical"></i>
                            Istoricul Bolii Actuale
                        </h3>

                        <div class="form-row">
                            <div class="form-group full-width">
                                <label class="form-label">Descriere detaliată</label>
                                <textarea class="form-textarea" rows="4"
                                          @bind="Model.IstoricBoalaActuala"
                                          placeholder="Descrieți detaliat evoluția și caracteristicile simptomelor..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-history"></i>
                            Antecedente
                        </h3>

                        <div class="expandable-section @(AHCExpanded ? "open" : "")">
                            <div class="expandable-header" @onclick="@(() => AHCExpanded = !AHCExpanded)">
                                <h4><i class="fas fa-dna"></i> Antecedente Heredocolaterale</h4>
                                <span class="expandable-toggle"><i class="fas fa-chevron-down"></i></span>
                            </div>
                            @if (AHCExpanded)
                            {
                                <div class="expandable-content">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Mamă</label>
                                            <textarea class="form-textarea" rows="2" @bind="Model.AHC_Mama" placeholder="Afecțiuni mamă..."></textarea>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Tată</label>
                                            <textarea class="form-textarea" rows="2" @bind="Model.AHC_Tata" placeholder="Afecțiuni tată..."></textarea>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group full-width">
                                            <label class="form-label">Observații</label>
                                            <textarea class="form-textarea" rows="2" placeholder="Detalii suplimentare..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="expandable-section @(APPExpanded ? "open" : "")">
                            <div class="expandable-header" @onclick="@(() => APPExpanded = !APPExpanded)">
                                <h4><i class="fas fa-notes-medical"></i> Antecedente Personale Patologice</h4>
                                <span class="expandable-toggle"><i class="fas fa-chevron-down"></i></span>
                            </div>
                            @if (APPExpanded)
                            {
                                <div class="expandable-content">
                                    <div class="form-row">
                                        <div class="form-group full-width">
                                            <label class="form-label">Afecțiuni cronice</label>
                                            <textarea class="form-textarea" rows="2" @bind="Model.APP_BoliAdult" placeholder="Listați afecțiunile cronice..."></textarea>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group full-width">
                                            <label class="form-label">Alergii cunoscute</label>
                                            <input type="text" class="form-input" @bind="Model.APP_Alergii" placeholder="Medicamente, alimente, substanțe..." />
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            @* TAB 2: EXAMEN CLINIC & INVESTIGAȚII *@
            @if (ActiveTabIndex == 1)
            {
                <div class="tab-panel active">
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-user-md"></i>
                            Examen Clinic General
                        </h3>

                        <div class="exam-grid">
                            <div class="exam-item" id="weightItem">
                                <div class="exam-item-header">
                                    <div class="exam-icon"><i class="fas fa-weight"></i></div>
                                    <div class="exam-label">Greutate</div>
                                </div>
                                <div class="exam-input-row">
                                    <input type="number" step="0.1" class="exam-input"
                                           @bind="GreutateKg" @oninput="OnGreutateChanged"
                                           placeholder="70" />
                                    <span class="exam-unit">kg</span>
                                </div>
                            </div>

                            <div class="exam-item" id="heightItem">
                                <div class="exam-item-header">
                                    <div class="exam-icon"><i class="fas fa-ruler-vertical"></i></div>
                                    <div class="exam-label">Înălțime</div>
                                </div>
                                <div class="exam-input-row">
                                    <input type="number" step="0.1" class="exam-input"
                                           @bind="InaltimeCm" @oninput="OnInaltimeChanged"
                                           placeholder="165" />
                                    <span class="exam-unit">cm</span>
                                </div>
                            </div>

                            <div class="exam-item" id="imcItem">
                                <div class="exam-item-header">
                                    <div class="exam-icon"><i class="fas fa-calculator"></i></div>
                                    <div class="exam-label">IMC</div>
                                </div>
                                <div class="exam-input-row">
                                    <input type="text" class="exam-input" value="@(IMCResult?.Value.ToString("F1") ?? "")" readonly style="background:#f1f5f9;" />
                                    <span class="exam-unit">kg/m²</span>
                                </div>
                                @if (IMCResult != null)
                                {
                                    <div class="imc-result" style="display: flex;">
                                        <span class="imc-badge @IMCResult.ColorClass">
                                            @IMCResult.Interpretation
                                        </span>
                                    </div>
                                }
                            </div>

                            <div class="exam-item">
                                <div class="exam-item-header">
                                    <div class="exam-icon"><i class="fas fa-tint"></i></div>
                                    <div class="exam-label">Tensiune Arterială</div>
                                </div>
                                <div class="exam-input-row">
                                    <input type="text" class="exam-input" @bind="Model.TensiuneArteriala" placeholder="120/80" />
                                    <span class="exam-unit">mmHg</span>
                                </div>
                            </div>

                            <div class="exam-item">
                                <div class="exam-item-header">
                                    <div class="exam-icon"><i class="fas fa-heartbeat"></i></div>
                                    <div class="exam-label">Frecv. Cardiacă</div>
                                </div>
                                <div class="exam-input-row">
                                    <input type="number" class="exam-input" @bind="Model.Puls" placeholder="72" />
                                    <span class="exam-unit">bpm</span>
                                </div>
                            </div>

                            <div class="exam-item">
                                <div class="exam-item-header">
                                    <div class="exam-icon"><i class="fas fa-thermometer-half"></i></div>
                                    <div class="exam-label">Temperatură</div>
                                </div>
                                <div class="exam-input-row">
                                    <input type="number" step="0.1" class="exam-input" @bind="Model.Temperatura" placeholder="36.6" />
                                    <span class="exam-unit">°C</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-row" style="margin-top: 16px;">
                            <div class="form-group full-width">
                                <label class="form-label">Observații examen general</label>
                                <textarea class="form-textarea" rows="2" placeholder="Alte constatări la examenul clinic general..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-stethoscope"></i>
                            Examen Clinic Local (pe aparate)
                        </h3>

                        <div class="expandable-section @(ExamenCardioExpanded ? "open" : "")">
                            <div class="expandable-header" @onclick="@(() => ExamenCardioExpanded = !ExamenCardioExpanded)">
                                <h4><i class="fas fa-heart"></i> Cardiovascular</h4>
                                <span class="expandable-toggle"><i class="fas fa-chevron-down"></i></span>
                            </div>
                            @if (ExamenCardioExpanded)
                            {
                                <div class="expandable-content">
                                    <div class="form-row">
                                        <div class="form-group full-width">
                                            <label class="form-label">Observații</label>
                                            <textarea class="form-textarea" rows="2" @bind="Model.ExamenCardiovascular"
                                                      placeholder="Zgomote cardiace ritmice, bine bătute..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-microscope"></i>
                            Investigații Paraclinice
                        </h3>

                        <div class="form-row">
                            <div class="form-group full-width">
                                <label class="form-label">Alte investigații (EKG, EEG, etc.)</label>
                                <textarea class="form-textarea" rows="2" placeholder="Alte investigații complementare..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            }

            @* TAB 3: DIAGNOSTIC & TRATAMENT *@
            @if (ActiveTabIndex == 2)
            {
                <div class="tab-panel active">
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-search"></i>
                            Căutare Cod ICD-10
                        </h3>
                        <div class="icd-search-container">
                            <i class="fas fa-search icd-search-icon"></i>
                            <input type="text" class="icd-search-input" placeholder="Căutați după cod sau denumire (ex: I10, Hipertensiune)" />
                        </div>

                        <h3 class="section-title" style="margin-top: 20px;">
                            <i class="fas fa-diagnoses"></i>
                            Diagnostice Stabilite
                        </h3>

                        <div class="diagnosis-cards">
                            @for (int i = 0; i < DiagnosticCards.Count; i++)
                            {
                                var index = i;
                                var card = DiagnosticCards[i];

                                <div class="diagnosis-card">
                                    <div class="diagnosis-card-header">
                                        <span class="diagnosis-type @(card.IsPrincipal ? "principal" : "secundar")">
                                            @(card.IsPrincipal ? "Principal" : "Secundar")
                                        </span>
                                        <div class="diagnosis-info">
                                            <input type="text" class="diagnosis-code-input"
                                                   @bind="card.CodICD10" placeholder="Cod" />
                                            <input type="text" class="diagnosis-name-input"
                                                   @bind="card.Denumire" placeholder="Denumire diagnostic" />
                                        </div>
                                        <div class="diagnosis-actions">
                                            @if (DiagnosticCards.Count > 1)
                                            {
                                                <button class="btn-icon" @onclick="@(async () => await RemoveDiagnostic(index))">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            }
                                        </div>
                                    </div>
                                    <div class="diagnosis-card-body">
                                        <div class="diagnosis-details-label">Detalii diagnostic</div>
                                        <textarea class="diagnosis-details-textarea" placeholder="Descrieți detaliat diagnosticul..."></textarea>
                                    </div>
                                </div>
                            }

                            <button class="add-btn" @onclick="@(async () => await AddDiagnostic())">
                                <i class="fas fa-plus"></i> Adaugă diagnostic
                            </button>
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-pills"></i>
                            Prescripție Medicamentoasă
                        </h3>

                        @* Allergy Alert *@
                        <div class="allergy-alert @(ShowAllergyAlert ? "active" : "")">
                            <div class="allergy-alert-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="allergy-alert-content">
                                <div class="allergy-alert-title">⚠️ Atenție - Alergie cunoscută!</div>
                                <div class="allergy-alert-message">@AllergyMessage</div>
                            </div>
                            <button class="allergy-alert-close" @onclick="@(() => ShowAllergyAlert = false)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <table class="medication-table">
                            <thead>
                                <tr>
                                    <th style="width:28%">Medicament</th>
                                    <th style="width:12%">Doză</th>
                                    <th style="width:20%">Frecvență</th>
                                    <th style="width:12%">Durată</th>
                                    <th style="width:12%">Cantitate</th>
                                    <th style="width:8%"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (int i = 0; i < MedicationRows.Count; i++)
                                {
                                    var index = i;
                                    var row = MedicationRows[i];

                                    <tr>
                                        <td>
                                            <div class="med-name-cell">
                                                <span class="med-icon"><i class="fas fa-capsules"></i></span>
                                                <input type="text" class="form-input @GetAllergyMatchClass(row.Nume)"
                                                       @bind="row.Nume" @oninput="@((e) => CheckAllergyMatch(index, e.Value?.ToString()))"
                                                       placeholder="Medicament" />
                                            </div>
                                        </td>
                                        <td>
                                            <input type="text" class="form-input"
                                                   @bind="row.Doza" placeholder="Doză" />
                                        </td>
                                        <td>
                                            <select class="form-select" @bind="row.Frecventa">
                                                <option value="">Selectează...</option>
                                                <option value="1x/zi dimineața">1x/zi dimineața</option>
                                                <option value="1x/zi seara">1x/zi seara</option>
                                                <option value="2x/zi">2x/zi</option>
                                                <option value="3x/zi">3x/zi</option>
                                            </select>
                                        </td>
                                        <td>
                                            <input type="text" class="form-input"
                                                   @bind="row.Durata" placeholder="Durată" />
                                        </td>
                                        <td>
                                            <input type="text" class="form-input" placeholder="Cantitate" />
                                        </td>
                                        <td>
                                            @if (MedicationRows.Count > 1)
                                            {
                                                <button class="btn-icon" @onclick="@(async () => await RemoveMedication(index))">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>

                        <button class="add-btn" style="margin-top: 12px;" @onclick="@(async () => await AddMedication())">
                            <i class="fas fa-plus"></i> Adaugă medicament
                        </button>
                    </div>

                    <div class="section-divider"></div>

                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-notes-medical"></i>
                            Tratament Non-farmacologic
                        </h3>

                        <div class="form-row">
                            <div class="form-group full-width">
                                <label class="form-label">Recomandări igieno-dietetice</label>
                                <textarea class="form-textarea" placeholder="Regim alimentar, activitate fizică, modificări stil de viață..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            }

            @* TAB 4: CONCLUZII *@
            @if (ActiveTabIndex == 3)
            {
                <div class="tab-panel active">
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-clipboard-check"></i>
                            Recomandări
                        </h3>

                        <div class="form-row">
                            <div class="form-group full-width">
                                <label class="form-label">Recomandări pentru pacient</label>
                                <textarea class="form-textarea" style="min-height: 140px;" @bind="Model.InvestigatiiRecomandate"
                                          placeholder="1. Monitorizare TA de 2x/zi&#10;2. Regim hiposodat&#10;3. Activitate fizică regulată"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-calendar-check"></i>
                            Control și Monitorizare
                        </h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Data programată control</label>
                                <input type="date" class="form-input" @bind="DataUrmatoareiProgramariDate" />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Investigații la control</label>
                                <input type="text" class="form-input" placeholder="ex: Profil lipidic, HbA1c, EKG" />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group full-width">
                                <label class="form-label">Observații finale</label>
                                <textarea class="form-textarea" rows="3" placeholder="Notițe suplimentare..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-file-signature"></i>
                            Semnătură și Validare
                        </h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Data consultației</label>
                                <input type="date" class="form-input" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Medic curant</label>
                                <input type="text" class="form-input" value="Dr. [Nume Medic]" readonly style="background:#f1f5f9;" />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cod Parafă</label>
                                <input type="text" class="form-input" value="DR001234" readonly style="background:#f1f5f9;" />
                            </div>
                        </div>
                    </div>
                </div>
            }

            @* ===== FOOTER NAVIGATION ===== *@
            <div class="form-footer">
                <div class="footer-left">
                    <span class="autosave-indicator">
                        @if (DraftLastSaved.HasValue)
                        {
                            <i class="fas fa-check-circle"></i>
                            <text>Salvat automat la @DraftLastSaved.Value.ToString("HH:mm")</text>
                        }
                        else
                        {
                            <i class="fas fa-info-circle"></i>
                            <text>Nesalvat</text>
                        }
                    </span>
                </div>
                <div class="footer-right">
                    @if (ActiveTabIndex > 0)
                    {
                        <button class="btn btn-outline" @onclick="GoToPreviousTab">
                            <i class="fas fa-arrow-left"></i> Înapoi
                        </button>
                    }

                    <button class="btn btn-outline" @onclick="SaveDraft" disabled="@IsSaving">
                        <i class="fas fa-save"></i> Salvează Draft
                    </button>

                    @if (ActiveTabIndex < 3)
                    {
                        <button class="btn btn-success" @onclick="GoToNextTab">
                            <i class="fas fa-arrow-right"></i> Continuă
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-success" @onclick="SaveConsultation" disabled="@IsSaving">
                            <i class="fas fa-check"></i> Finalizează
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@* Toast Container *@
<div class="toast-container" id="toastContainer"></div>

@* Loading Overlay *@
<div class="loading-overlay @(IsSaving ? "active" : "")" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Se salvează...</div>
</div>
