@page "/consultatii"
@rendermode InteractiveServer
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using ValyanClinic.Components.Shared
@using ValyanClinic.Components.Shared.Consultatie
@using ValyanClinic.Components.Shared.Consultatie.Tabs
@using ValyanClinic.Components.Shared.Documents
@using Syncfusion.Blazor.RichTextEditor

<PageTitle>Consultație Medicală - ValyanClinic</PageTitle>

<!-- ✅ ADDED: Toast Notifications Container -->
<ToastContainer />

<!-- ✅ ADDED: Loading Overlay -->
<LoadingOverlay IsVisible="@IsLoading" Message="Se încarcă datele pacientului..." />

<div class="consultatii-container" @onkeydown="HandleKeyDown" tabindex="0">
    <!-- Page Header - Template Design -->
    <header class="page-header">
        <div class="page-title">
            <h2>@(IsEditMode ? "Editare Consultație" : "Consultație Nouă")</h2>
            <p>@(PacientData?.NumeComplet ?? "Completează fișa de consultație pentru pacient")</p>
        </div>
        <div class="header-actions">
            <!-- ✅ REFACTORED: Isolated timer component - no full page re-render -->
            <div class="timer-wrapper" @onclick="ToggleTimerPause" 
                 title="@(IsTimerPaused ? "Click pentru a continua (Ctrl+P)" : "Click pentru pauză (Ctrl+P)")">
                <ConsultationTimer />
            </div>
            
            <!-- ✅ NEW: Progress indicator -->
            <div class="progress-indicator" title="Progres completare: @ProgressPercentage%">
                <div class="progress-bar-mini">
                    <div class="progress-fill" style="width: @ProgressPercentage%"></div>
                </div>
                <span class="progress-text">@ProgressPercentage%</span>
            </div>

            <button class="btn btn-outline" @onclick="HandleSaveDraft" disabled="@IsSaving" title="Salvează Draft (Ctrl+S)">
                <i class="fas fa-save"></i>
                <span class="btn-text">Salvează Draft</span>
            </button>
            <button class="btn btn-primary" @onclick="HandleGenerateLetter" title="Generează Scrisoare Medicală">
                <i class="fas fa-file-medical"></i>
                <span class="btn-text">Generează Scrisoare</span>
            </button>
            
            <!-- ✅ NEW: Keyboard shortcuts help -->
            <button class="btn btn-icon btn-help" @onclick="ShowKeyboardShortcuts" title="Shortcut-uri tastatură (?)">
                <i class="fas fa-keyboard"></i>
            </button>
        </div>
    </header>

    <!-- ✅ NEW: Keyboard Shortcuts Modal/Tooltip -->
    @if (ShowShortcutsModal)
    {
        <div class="shortcuts-overlay" @onclick="() => ShowShortcutsModal = false">
            <div class="shortcuts-modal" @onclick:stopPropagation>
                <h4><i class="fas fa-keyboard"></i> Shortcut-uri Tastatură</h4>
                <div class="shortcuts-list">
                    <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>S</kbd> <span>Salvează Draft</span></div>
                    <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>Enter</kbd> <span>Finalizează</span></div>
                    <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>←</kbd> <span>Tab Anterior</span></div>
                    <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>→</kbd> <span>Tab Următor</span></div>
                    <div class="shortcut-item"><kbd>Alt</kbd> + <kbd>1-4</kbd> <span>Salt la Tab</span></div>
                    <div class="shortcut-item"><kbd>Ctrl</kbd> + <kbd>P</kbd> <span>Pauză Timer</span></div>
                </div>
                <button class="btn btn-sm btn-secondary" @onclick="() => ShowShortcutsModal = false">Închide</button>
            </div>
        </div>
    }

    @if (IsLoading)
    {
        <div class="loading-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Se încarcă...</span>
            </div>
            <p>Se încarcă datele pacientului...</p>
        </div>
    }
    else if (HasError)
    {
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            @ErrorMessage
        </div>
    }
    else
    {
        <!-- Patient Card - Template Design (Horizontal Layout) -->
        <section class="patient-card">
            <div class="patient-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="patient-details">
                <h3 class="patient-name">@PacientData?.NumeComplet</h3>
                <div class="patient-meta">
                    <span class="patient-meta-item">
                        <i class="fas fa-id-card"></i>
                        CNP: @PacientData?.CNP
                    </span>
                    <span class="patient-meta-item">
                        <i class="fas fa-birthday-cake"></i>
                        @PacientData?.Varsta ani
                    </span>
                    <span class="patient-meta-item">
                        <i class="fas fa-@(PacientData?.Sex == "M" ? "mars" : "venus")"></i>
                        @(PacientData?.Sex == "M" ? "Masculin" : "Feminin")
                    </span>
                    <span class="patient-meta-item">
                        <i class="fas fa-phone"></i>
                        @(PacientData?.Telefon ?? "N/A")
                    </span>
                </div>
            </div>
            @if (HasAllergies || HasConditions)
            {
                <div class="patient-tags">
                    @if (HasAllergies)
                    {
                        <span class="tag tag-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            Alergie @AllergiesText
                        </span>
                    }
                    @if (HasConditions)
                    {
                        <span class="tag tag-info">
                            <i class="fas fa-heartbeat"></i>
                            @ConditionsText
                        </span>
                    }
                </div>
            }
        </section>

        <!-- Tabs Container - Template Design -->
        <div class="tabs-container">
            <!-- ✅ UPDATED: Tabs Header with Progress and Keyboard hints -->
            <div class="tabs-header">
                <button class="tab-btn @(ActiveTab == 1 ? "active" : "") @(IsTabCompleted(1) ? "completed" : "")"
                        @onclick="() => SwitchTab(1)"
                        title="Anamneză (Alt+1)">
                    <i class="fas fa-comment-medical"></i>
                    <span>Anamneză</span>
                    <span class="tab-number">1</span>
                    @if (IsTabCompleted(1))
                    {
                        <i class="fas fa-check tab-check"></i>
                    }
                </button>
                <button class="tab-btn @(ActiveTab == 2 ? "active" : "") @(IsTabCompleted(2) ? "completed" : "")"
                        @onclick="() => SwitchTab(2)"
                        title="Examen Clinic (Alt+2)">
                    <i class="fas fa-stethoscope"></i>
                    <span>Examen Clinic</span>
                    <span class="tab-number">2</span>
                    @if (IsTabCompleted(2))
                    {
                        <i class="fas fa-check tab-check"></i>
                    }
                </button>
                <button class="tab-btn @(ActiveTab == 3 ? "active" : "") @(IsTabCompleted(3) ? "completed" : "")"
                        @onclick="() => SwitchTab(3)"
                        title="Analize Medicale (Alt+3)">
                    <i class="fas fa-flask"></i>
                    <span>Analize Medicale</span>
                    <span class="tab-number">3</span>
                    @if (IsTabCompleted(3))
                    {
                        <i class="fas fa-check tab-check"></i>
                    }
                </button>
                <button class="tab-btn @(ActiveTab == 4 ? "active" : "") @(IsTabCompleted(4) ? "completed" : "")"
                        @onclick="() => SwitchTab(4)"
                        title="Diagnostic & Tratament (Alt+4)">
                    <i class="fas fa-diagnoses"></i>
                    <span>Diagnostic & Tratament</span>
                    <span class="tab-number">4</span>
                    @if (IsTabCompleted(4))
                    {
                        <i class="fas fa-check tab-check"></i>
                    }
                </button>
                <button class="tab-btn @(ActiveTab == 5 ? "active" : "") @(IsTabCompleted(5) ? "completed" : "")"
                        @onclick="() => SwitchTab(5)"
                        title="Concluzii (Alt+5)">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Concluzii</span>
                    <span class="tab-number">5</span>
                    @if (IsTabCompleted(5))
                    {
                        <i class="fas fa-check tab-check"></i>
                    }
                </button>
                
                <!-- ✅ NEW: Tab navigation arrows for mobile -->
                <div class="tab-nav-arrows">
                    <button class="btn btn-icon" @onclick="() => SwitchTab(ActiveTab - 1)" disabled="@(ActiveTab == 1)">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="btn btn-icon" @onclick="() => SwitchTab(ActiveTab + 1)" disabled="@(ActiveTab == TotalTabs)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Tabs Content -->
            <div class="tabs-content">
                <!-- Tab 1: Anamneză (4 câmpuri în layout 2x2) -->
                <div class="tab-panel @(ActiveTab == 1 ? "active" : "")">
                    <div class="anamneza-grid">
                        <!-- Coloana Stânga -->
                        <div class="anamneza-column">
                            <div class="form-section compact">
                                <h4 class="section-title-sm">
                                    <i class="fas fa-comment-medical"></i>
                                    Motiv Prezentare
                                </h4>
                                <div class="form-group rte-container">
                                    <SfRichTextEditor @bind-Value="MotivPrezentare"
                                                      Placeholder="Descrieți motivul prezentării pacientului la consultație..."
                                                      ShowCharCount="true"
                                                      EnableResize="true">
                                        <RichTextEditorToolbarSettings Items="@RteToolbarItems" />
                                    </SfRichTextEditor>
                                </div>
                            </div>

                            <div class="form-section compact">
                                <h4 class="section-title-sm">
                                    <i class="fas fa-notes-medical"></i>
                                    Istoric Medical Personal
                                </h4>
                                <div class="form-group rte-container">
                                    <SfRichTextEditor @bind-Value="IstoricMedicalPersonal"
                                                      Placeholder="Boli anterioare, intervenții chirurgicale, alergii, tratamente cronice..."
                                                      ShowCharCount="true"
                                                      EnableResize="true">
                                        <RichTextEditorToolbarSettings Items="@RteToolbarItems" />
                                    </SfRichTextEditor>
                                </div>
                            </div>

                            <div class="form-section compact">
                                <h4 class="section-title-sm">
                                    <i class="fas fa-pills"></i>
                                    Tratament Anterior
                                </h4>
                                <div class="form-group rte-container">
                                    <SfRichTextEditor @bind-Value="TratamentAnterior"
                                                      Placeholder="Tratamente urmate anterior (medicație, proceduri, intervenții)..."
                                                      ShowCharCount="true"
                                                      EnableResize="true">
                                        <RichTextEditorToolbarSettings Items="@RteToolbarItems" />
                                    </SfRichTextEditor>
                                </div>
                            </div>
                        </div>

                        <!-- Coloana Dreapta -->
                        <div class="anamneza-column">
                            <div class="form-section compact">
                                <h4 class="section-title-sm">
                                    <i class="fas fa-history"></i>
                                    Istoricul Bolii Prezente
                                </h4>
                                <div class="form-group rte-container">
                                    <SfRichTextEditor @bind-Value="IstoricBoalaActuala"
                                                      Placeholder="Evoluția simptomelor, când au apărut, factori agravanți/amelioranți..."
                                                      ShowCharCount="true"
                                                      EnableResize="true">
                                        <RichTextEditorToolbarSettings Items="@RteToolbarItems" />
                                    </SfRichTextEditor>
                                </div>
                            </div>

                            <div class="form-section compact">
                                <h4 class="section-title-sm">
                                    <i class="fas fa-users"></i>
                                    Istoric Familial
                                </h4>
                                <div class="form-group rte-container">
                                    <SfRichTextEditor @bind-Value="IstoricFamilial"
                                                      Placeholder="Boli ereditare în familie (diabet, HTA, boli cardiace, cancer, etc.)..."
                                                      ShowCharCount="true"
                                                      EnableResize="true">
                                        <RichTextEditorToolbarSettings Items="@RteToolbarItems" />
                                    </SfRichTextEditor>
                                </div>
                            </div>

                            <div class="form-section compact">
                                <h4 class="section-title-sm">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Factori de Risc
                                </h4>
                                <div class="form-group rte-container">
                                    <SfRichTextEditor @bind-Value="FactoriDeRisc"
                                                      Placeholder="Factori de risc identificați (HTA, diabet, fumat, sedentarism, obezitate, etc.)..."
                                                      ShowCharCount="true"
                                                      EnableResize="true">
                                        <RichTextEditorToolbarSettings Items="@RteToolbarItems" />
                                    </SfRichTextEditor>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 2: Examen Clinic & Investigații - Template Design -->
                <div class="tab-panel @(ActiveTab == 2 ? "active" : "")">
                    <!-- Examen Clinic General Grid - 12 Styled Cards -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-user-md"></i>
                            Examen Clinic General
                        </h3>
                        <div class="exam-grid">
                            <!-- Card 1: Stare Generală -->
                            <div class="exam-item">
                                <div class="exam-item-header">
                                    <div class="exam-icon"><i class="fas fa-user-check"></i></div>
                                    <div class="exam-label">Stare Generală</div>
                                </div>
                                <select class="exam-select" @bind="StareGenerala" @bind:after="MarkFormAsDirty">
                                    <option value="">Selectează...</option>
                                    <option value="Bună">Bună</option>
                                    <option value="Relativ bună">Relativ bună</option>
                                    <option value="Medie">Medie</option>
                                    <option value="Alterată">Alterată</option>
                                    <option value="Gravă">Gravă</option>
                                </select>
                            </div>

                            <!-- Card 2: Tegumente -->
                            <div class="exam-item">
                                <div class="exam-item-header">
                                    <div class="exam-icon"><i class="fas fa-hand-paper"></i></div>
                                    <div class="exam-label">Tegumente</div>
                                </div>
                                <select class="exam-select" @bind="Tegumente" @bind:after="MarkFormAsDirty">
                                    <option value="">Selectează...</option>
                                    <option value="Normale">Normale</option>
                                    <option value="Palide">Palide</option>
                                    <option value="Cianotice">Cianotice</option>
                                    <option value="Icterice">Icterice</option>
                                </select>
                            </div>

                            <!-- Card 3: Mucoase -->
                            <div class="exam-item">
                                <div class="exam-item-header">
                                    <div class="exam-icon"><i class="fas fa-eye"></i></div>
                                    <div class="exam-label">Mucoase</div>
                                </div>
                                <select class="exam-select" @bind="Mucoase" @bind:after="MarkFormAsDirty">
                                    <option value="">Selectează...</option>
                                    <option value="Roz">Roz</option>
                                    <option value="Palide">Palide</option>
                                    <option value="Cianotice">Cianotice</option>
                                    <option value="Icterice">Icterice</option>
                                </select>
                            </div>

                            <!-- Card 4: Greutate -->
                            <div class="exam-item">
                                <div class="exam-item-header">
                                    <div class="exam-icon"><i class="fas fa-weight"></i></div>
                                    <div class="exam-label">Greutate</div>
                                </div>
                                <div class="exam-input-row">
                                    <input type="number" step="0.1" class="exam-input" placeholder="70.5" 
                                           @bind="Greutate" 
                                           @bind:event="oninput" 
                                           @bind:after="MarkFormAsDirty" />
                                    <span class="exam-unit">kg</span>
                                </div>
                            </div>

                            <!-- Card 5: Înălțime -->
                            <div class="exam-item">
                                <div class="exam-item-header">
                                    <div class="exam-icon"><i class="fas fa-ruler-vertical"></i></div>
                                    <div class="exam-label">Înălțime</div>
                                </div>
                                <div class="exam-input-row">
                                    <input type="number" class="exam-input" placeholder="175" 
                                           @bind="Inaltime" 
                                           @bind:event="oninput" 
                                           @bind:after="MarkFormAsDirty" />
                                    <span class="exam-unit">cm</span>
                                </div>
                            </div>

                            <!-- Card 6: IMC (Calculated + Visual Indicator) -->
                            <div class="exam-item @(IMC.HasValue ? "has-value" : "")">
                                <div class="exam-item-header">
                                    <div class="exam-icon"><i class="fas fa-calculator"></i></div>
                                    <div class="exam-label">IMC</div>
                                </div>
                                @if (IMC.HasValue)
                                {
                                    <div class="imc-result">
                                        <div class="imc-value-display @IMCCategory">
                                            @IMC.Value.ToString("F1")
                                        </div>
                                        <span class="imc-badge @IMCCategory">@IMCText</span>
                                    </div>
                                }
                                else
                                {
                                    <div class="exam-placeholder">Completați G + Î</div>
                                }
                            </div>

                            <!-- Card 7: Tensiune Arterială -->
                            <div class="exam-item">
                                <div class="exam-item-header">
                                    <div class="exam-icon"><i class="fas fa-heartbeat"></i></div>
                                    <div class="exam-label">Tensiune Arterială</div>
                                </div>
                                <div class="exam-input-row">
                                    <input type="number" class="exam-input" placeholder="120" 
                                           @bind="TensiuneSistolica" 
                                           @bind:after="MarkFormAsDirty" />
                                    <span class="exam-unit">/</span>
                                    <input type="number" class="exam-input" placeholder="80" 
                                           @bind="TensiuneDiastolica" 
                                           @bind:after="MarkFormAsDirty" />
                                    <span class="exam-unit">mmHg</span>
                                </div>
                            </div>

                            <!-- Card 8: Frecvență Cardiacă -->
                            <div class="exam-item">
                                <div class="exam-item-header">
                                    <div class="exam-icon"><i class="fas fa-heart"></i></div>
                                    <div class="exam-label">Frecvență Cardiacă</div>
                                </div>
                                <div class="exam-input-row">
                                    <input type="number" class="exam-input" placeholder="75" 
                                           @bind="Puls" 
                                           @bind:after="MarkFormAsDirty" />
                                    <span class="exam-unit">bpm</span>
                                </div>
                            </div>

                            <!-- Card 9: Frecvență Respiratorie -->
                            <div class="exam-item">
                                <div class="exam-item-header">
                                    <div class="exam-icon"><i class="fas fa-lungs"></i></div>
                                    <div class="exam-label">Frecvență Respiratorie</div>
                                </div>
                                <div class="exam-input-row">
                                    <input type="number" class="exam-input" placeholder="16" 
                                           @bind="FreqventaRespiratorie" 
                                           @bind:after="MarkFormAsDirty" />
                                    <span class="exam-unit">resp/min</span>
                                </div>
                            </div>

                            <!-- Card 10: Temperatură -->
                            <div class="exam-item">
                                <div class="exam-item-header">
                                    <div class="exam-icon"><i class="fas fa-thermometer-half"></i></div>
                                    <div class="exam-label">Temperatură</div>
                                </div>
                                <div class="exam-input-row">
                                    <input type="number" step="0.1" class="exam-input" placeholder="36.5" 
                                           @bind="Temperatura" 
                                           @bind:after="MarkFormAsDirty" />
                                    <span class="exam-unit">°C</span>
                                </div>
                            </div>

                            <!-- Card 11: SpO₂ (Saturație Oxigen) -->
                            <div class="exam-item">
                                <div class="exam-item-header">
                                    <div class="exam-icon"><i class="fas fa-wind"></i></div>
                                    <div class="exam-label">SpO₂</div>
                                </div>
                                <div class="exam-input-row">
                                    <input type="number" class="exam-input" placeholder="98" 
                                           @bind="SpO2" 
                                           @bind:after="MarkFormAsDirty" />
                                    <span class="exam-unit">%</span>
                                </div>
                            </div>

                            <!-- Card 12: Edeme -->
                            <div class="exam-item">
                                <div class="exam-item-header">
                                    <div class="exam-icon"><i class="fas fa-hand-holding-water"></i></div>
                                    <div class="exam-label">Edeme</div>
                                </div>
                                <select class="exam-select" @bind="Edeme" @bind:after="MarkFormAsDirty">
                                    <option value="">Selectează...</option>
                                    <option value="Absente">Absente</option>
                                    <option value="Ușoare">Ușoare</option>
                                    <option value="Moderate">Moderate</option>
                                    <option value="Severe">Severe</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Examen Obiectiv Detaliat -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-stethoscope"></i>
                            Examen Obiectiv Detaliat
                        </h3>
                        <div class="form-group">
                            <textarea class="form-control"
                                      rows="5"
                                      placeholder="Aspect general, examen pe aparate și sisteme..."
                                      maxlength="2000"
                                      @bind="ExamenObiectiv"
                                      @bind:event="oninput"
                                      @bind:after="MarkFormAsDirty"></textarea>
                            <span class="char-counter">@ExamenObiectiv.Length / 2000</span>
                        </div>
                    </div>

                    <!-- Alte Observații Examen Clinic -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-notes-medical"></i>
                            Alte Observații Clinice
                        </h3>
                        <div class="form-group">
                            <textarea class="form-control"
                                      rows="3"
                                      placeholder="Alte observații relevante din examenul clinic..."
                                      maxlength="1000"
                                      @bind="InvestigatiiParaclinice"
                                      @bind:event="oninput"
                                      @bind:after="MarkFormAsDirty"></textarea>
                            <span class="char-counter">@InvestigatiiParaclinice.Length / 1000</span>
                        </div>
                    </div>
                </div>

                <!-- Tab 3: Analize Medicale -->
                <div class="tab-panel @(ActiveTab == 3 ? "active" : "")">
                    <AnalizeMedicaleTab 
                        ConsultatieId="@ConsultatieId"
                        CurrentUserId="@CurrentMedicId"
                        OnChanged="@MarkFormAsDirty"
                        OnSectionCompleted="@(() => MarkTabAsCompleted(3))" />
                </div>

                <!-- Tab 4: Diagnostic & Tratament -->
                <div class="tab-panel @(ActiveTab == 4 ? "active" : "")">
                    <DiagnosticTab Model="@ConsultatieCommand"
                        ShowValidation="@ShowValidationErrors"
                        CurrentUserId="@CurrentMedicId"
                        OnChanged="@MarkFormAsDirty"
                        OnSectionCompleted="@(() => MarkTabAsCompleted(4))" />
                </div>

                <!-- Tab 5: Concluzii -->
                <div class="tab-panel @(ActiveTab == 5 ? "active" : "")">
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-file-medical"></i>
                            Concluzii
                        </h3>
                        <div class="form-group">
                            <label class="form-label">Rezumat consultație</label>
                            <textarea class="form-control"
                                      rows="6"
                                      placeholder="Rezumat general al consultației..."
                                      maxlength="2000"
                                      @bind="Concluzii"
                                      @bind:event="oninput"
                                      @bind:after="MarkFormAsDirty"></textarea>
                            <span class="char-counter">@Concluzii.Length / 2000</span>
                        </div>
                    </div>

                    <!-- Secțiune: Informații Scrisoare Medicală (Anexa 43) - Design Elegant -->
                    <div class="form-section scrisoare-medicala-section">
                        <h3 class="section-title">
                            <i class="fas fa-file-prescription"></i>
                            Informații Scrisoare Medicală
                            <span class="section-subtitle">Anexa 43 - Ordin MS nr. 1411/2016</span>
                        </h3>
                        
                        <div class="medical-options-grid">
                            <!-- Card: Afecțiune Oncologică -->
                            <div class="medical-option-card @(EsteAfectiuneOncologica ? "active warning" : "")">
                                <label class="option-card-content" for="chkAfectiuneOncologica">
                                    <div class="option-icon warning">
                                        <i class="fas fa-ribbon"></i>
                                    </div>
                                    <div class="option-details">
                                        <span class="option-title">Afecțiune Oncologică</span>
                                        <span class="option-description">Pacientul prezintă afecțiune oncologică</span>
                                    </div>
                                    <div class="option-toggle">
                                        <input type="checkbox" class="toggle-checkbox" id="chkAfectiuneOncologica"
                                               @bind="EsteAfectiuneOncologica" @bind:after="MarkFormAsDirty" />
                                        <span class="toggle-slider"></span>
                                    </div>
                                </label>
                            </div>

                            <!-- Card: Indicație Internare -->
                            <div class="medical-option-card @(AreIndicatieInternare ? "active info" : "")">
                                <label class="option-card-content" for="chkIndicatieInternare">
                                    <div class="option-icon info">
                                        <i class="fas fa-hospital"></i>
                                    </div>
                                    <div class="option-details">
                                        <span class="option-title">Indicație Internare</span>
                                        <span class="option-description">Recomandare pentru internare în spital</span>
                                    </div>
                                    <div class="option-toggle">
                                        <input type="checkbox" class="toggle-checkbox" id="chkIndicatieInternare"
                                               @bind="AreIndicatieInternare" @bind:after="MarkFormAsDirty" />
                                        <span class="toggle-slider"></span>
                                    </div>
                                </label>
                            </div>

                            <!-- Card: Prescripție Medicală -->
                            <div class="medical-option-card expandable @(SaEliberatPrescriptie ? "active primary expanded" : "")">
                                <label class="option-card-content" for="chkPrescriptie">
                                    <div class="option-icon primary">
                                        <i class="fas fa-prescription"></i>
                                    </div>
                                    <div class="option-details">
                                        <span class="option-title">Prescripție Medicală</span>
                                        <span class="option-description">S-a eliberat rețetă medicală</span>
                                    </div>
                                    <div class="option-toggle">
                                        <input type="checkbox" class="toggle-checkbox" id="chkPrescriptie"
                                               @bind="SaEliberatPrescriptie" @bind:after="MarkFormAsDirty" />
                                        <span class="toggle-slider"></span>
                                    </div>
                                </label>
                                @if (SaEliberatPrescriptie)
                                {
                                    <div class="option-expanded-content">
                                        <div class="expanded-input-group">
                                            <i class="fas fa-hashtag"></i>
                                            <input type="text" class="expanded-input" 
                                                   placeholder="Serie / Număr prescripție..."
                                                   @bind="SeriePrescriptie" @bind:after="MarkFormAsDirty" />
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- Card: Concediu Medical -->
                            <div class="medical-option-card expandable @(SaEliberatConcediuMedical ? "active secondary expanded" : "")">
                                <label class="option-card-content" for="chkConcediu">
                                    <div class="option-icon secondary">
                                        <i class="fas fa-bed"></i>
                                    </div>
                                    <div class="option-details">
                                        <span class="option-title">Concediu Medical</span>
                                        <span class="option-description">S-a eliberat certificat de concediu medical</span>
                                    </div>
                                    <div class="option-toggle">
                                        <input type="checkbox" class="toggle-checkbox" id="chkConcediu"
                                               @bind="SaEliberatConcediuMedical" @bind:after="MarkFormAsDirty" />
                                        <span class="toggle-slider"></span>
                                    </div>
                                </label>
                                @if (SaEliberatConcediuMedical)
                                {
                                    <div class="option-expanded-content">
                                        <div class="expanded-input-group">
                                            <i class="fas fa-hashtag"></i>
                                            <input type="text" class="expanded-input" 
                                                   placeholder="Serie / Număr concediu medical..."
                                                   @bind="SerieConcediuMedical" @bind:after="MarkFormAsDirty" />
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- Card: Îngrijiri la Domiciliu -->
                            <div class="medical-option-card @(SaEliberatIngrijiriDomiciliu ? "active success" : "")">
                                <label class="option-card-content" for="chkIngrijiri">
                                    <div class="option-icon success">
                                        <i class="fas fa-home"></i>
                                    </div>
                                    <div class="option-details">
                                        <span class="option-title">Îngrijiri la Domiciliu</span>
                                        <span class="option-description">Recomandare pentru îngrijiri medicale la domiciliu</span>
                                    </div>
                                    <div class="option-toggle">
                                        <input type="checkbox" class="toggle-checkbox" id="chkIngrijiri"
                                               @bind="SaEliberatIngrijiriDomiciliu" @bind:after="MarkFormAsDirty" />
                                        <span class="toggle-slider"></span>
                                    </div>
                                </label>
                            </div>

                            <!-- Card: Dispozitive Medicale -->
                            <div class="medical-option-card @(SaEliberatDispozitiveMedicale ? "active info" : "")">
                                <label class="option-card-content" for="chkDispozitive">
                                    <div class="option-icon info">
                                        <i class="fas fa-wheelchair"></i>
                                    </div>
                                    <div class="option-details">
                                        <span class="option-title">Dispozitive Medicale</span>
                                        <span class="option-description">Recomandare pentru dispozitive medicale</span>
                                    </div>
                                    <div class="option-toggle">
                                        <input type="checkbox" class="toggle-checkbox" id="chkDispozitive"
                                               @bind="SaEliberatDispozitiveMedicale" @bind:after="MarkFormAsDirty" />
                                        <span class="toggle-slider"></span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Secțiune separată pentru Transmitere Email -->
                        <div class="email-transmission-section @(TransmiterePrinEmail ? "active" : "")">
                            <div class="email-header">
                                <label class="email-toggle-label" for="chkEmail">
                                    <div class="email-icon">
                                        <i class="fas fa-envelope"></i>
                                    </div>
                                    <div class="email-text">
                                        <span class="email-title">Transmitere prin Email</span>
                                        <span class="email-description">Trimite scrisoarea medicală pe email către pacient</span>
                                    </div>
                                    <div class="option-toggle">
                                        <input type="checkbox" class="toggle-checkbox" id="chkEmail"
                                               @bind="TransmiterePrinEmail" @bind:after="MarkFormAsDirty" />
                                        <span class="toggle-slider"></span>
                                    </div>
                                </label>
                            </div>
                            @if (TransmiterePrinEmail)
                            {
                                <div class="email-input-section">
                                    <div class="email-input-wrapper">
                                        <i class="fas fa-at"></i>
                                        <input type="email" class="email-input" 
                                               placeholder="exemplu@email.com"
                                               @bind="EmailTransmitere" @bind:after="MarkFormAsDirty" />
                                        <button type="button" class="btn-copy-email" title="Copiază din datele pacientului">
                                            <i class="fas fa-user-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-calendar-check"></i>
                            Planificare Următoare
                        </h3>
                        <div class="form-group">
                            <label class="form-label">Data următoarei vizite</label>
                            <input type="date" class="form-control" 
                                   @bind="DataUrmatoareiVizite" 
                                   @bind:after="MarkFormAsDirty" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Note pentru vizita următoare</label>
                            <textarea class="form-control"
                                      rows="3"
                                      placeholder="Investigații suplimentare, controale..."
                                      maxlength="1000"
                                      @bind="NoteUrmatoareaVizita"
                                      @bind:event="oninput"
                                      @bind:after="MarkFormAsDirty"></textarea>
                            <span class="char-counter">@NoteUrmatoareaVizita.Length / 1000</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ✅ UPDATED: Footer Actions with better layout -->
        <div class="consultation-footer">
            <div class="footer-info">
                @if (IsSaving)
                {
                    <span class="save-indicator saving">
                        <i class="fas fa-spinner fa-spin"></i>
                        Se salvează...
                    </span>
                }
                else if (LastSaveTime.HasValue)
                {
                    <span class="save-indicator saved">
                        <i class="fas fa-check-circle"></i>
                        Salvat la @LastSaveTime.Value.ToString("HH:mm")
                    </span>
                }
                else if (HasUnsavedChanges)
                {
                    <span class="save-indicator unsaved">
                        <i class="fas fa-exclamation-circle"></i>
                        Modificări nesalvate
                    </span>
                }
            </div>
            <div class="footer-actions">
                <button class="btn btn-secondary" @onclick="HandleSaveDraft" disabled="@IsSaving" title="Ctrl+S">
                    <i class="fas fa-save"></i>
                    Salvează Ciornă
                </button>
                <button class="btn btn-primary btn-finalize" @onclick="HandleFinalize" disabled="@IsSaving" title="Ctrl+Enter">
                    <i class="fas fa-check-double"></i>
                    Finalizează Consultație
                </button>
            </div>
        </div>
    }
</div>

<!-- Scrisoare Medicală Preview Modal -->
<ScrisoareMedicalaPreview IsVisible="@ShowScrisoarePreview"
                          OnClose="CloseScrisoarePreview"
                          UseMockData="true" />
