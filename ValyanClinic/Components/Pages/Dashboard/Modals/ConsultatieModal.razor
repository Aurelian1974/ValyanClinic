@using ValyanClinic.Application.Features.ConsultatieManagement.Commands.CreateConsultatie
@using ValyanClinic.Application.Features.PacientManagement.Queries.GetPacientById
@using ValyanClinic.Application.Features.ProgramareManagement.DTOs
@using ValyanClinic.Components.Shared
@using ValyanClinic.Components.Shared.Medical
@using ValyanClinic.Components.Shared.Consultatie
@using ValyanClinic.Components.Shared.Consultatie.Tabs

<div class="modal-overlay @(IsVisible ? "visible" : "")" @onclick="HandleOverlayClick">
    <div class="modal-container consultatie-modal @(IsVisible ? "show" : "")" @onclick:stopPropagation>
            
            @* Componenta Header *@
            <ConsultatieHeader PacientInfo="@PacientInfo"
                              IsLoading="@IsLoadingPacient"
                              LastSaveTime="@LastSaveTime"
                              ShowDraftInfo="true"
                              OnClose="CloseModal" />

            <!-- MODAL BODY -->
            <div class="modal-body">
                <EditForm Model="@Model" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />

                    @* Componenta Progress *@
                    <ConsultatieProgress Sections="@Sections"
                                        CompletedSections="@CompletedSections"
                                        ActiveSection="@CurrentSection" />

                    @* Componenta Tabs *@
                    <ConsultatieTabs Tabs="@Sections"
                                    ActiveTab="@ActiveTab"
                                    CompletedTabs="@CompletedSections"
                                    OnTabChanged="HandleTabChanged"
                                    IsDisabled="@IsSaving" />

                    <!-- TAB CONTENT -->
                    <div class="tab-content consultatie-content">

                        @* Tab 1: Motive Prezentare *@
                        @if (ActiveTab == "motive")
                        {
                            <MotivePrezentareTab Model="@Model"
                                                OnChanged="MarkAsChanged"
                                                OnSectionCompleted="() => MarkSectionCompleted(ActiveTab)"
                                                ShowValidation="false" />
                        }

                        @* Tab 2: Antecedente - FOLOSEȘTE COMPONENTA NOUĂ *@
                        @if (ActiveTab == "antecedente")
                        {
                            <AntecedenteTab Model="@Model"
                                           PacientSex="@PacientInfo?.Sex"
                                           IsActive="true"
                                           OnChanged="MarkAsChanged"
                                           OnSectionCompleted="() => MarkSectionCompleted(ActiveTab)"
                                           ShowValidation="false" />
                        }

                        @* Tab 3: Examen Obiectiv *@
                        @if (ActiveTab == "examen")
                        {
                            <ExamenTab Model="@Model"
                                      OnChanged="MarkAsChanged"
                                      OnSectionCompleted="() => MarkSectionCompleted(ActiveTab)"
                                      ShowValidation="false" />
                        }

                        @* Tab 4: Investigații - FOLOSEȘTE COMPONENTA NOUĂ *@
                        @if (ActiveTab == "investigatii")
                        {
                            <InvestigatiiTab Model="@Model"
                                            IsActive="true"
                                            OnChanged="MarkAsChanged"
                                            OnSectionCompleted="() => MarkSectionCompleted(ActiveTab)"
                                            ShowValidation="false" />
                        }

                        @* Tab 5: Diagnostic *@
                        @if (ActiveTab == "diagnostic")
                        {
                            <DiagnosticTab Model="@Model"
                                          OnChanged="MarkAsChanged"
                                          OnSectionCompleted="() => MarkSectionCompleted(ActiveTab)"
                                          ShowValidation="false" />
                        }

                        @* Tab 6: Tratament - FOLOSEȘTE COMPONENTA NOUĂ *@
                        @if (ActiveTab == "tratament")
                        {
                            <TratamentTab Model="@Model"
                                         IsActive="true"
                                         OnChanged="MarkAsChanged"
                                         OnSectionCompleted="() => MarkSectionCompleted(ActiveTab)"
                                         ShowValidation="false" />
                        }

                        @* Tab 7: Concluzie - FOLOSEȘTE COMPONENTA NOUĂ *@
                        @if (ActiveTab == "concluzie")
                        {
                            <ConcluzieTab Model="@Model"
                                         IsActive="true"
                                         OnChanged="MarkAsChanged"
                                         OnSectionCompleted="() => MarkSectionCompleted(ActiveTab)"
                                         OnPreview="PreviewScrisoare"
                                         ShowValidation="false" />
                        }
                    </div>

                    <!-- MODAL FOOTER -->
                    @* Componenta Footer *@
                    <ConsultatieFooter IsSaving="@IsSaving"
                                      IsSavingDraft="@IsSavingDraft"
                                      ShowDraftButton="true"
                                      ShowPreviewButton="true"
                                      SaveButtonText="Finalizează Consultație"
                                      OnSaveDraft="SaveDraft"
                                      OnPreview="PreviewScrisoare"
                                      OnCancel="CloseModal" />
                </EditForm>
            </div>
    </div>
</div>

@if (IsVisible)
{
    <div class="modal-backdrop fade show"></div>
}
