@page "/test-email"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@rendermode InteractiveServer
@inject IJSRuntime JSRuntime

<PageTitle>Email Testing Suite - ValyanClinic</PageTitle>

<div class="email-test-page">
    <!-- Header with Stats -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-icon">
                <i class="fas fa-paper-plane"></i>
            </div>
            <div class="header-text">
                <h1>Email Testing Suite</h1>
                <p>Test și preview pentru email-uri profesionale</p>
            </div>
        </div>
        <div class="stats-dashboard">
            <div class="stat-box">
                <div class="stat-value">@EmailsSentToday</div>
                <div class="stat-label">Trimise azi</div>
            </div>
            <div class="stat-box stat-success">
                <div class="stat-value">@SuccessRate%</div>
                <div class="stat-label">Success rate</div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="content-grid">
        <!-- Left: Email Composer -->
        <div class="composer-card">
            <div class="card-header">
                <h3><i class="fas fa-edit"></i> Compune Email</h3>
            </div>
            <div class="card-body">
                <!-- Template Selector -->
                <div class="form-group">
                    <label>
                        <i class="fas fa-layer-group"></i>
                        Selectează Template
                        <span class="badge">@Templates.Count</span>
                    </label>
                    <div class="template-actions">
                        <button class="btn-new-template" @onclick="OpenTemplateManager">
                            <i class="fas fa-cog"></i>
                            <span>Gestionează Template-uri</span>
                        </button>
                    </div>
                    <div class="template-grid">
                        @foreach (var template in Templates)
                        {
                            <div class="template-card @(SelectedTemplate == template.Key ? "active" : "")"
                                 @onclick="() => SelectTemplate(template.Key)">
                                <div class="template-icon">
                                    <i class="@template.Value.Icon"></i>
                                </div>
                                <div class="template-info">
                                    <div class="template-name">@template.Value.Name</div>
                                    <div class="template-desc">@template.Value.Description</div>
                                </div>
                                @if (SelectedTemplate == template.Key)
                                {
                                    <i class="fas fa-check-circle template-check"></i>
                                }
                                @if (!template.Value.IsDefault)
                                {
                                    <div class="template-actions-mini">
                                        <button class="btn-edit-mini" @onclick:stopPropagation="true" @onclick="() => StartEditTemplate(template.Key)">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-delete-mini" @onclick:stopPropagation="true" @onclick="() => StartDeleteTemplate(template.Key)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>

                <!-- Email Input with Validation -->
                <div class="form-group">
                    <label>
                        <i class="fas fa-at"></i>
                        Email destinatar
                        @if (!string.IsNullOrEmpty(ValidationMessage))
                        {
                            <span class="validation-badge @(IsEmailValid ? "valid" : "invalid")">
                                <i class="fas @(IsEmailValid ? "fa-check-circle" : "fa-times-circle")"></i>
                                @ValidationMessage
                            </span>
                        }
                    </label>
                    <div class="input-with-button">
                        <input type="email" 
                               class="form-input @GetInputValidationClass()"
                               @bind="TestEmailAddress"
                               @oninput="OnEmailInput"
                               placeholder="exemplu@gmail.com" />
                        <button class="btn-icon" 
                                @onclick="UseMyEmail" 
                                disabled="@IsLoading"
                                title="Folosește email-ul meu">
                            <i class="fas fa-user"></i>
                        </button>
                    </div>
                    <small class="hint">Introdu email-ul tău pentru test</small>
                </div>

                <!-- Subject -->
                <div class="form-group">
                    <label>
                        <i class="fas fa-heading"></i>
                        Subiect
                        <span class="char-counter">@EmailSubject.Length/100</span>
                    </label>
                    <input type="text" 
                           class="form-input"
                           @bind="EmailSubject"
                           maxlength="100"
                           placeholder="Subiectul email-ului" />
                </div>

                <!-- CUSTOM MESSAGE EDITOR -->
                @if (SelectedTemplate == "custom" || (Templates.ContainsKey(SelectedTemplate) && !Templates[SelectedTemplate].IsDefault))
                {
                    <div class="form-group">
                        <label>
                            <i class="fas fa-edit"></i>
                            Mesaj personalizat
                            <div class="editor-mode-toggle">
                                <button class="mode-btn @(IsHtmlMode ? "active" : "")" 
                                        @onclick="() => ToggleEditorMode(true)"
                                        title="HTML mode">
                                    <i class="fas fa-code"></i>
                                </button>
                                <button class="mode-btn @(!IsHtmlMode ? "active" : "")" 
                                        @onclick="() => ToggleEditorMode(false)"
                                        title="Visual mode">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </label>

                        @if (IsHtmlMode)
                        {
                            <textarea class="code-editor" 
                                      @bind="CustomMessageHtml"
                                      placeholder="<h1>Scrie HTML aici...</h1>"
                                      rows="10"></textarea>
                        }
                        else
                        {
                            <div class="editor-toolbar">
                                <button class="toolbar-btn" @onclick='() => InsertFormatting("bold")' title="Bold">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button class="toolbar-btn" @onclick='() => InsertFormatting("italic")' title="Italic">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button class="toolbar-btn" @onclick='() => InsertFormatting("underline")' title="Underline">
                                    <i class="fas fa-underline"></i>
                                </button>
                                <div class="toolbar-divider"></div>
                                <button class="toolbar-btn" @onclick='() => InsertFormatting("h1")' title="Heading 1">
                                    <i class="fas fa-heading"></i>
                                </button>
                                <button class="toolbar-btn" @onclick='() => InsertFormatting("ul")' title="List">
                                    <i class="fas fa-list-ul"></i>
                                </button>
                                <button class="toolbar-btn" @onclick='() => InsertFormatting("link")' title="Link">
                                    <i class="fas fa-link"></i>
                                </button>
                                <div class="toolbar-divider"></div>
                                <button class="toolbar-btn emoji-btn" @onclick="ToggleEmojiPicker" title="Emoji">
                                    <i class="fas fa-smile"></i>
                                </button>
                            </div>

                            @if (ShowEmojiPicker)
                            {
                                <div class="emoji-picker">
                                    @foreach (var emoji in Emojis)
                                    {
                                        <button class="emoji-item" @onclick="() => InsertEmoji(emoji)">@emoji</button>
                                    }
                                </div>
                            }

                            <textarea class="rich-editor" 
                                      @bind="CustomMessageText"
                                      placeholder="Scrie mesajul tău aici..."
                                      rows="10"></textarea>
                        }
                    </div>
                }

                <!-- Alert Message -->
                @if (!string.IsNullOrEmpty(ResultMessage))
                {
                    <div class="alert @(IsSuccess ? "alert-success" : "alert-error")">
                        <i class="fas @(IsSuccess ? "fa-check-circle" : "fa-exclamation-triangle")"></i>
                        <span>@ResultMessage</span>
                        <button class="alert-close" @onclick="ClearAlert">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                }

                <!-- Send Button -->
                <button class="btn-send @(IsLoading ? "loading" : "")" 
                        @onclick="SendTestEmail"
                        disabled="@(IsLoading || !IsEmailValid || string.IsNullOrEmpty(TestEmailAddress))">
                    @if (IsLoading)
                    {
                        <span class="spinner"></span>
                        <span>Se trimite...</span>
                    }
                    else
                    {
                        <i class="fas fa-paper-plane"></i>
                        <span>Trimite Email Test</span>
                    }
                </button>
            </div>
        </div>

        <!-- Right: Live Preview -->
        <div class="preview-card">
            <div class="card-header">
                <h3><i class="fas fa-eye"></i> Preview Live</h3>
                <div class="preview-controls">
                    <button class="btn-icon-small" 
                            @onclick="ToggleDarkPreview"
                            title="@(IsDarkPreview ? "Light mode" : "Dark mode")">
                        <i class="fas @(IsDarkPreview ? "fa-sun" : "fa-moon")"></i>
                    </button>
                    <button class="btn-icon-small" 
                            @onclick="RefreshPreview"
                            title="Refresh preview">
                        <i class="fas fa-sync-alt @(IsRefreshing ? "fa-spin" : "")"></i>
                    </button>
                </div>
            </div>
            <div class="preview-wrapper @(IsDarkPreview ? "dark-mode" : "")">
                <div class="device-frame">
                    <div class="device-header">
                        <div class="device-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span class="device-title">@EmailSubject</span>
                    </div>
                    <div class="device-body">
                        @((MarkupString)GetPreviewHtml())
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Sends History -->
    @if (RecentSends.Any())
    {
        <div class="history-card">
            <div class="card-header">
                <h3>
                    <i class="fas fa-history"></i>
                    Trimiteri recente
                    <span class="badge">@RecentSends.Count</span>
                </h3>
                <button class="btn-icon-small" 
                        @onclick="ClearHistory"
                        title="Șterge istoric">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
            <div class="history-list">
                @foreach (var send in RecentSends.Take(5))
                {
                    <div class="history-item">
                        <div class="history-icon @(send.Success ? "success" : "error")">
                            <i class="fas @(send.Success ? "fa-check" : "fa-times")"></i>
                        </div>
                        <div class="history-details">
                            <div class="history-email">@send.To</div>
                            <div class="history-subject">@send.Subject</div>
                        </div>
                        <div class="history-time">
                            <i class="far fa-clock"></i>
                            @send.SentAt.ToString("HH:mm:ss")
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Back Button -->
    <div class="back-wrapper">
        <a href="/" class="btn-back">
            <i class="fas fa-arrow-left"></i>
            <span>Înapoi la Dashboard</span>
        </a>
    </div>
</div>

<!-- 🆕 TEMPLATE MANAGER MODAL -->
@if (ShowTemplateManager)
{
    <div class="modal-overlay @(ShowTemplateManager ? "visible" : "")" @onclick="CloseTemplateManager">
        <div class="modal-container @(ShowTemplateManager ? "show" : "")" @onclick:stopPropagation="true">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-layer-group"></i>
                    <h2>Gestionare Template-uri</h2>
                </div>
                <button class="btn-close" @onclick="CloseTemplateManager">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                @if (IsCreatingTemplate || EditingTemplateKey != null)
                {
                    <!-- CREATE/EDIT TEMPLATE FORM -->
                    <div class="template-form">
                        <h3>@(IsCreatingTemplate ? "Creează Template Nou" : "Editează Template")</h3>
                        
                        <div class="form-group">
                            <label>Nume Template</label>
                            <input type="text" class="form-input" @bind="NewTemplateName" placeholder="ex: Newsletter" />
                        </div>

                        <div class="form-group">
                            <label>Descriere</label>
                            <input type="text" class="form-input" @bind="NewTemplateDescription" placeholder="ex: Template pentru newsletter lunar" />
                        </div>

                        <div class="form-group">
                            <label>Icon (Font Awesome class)</label>
                            <input type="text" class="form-input" @bind="NewTemplateIcon" placeholder="ex: fas fa-envelope" />
                            <small class="hint">Vizualizare: <i class="@NewTemplateIcon"></i></small>
                        </div>

                        <div class="form-group">
                            <label>Conținut HTML</label>
                            <textarea class="code-editor" @bind="NewTemplateHtml" rows="15" placeholder="<h1>Titlu</h1><p>Content...</p>"></textarea>
                        </div>

                        <div class="form-actions">
                            <button class="btn btn-primary" @onclick="SaveTemplate">
                                <i class="fas fa-save"></i>
                                Salvează
                            </button>
                            <button class="btn btn-secondary" @onclick="CancelTemplateEdit">
                                <i class="fas fa-times"></i>
                                Anulează
                            </button>
                        </div>
                    </div>
                }
                else
                {
                    <!-- TEMPLATE LIST -->
                    <button class="btn-new-template-full" @onclick="StartCreateTemplate">
                        <i class="fas fa-plus"></i>
                        <span>Creează Template Nou</span>
                    </button>

                    <div class="template-manager-list">
                        @foreach (var template in Templates)
                        {
                            <div class="template-manager-item @(template.Value.IsDefault ? "default" : "")">
                                <div class="template-manager-icon">
                                    <i class="@template.Value.Icon"></i>
                                </div>
                                <div class="template-manager-info">
                                    <div class="template-manager-name">
                                        @template.Value.Name
                                        @if (template.Value.IsDefault)
                                        {
                                            <span class="default-badge">Default</span>
                                        }
                                    </div>
                                    <div class="template-manager-desc">@template.Value.Description</div>
                                </div>
                                @if (!template.Value.IsDefault)
                                {
                                    <div class="template-manager-actions">
                                        <button class="btn-icon-small" @onclick="() => StartEditTemplate(template.Key)">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-icon-small btn-danger" @onclick="() => StartDeleteTemplate(template.Key)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
}

<!-- 🆕 DELETE CONFIRMATION MODAL -->
@if (ShowDeleteConfirmation)
{
    <div class="modal-overlay @(ShowDeleteConfirmation ? "visible" : "")" @onclick="CancelDelete">
        <div class="modal-container modal-small @(ShowDeleteConfirmation ? "show" : "")" @onclick:stopPropagation="true">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h2>Confirmare Ștergere</h2>
                </div>
                <button class="btn-close" @onclick="CancelDelete">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>Ești sigur că vrei să ștergi template-ul <strong>"@(DeletingTemplateKey != null && Templates.ContainsKey(DeletingTemplateKey) ? Templates[DeletingTemplateKey].Name : "")"</strong>?</p>
                <p class="text-warning">Această acțiune nu poate fi anulată!</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" @onclick="ConfirmDelete">
                    <i class="fas fa-trash"></i>
                    Șterge
                </button>
                <button class="btn btn-secondary" @onclick="CancelDelete">
                    <i class="fas fa-times"></i>
                    Anulează
                </button>
            </div>
        </div>
    </div>
}
