@page "/test-email"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@rendermode InteractiveServer

<PageTitle>Email Testing Suite - ValyanClinic</PageTitle>

<div class="email-test-page">
    <!-- Header with Stats -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-icon">
                <i class="fas fa-paper-plane"></i>
            </div>
            <div class="header-text">
                <h1>Email Testing Suite</h1>
                <p>Test și preview pentru email-uri profesionale</p>
            </div>
        </div>
        <div class="stats-dashboard">
            <div class="stat-box">
                <div class="stat-value">@EmailsSentToday</div>
                <div class="stat-label">Trimise azi</div>
            </div>
            <div class="stat-box stat-success">
                <div class="stat-value">@SuccessRate%</div>
                <div class="stat-label">Success rate</div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="content-grid">
        <!-- Left: Email Composer -->
        <div class="composer-card">
            <div class="card-header">
                <h3><i class="fas fa-edit"></i> Compune Email</h3>
            </div>
            <div class="card-body">
                <!-- Template Selector -->
                <div class="form-group">
                    <label>
                        <i class="fas fa-layer-group"></i>
                        Selectează Template
                        <span class="badge">@Templates.Count</span>
                    </label>
                    <div class="template-grid">
                        @foreach (var template in Templates)
                        {
                            <div class="template-card @(SelectedTemplate == template.Key ? "active" : "")"
                                 @onclick="() => SelectTemplate(template.Key)">
                                <div class="template-icon">
                                    <i class="@template.Value.Icon"></i>
                                </div>
                                <div class="template-info">
                                    <div class="template-name">@template.Value.Name</div>
                                    <div class="template-desc">@template.Value.Description</div>
                                </div>
                                @if (SelectedTemplate == template.Key)
                                {
                                    <i class="fas fa-check-circle template-check"></i>
                                }
                            </div>
                        }
                    </div>
                </div>

                <!-- Email Input with Validation -->
                <div class="form-group">
                    <label>
                        <i class="fas fa-at"></i>
                        Email destinatar
                        @if (!string.IsNullOrEmpty(ValidationMessage))
                        {
                            <span class="validation-badge @(IsEmailValid ? "valid" : "invalid")">
                                <i class="fas @(IsEmailValid ? "fa-check-circle" : "fa-times-circle")"></i>
                                @ValidationMessage
                            </span>
                        }
                    </label>
                    <div class="input-with-button">
                        <input type="email" 
                               class="form-input @GetInputValidationClass()"
                               @bind="TestEmailAddress"
                               @oninput="OnEmailInput"
                               placeholder="exemplu@gmail.com" />
                        <button class="btn-icon" 
                                @onclick="UseMyEmail" 
                                disabled="@IsLoading"
                                title="Folosește email-ul meu">
                            <i class="fas fa-user"></i>
                        </button>
                    </div>
                    <small class="hint">Introdu email-ul tău pentru test</small>
                </div>

                <!-- Subject -->
                <div class="form-group">
                    <label>
                        <i class="fas fa-heading"></i>
                        Subiect
                        <span class="char-counter">@EmailSubject.Length/100</span>
                    </label>
                    <input type="text" 
                           class="form-input"
                           @bind="EmailSubject"
                           maxlength="100"
                           placeholder="Subiectul email-ului" />
                </div>

                <!-- Alert Message -->
                @if (!string.IsNullOrEmpty(ResultMessage))
                {
                    <div class="alert @(IsSuccess ? "alert-success" : "alert-error")">
                        <i class="fas @(IsSuccess ? "fa-check-circle" : "fa-exclamation-triangle")"></i>
                        <span>@ResultMessage</span>
                        <button class="alert-close" @onclick="ClearAlert">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                }

                <!-- Send Button -->
                <button class="btn-send @(IsLoading ? "loading" : "")" 
                        @onclick="SendTestEmail"
                        disabled="@(IsLoading || !IsEmailValid || string.IsNullOrEmpty(TestEmailAddress))">
                    @if (IsLoading)
                    {
                        <span class="spinner"></span>
                        <span>Se trimite...</span>
                    }
                    else
                    {
                        <i class="fas fa-paper-plane"></i>
                        <span>Trimite Email Test</span>
                    }
                </button>
            </div>
        </div>

        <!-- Right: Live Preview -->
        <div class="preview-card">
            <div class="card-header">
                <h3><i class="fas fa-eye"></i> Preview Live</h3>
                <div class="preview-controls">
                    <button class="btn-icon-small" 
                            @onclick="ToggleDarkPreview"
                            title="@(IsDarkPreview ? "Light mode" : "Dark mode")">
                        <i class="fas @(IsDarkPreview ? "fa-sun" : "fa-moon")"></i>
                    </button>
                    <button class="btn-icon-small" 
                            @onclick="RefreshPreview"
                            title="Refresh preview">
                        <i class="fas fa-sync-alt @(IsRefreshing ? "fa-spin" : "")"></i>
                    </button>
                </div>
            </div>
            <div class="preview-wrapper @(IsDarkPreview ? "dark-mode" : "")">
                <div class="device-frame">
                    <div class="device-header">
                        <div class="device-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span class="device-title">@EmailSubject</span>
                    </div>
                    <div class="device-body">
                        @((MarkupString)GetPreviewHtml())
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Sends History -->
    @if (RecentSends.Any())
    {
        <div class="history-card">
            <div class="card-header">
                <h3>
                    <i class="fas fa-history"></i>
                    Trimiteri recente
                    <span class="badge">@RecentSends.Count</span>
                </h3>
                <button class="btn-icon-small" 
                        @onclick="ClearHistory"
                        title="Șterge istoric">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
            <div class="history-list">
                @foreach (var send in RecentSends.Take(5))
                {
                    <div class="history-item">
                        <div class="history-icon @(send.Success ? "success" : "error")">
                            <i class="fas @(send.Success ? "fa-check" : "fa-times")"></i>
                        </div>
                        <div class="history-details">
                            <div class="history-email">@send.To</div>
                            <div class="history-subject">@send.Subject</div>
                        </div>
                        <div class="history-time">
                            <i class="far fa-clock"></i>
                            @send.SentAt.ToString("HH:mm:ss")
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Back Button -->
    <div class="back-wrapper">
        <a href="/" class="btn-back">
            <i class="fas fa-arrow-left"></i>
            <span>Înapoi la Dashboard</span>
        </a>
    </div>
</div>
