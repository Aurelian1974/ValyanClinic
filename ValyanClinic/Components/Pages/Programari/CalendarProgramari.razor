@page "/programari"
@page "/programari/calendar"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@rendermode InteractiveServer
@using Syncfusion.Blazor.Schedule
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Popups
@using ValyanClinic.Application.Features.ProgramareManagement.DTOs
@using ValyanClinic.Application.Features.PersonalMedicalManagement.Queries.GetPersonalMedicalList
@using ValyanClinic.Components.Pages.Programari.Modals

<PageTitle>Calendar Programări - ValyanClinic</PageTitle>

<div class="calendar-container">
    <!-- Header -->
    <div class="page-header">
        <h1>
    <i class="fas fa-calendar-alt"></i>
       Calendar Programări
        </h1>
        <div class="header-actions">
    <button class="btn btn-primary" @onclick="OpenAddModal">
        <i class="fas fa-plus"></i>
         Programare Nouă
            </button>
  <button class="btn btn-secondary" @onclick="NavigateToList">
          <i class="fas fa-list"></i>
  Listă
            </button>
   </div>
    </div>

    <!-- Filters -->
<div class="filters-bar">
<div class="filter-group">
  <i class="fas fa-user-md"></i>
      <SfDropDownList TValue="Guid?" 
      TItem="PersonalMedicalListDto"
        Placeholder="Toți medicii"
           DataSource="@DoctorsList"
    @bind-Value="@FilterDoctorID"
     AllowFiltering="true"
    ShowClearButton="true">
  <DropDownListFieldSettings Value="PersonalID" Text="NumeComplet" />
         <DropDownListEvents TValue="Guid?" TItem="PersonalMedicalListDto" ValueChange="@OnDoctorFilterChanged" />
       </SfDropDownList>
 </div>

   <div class="date-nav">
    <button class="btn-nav" @onclick="PreviousWeek">
     <i class="fas fa-chevron-left"></i>
  </button>
            <button class="btn-today" @onclick="GoToToday">Astăzi</button>
            <button class="btn-nav" @onclick="NextWeek">
     <i class="fas fa-chevron-right"></i>
  </button>
        </div>

     <div class="total-badge">
    <i class="fas fa-calendar-check"></i>
            Total: <strong>@TotalProgramari</strong>
     </div>
    </div>

    <!-- Scheduler -->
    <div class="scheduler-card" id="calendar-scheduler-container">
  @if (IsLoading)
        {
   <div class="loading-overlay">
         <div class="spinner"></div>
       <p>Se încarcă...</p>
  </div>
        }
        else
   {
  <SfSchedule @ref="SchedulerRef"
    TValue="ProgramareEventDto"
   Height="100%"
       @bind-SelectedDate="@SelectedDate"
  @bind-CurrentView="@CurrentView"
 StartHour="08:00"
      EndHour="20:00"
   ShowQuickInfo="true">

     <ScheduleViews>
<ScheduleView Option="View.Day"></ScheduleView>
         <ScheduleView Option="View.Week"></ScheduleView>
    <ScheduleView Option="View.Month"></ScheduleView>
   </ScheduleViews>

<ScheduleEventSettings DataSource="@EventsList" />

     <ScheduleQuickInfoTemplates>
   <ContentTemplate>
 @{
          var appointment = (context as ProgramareEventDto)!;
      }
  <div class="quickinfo-content">
<div class="quickinfo-row">
      <i class="fas fa-user"></i>
   <strong>Pacient:</strong>
          <span>@appointment.Subject</span>
       </div>
      <div class="quickinfo-row">
<i class="fas fa-calendar"></i>
     <strong>Data:</strong>
     <span>@appointment.StartTime.ToString("dd.MM.yyyy")</span>
      </div>
      <div class="quickinfo-row">
  <i class="far fa-clock"></i>
 <strong>Interval:</strong>
  <span>@appointment.StartTime.ToString("HH:mm") - @appointment.EndTime.ToString("HH:mm")</span>
    </div>
      @if (!string.IsNullOrEmpty(appointment.TipProgramare))
   {
        <div class="quickinfo-row">
   <i class="fas fa-stethoscope"></i>
    <strong>Tip:</strong>
   <span>@appointment.TipProgramare</span>
      </div>
         }
   @if (!string.IsNullOrEmpty(appointment.DoctorName))
        {
 <div class="quickinfo-row">
       <i class="fas fa-user-md"></i>
        <strong>Doctor:</strong>
       <span>@appointment.DoctorName</span>
 </div>
       }
   <div class="quickinfo-row">
    <i class="fas fa-info-circle"></i>
   <strong>Status:</strong>
    <span class="status-badge status-@appointment.Status.ToLower()">@GetStatusDisplayName(appointment.Status)</span>
 </div>
   </div>
</ContentTemplate>
  </ScheduleQuickInfoTemplates>

 <ScheduleEvents TValue="ProgramareEventDto"
   OnCellClick="@OnCellClicked"
OnEventClick="@OnEventClicked"
    OnPopupOpen="@OnPopupOpen"
       EventRendered="@OnEventRendered" />
      </SfSchedule>

   <!-- Legend -->
       <div class="legend">
      <span class="legend-title">Statusuri:</span>
           <div class="legend-item">
  <span class="dot dot-blue"></span>
        <span>Programată</span>
      </div>
  <div class="legend-item">
         <span class="dot dot-green"></span>
    <span>Confirmată</span>
 </div>
    <div class="legend-item">
  <span class="dot dot-orange"></span>
    <span>Check-in</span>
     </div>
         <div class="legend-item">
   <span class="dot dot-purple"></span>
   <span>În consultație</span>
  </div>
    <div class="legend-item">
     <span class="dot dot-gray"></span>
    <span>Finalizată</span>
  </div>
          <div class="legend-item">
    <span class="dot dot-red"></span>
     <span>Anulată</span>
  </div>
  </div>
   }
    </div>
</div>

@* Modals *@
<ProgramareAddEditModal 
    IsVisible="@ShowAddEditModal"
    IsVisibleChanged="@(EventCallback.Factory.Create<bool>(this, v => ShowAddEditModal = v))"
    ProgramareId="@SelectedProgramareId"
    PrefilledStartTime="@SelectedCellStartTime"
    PrefilledEndTime="@SelectedCellEndTime"
    OnSaved="HandleModalSaved" />

<ProgramareViewModal 
    IsVisible="@ShowViewModal"
    IsVisibleChanged="@(EventCallback.Factory.Create<bool>(this, v => ShowViewModal = v))"
    ProgramareId="@(SelectedProgramareId ?? Guid.Empty)"
    OnEditRequested="HandleEditRequested" />
