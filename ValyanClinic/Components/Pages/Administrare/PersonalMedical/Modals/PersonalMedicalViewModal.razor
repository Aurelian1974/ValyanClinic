@if (IsVisible)
{
    <div class="modal-overlay visible" @onclick="HandleOverlayClick">
        <div class="modal-container @(IsVisible ? "show" : "")" @onclick:stopPropagation="true">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-md"></i>
                    <h2>Detalii Personal Medical</h2>
                </div>
                <button class="btn-close" @onclick="Close" type="button">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">
                @if (IsLoading)
                {
                    <div class="loading-container">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Se incarca...</span>
                        </div>
                        <p>Se incarca datele...</p>
                    </div>
                }
                else if (HasError)
                {
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-triangle"></i>
                        @ErrorMessage
                    </div>
                }
                else if (PersonalMedicalData != null)
                {
                    <div class="tabs-container">
                        <div class="tab-buttons">
                            <button class="tab-button @(ActiveTab == "date" ? "active" : "")" 
                                    @onclick='() => SetActiveTab("date")'>
                                <i class="fas fa-id-card"></i>
                                <span>Date Generale</span>
                            </button>
                            <button class="tab-button @(ActiveTab == "contact" ? "active" : "")" 
                                    @onclick='() => SetActiveTab("contact")'>
                                <i class="fas fa-phone"></i>
                                <span>Contact</span>
                            </button>
                            <button class="tab-button @(ActiveTab == "pozitie" ? "active" : "")" 
                                    @onclick='() => SetActiveTab("pozitie")'>
                                <i class="fas fa-briefcase"></i>
                                <span>Pozitie</span>
                            </button>
                            <!-- ✅ ADDED: Tab Pacienți -->
                            <button class="tab-button @(ActiveTab == "pacienti" ? "active" : "")" 
                                    @onclick='() => SetActiveTab("pacienti")'>
                                <i class="fas fa-users"></i>
                                <span>Pacienți (@PacientiAsociati.Count)</span>
                            </button>
                        </div>

                        <div class="tab-content">
                            <div class="tab-pane @(ActiveTab == "date" ? "active" : "")">
                                <div class="info-card">
                                    <h3 class="card-title">
                                        <i class="fas fa-user"></i>
                                        Informatii Generale
                                    </h3>
                                    <div class="info-grid">
                                        <div class="info-item">
                                            <label>Nume Complet</label>
                                            <div class="info-value primary-text">@PersonalMedicalData.NumeComplet</div>
                                        </div>
                                        <div class="info-item">
                                            <label>Status</label>
                                            <div class="info-value">
                                                <span class="status-badge @(PersonalMedicalData.EsteActiv == true ? "status-active" : "status-inactive")">
                                                    @(PersonalMedicalData.EsteActiv == true ? "Activ" : "Inactiv")
                                                </span>
                                            </div>
                                        </div>
                                        <div class="info-item">
                                            <label>Specializare</label>
                                            <div class="info-value @(string.IsNullOrEmpty(PersonalMedicalData.Specializare) ? "info-value-empty" : "")">
                                                @if (!string.IsNullOrEmpty(PersonalMedicalData.Specializare))
                                                {
                                                    @PersonalMedicalData.Specializare
                                                }
                                                else
                                                {
                                                    <i class="fas fa-exclamation-circle"></i>
                                                    <span>Necompletat</span>
                                                }
                                            </div>
                                        </div>
                                        <div class="info-item">
                                            <label>Numar Licenta</label>
                                            <div class="info-value @(string.IsNullOrEmpty(PersonalMedicalData.NumarLicenta) ? "info-value-empty" : "")">
                                                @if (!string.IsNullOrEmpty(PersonalMedicalData.NumarLicenta))
                                                {
                                                    <span class="badge-primary">@PersonalMedicalData.NumarLicenta</span>
                                                }
                                                else
                                                {
                                                    <i class="fas fa-exclamation-circle"></i>
                                                    <span>Necompletat</span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane @(ActiveTab == "contact" ? "active" : "")">
                                <div class="info-card">
                                    <h3 class="card-title">
                                        <i class="fas fa-address-book"></i>
                                        Date de Contact
                                    </h3>
                                    <div class="info-grid">
                                        <div class="info-item">
                                            <label>Telefon</label>
                                            <div class="info-value @(string.IsNullOrEmpty(PersonalMedicalData.Telefon) ? "info-value-empty" : "")">
                                                @if (!string.IsNullOrEmpty(PersonalMedicalData.Telefon))
                                                {
                                                    <a href="tel:@PersonalMedicalData.Telefon" class="contact-link">
                                                        <i class="fas fa-phone"></i>
                                                        @PersonalMedicalData.Telefon
                                                    </a>
                                                }
                                                else
                                                {
                                                    <i class="fas fa-exclamation-circle"></i>
                                                    <span>Necompletat</span>
                                                }
                                            </div>
                                        </div>
                                        <div class="info-item">
                                            <label>Email</label>
                                            <div class="info-value @(string.IsNullOrEmpty(PersonalMedicalData.Email) ? "info-value-empty" : "")">
                                                @if (!string.IsNullOrEmpty(PersonalMedicalData.Email))
                                                {
                                                    <a href="mailto:@PersonalMedicalData.Email" class="contact-link">
                                                        <i class="fas fa-envelope"></i>
                                                        @PersonalMedicalData.Email
                                                    </a>
                                                }
                                                else
                                                {
                                                    <i class="fas fa-exclamation-circle"></i>
                                                    <span>Necompletat</span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane @(ActiveTab == "pozitie" ? "active" : "")">
                                <div class="info-card">
                                    <h3 class="card-title">
                                        <i class="fas fa-building"></i>
                                        Detalii Pozitie
                                    </h3>
                                    <div class="info-grid">
                                        <div class="info-item">
                                            <label>Departament</label>
                                            <div class="info-value @(string.IsNullOrEmpty(PersonalMedicalData.Departament) ? "info-value-empty" : "")">
                                                @if (!string.IsNullOrEmpty(PersonalMedicalData.Departament))
                                                {
                                                    @PersonalMedicalData.Departament
                                                }
                                                else
                                                {
                                                    <i class="fas fa-exclamation-circle"></i>
                                                    <span>Necompletat</span>
                                                }
                                            </div>
                                        </div>
                                        <div class="info-item">
                                            <label>Pozitie</label>
                                            <div class="info-value @(string.IsNullOrEmpty(PersonalMedicalData.Pozitie) ? "info-value-empty" : "")">
                                                @if (!string.IsNullOrEmpty(PersonalMedicalData.Pozitie))
                                                {
                                                    <span class="badge-secondary">@PersonalMedicalData.Pozitie</span>
                                                }
                                                else
                                                {
                                                    <i class="fas fa-exclamation-circle"></i>
                                                    <span>Necompletat</span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ✅ ADDED: Tab Pacienți -->
                            <div class="tab-pane @(ActiveTab == "pacienti" ? "active" : "")">
                                @if (IsLoadingPacienti)
                                {
                                    <div class="loading-container" style="text-align: center; padding: 3rem;">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Se încarcă...</span>
                                        </div>
                                        <p>Se încarcă pacienți...</p>
                                    </div>
                                }
                                else if (PacientiAsociati.Any())
                                {
                                    <!-- Pacienți activi -->
                                    @if (PacientiActivi.Any())
                                    {
                                        <div class="info-card">
                                            <h3 class="card-title">
                                                <i class="fas fa-check-circle text-success"></i>
                                                Pacienți Activi (@PacientiActivi.Count)
                                            </h3>
                                            @foreach (var pacient in PacientiActivi)
                                            {
                                                <div class="pacient-card" style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem;">
                                                    <div class="pacient-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                                        <div>
                                                            <h5 style="margin: 0; font-size: 1.125rem; color: #111827;">
                                                                <i class="fas fa-user-injured text-primary"></i>
                                                                @pacient.PacientNumeComplet
                                                            </h5>
                                                            @if (!string.IsNullOrEmpty(pacient.PacientCNP))
                                                            {
                                                                <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: #6b7280;">CNP: @pacient.PacientCNP</p>
                                                            }
                                                        </div>
                                                        @if (!string.IsNullOrEmpty(pacient.TipRelatie))
                                                        {
                                                            <span class="badge @GetBadgeClass(pacient.TipRelatie)" style="padding: 0.375rem 0.75rem; font-size: 0.75rem; border-radius: 6px;">
                                                                @pacient.TipRelatie
                                                            </span>
                                                        }
                                                    </div>

                                                    <div class="info-grid" style="gap: 0.75rem;">
                                                        <div class="info-item">
                                                            <label style="font-size: 0.8125rem; color: #6b7280;">Vârstă</label>
                                                            <div class="info-value" style="font-size: 0.875rem;">
                                                                @pacient.PacientVarsta ani
                                                            </div>
                                                        </div>
                                                        @if (!string.IsNullOrEmpty(pacient.PacientTelefon))
                                                        {
                                                            <div class="info-item">
                                                                <label style="font-size: 0.8125rem; color: #6b7280;">Telefon</label>
                                                                <div class="info-value" style="font-size: 0.875rem;">
                                                                    <a href="tel:@pacient.PacientTelefon" class="contact-link">
                                                                        <i class="fas fa-phone"></i>
                                                                        @pacient.PacientTelefon
                                                                    </a>
                                                                </div>
                                                            </div>
                                                        }
                                                        @if (!string.IsNullOrEmpty(pacient.PacientEmail))
                                                        {
                                                            <div class="info-item">
                                                                <label style="font-size: 0.8125rem; color: #6b7280;">Email</label>
                                                                <div class="info-value" style="font-size: 0.875rem;">
                                                                    <a href="mailto:@pacient.PacientEmail" class="contact-link">
                                                                        <i class="fas fa-envelope"></i>
                                                                        @pacient.PacientEmail
                                                                    </a>
                                                                </div>
                                                            </div>
                                                        }
                                                        <div class="info-item">
                                                            <label style="font-size: 0.8125rem; color: #6b7280;">Data asocierii</label>
                                                            <div class="info-value" style="font-size: 0.875rem;">
                                                                @pacient.DataAsocierii.ToString("dd.MM.yyyy") 
                                                                <span style="color: #6b7280;">(@FormatZile(pacient.ZileDeAsociere))</span>
                                                            </div>
                                                        </div>
                                                        @if (!string.IsNullOrEmpty(pacient.Motiv))
                                                        {
                                                            <div class="info-item full-width">
                                                                <label style="font-size: 0.8125rem; color: #6b7280;">Motiv asociere</label>
                                                                <div class="info-value" style="font-size: 0.875rem;">
                                                                    <i class="fas fa-info-circle text-info"></i>
                                                                    @pacient.Motiv
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }

                                    <!-- Pacienți inactivi (istoric) -->
                                    @if (PacientiInactivi.Any())
                                    {
                                        <div class="info-card" style="margin-top: 1.5rem;">
                                            <h3 class="card-title">
                                                <i class="fas fa-history text-muted"></i>
                                                Istoric Relații Inactive (@PacientiInactivi.Count)
                                            </h3>
                                            @foreach (var pacient in PacientiInactivi)
                                            {
                                                <div class="pacient-card-inactive" style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem;">
                                                    <div class="pacient-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                                        <div>
                                                            <h5 style="margin: 0; font-size: 1.125rem; color: #6b7280;">
                                                                <i class="fas fa-user-injured"></i>
                                                                @pacient.PacientNumeComplet
                                                            </h5>
                                                            @if (!string.IsNullOrEmpty(pacient.PacientCNP))
                                                            {
                                                                <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: #6b7280;">CNP: @pacient.PacientCNP</p>
                                                            }
                                                        </div>
                                                        <span class="badge badge-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem; border-radius: 6px; background: #94a3b8; color: white;">INACTIV</span>
                                                    </div>

                                                    <div class="info-grid" style="gap: 0.75rem;">
                                                        <div class="info-item">
                                                            <label style="font-size: 0.8125rem; color: #6b7280;">Perioadă</label>
                                                            <div class="info-value" style="font-size: 0.875rem; color: #6b7280;">
                                                                @pacient.DataAsocierii.ToString("dd.MM.yyyy") - 
                                                                @(pacient.DataDezactivarii?.ToString("dd.MM.yyyy") ?? "N/A")
                                                            </div>
                                                        </div>
                                                        @if (pacient.ZileDeAsociere > 0)
                                                        {
                                                            <div class="info-item">
                                                                <label style="font-size: 0.8125rem; color: #6b7280;">Zile de asociere</label>
                                                                <div class="info-value" style="font-size: 0.875rem; color: #6b7280;">
                                                                    @FormatZile(pacient.ZileDeAsociere)
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                }
                                else
                                {
                                    <!-- Empty State -->
                                    <div class="empty-state" style="text-align: center; padding: 3rem; color: #6b7280;">
                                        <i class="fas fa-users fa-3x" style="margin-bottom: 1.5rem; color: #d1d5db;"></i>
                                        <p style="font-size: 1.125rem; margin-bottom: 0; color: #374151;">Nu există pacienți asociați acestui doctor.</p>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="Close" type="button">
                    <i class="fas fa-times"></i>
                    <span>Inchide</span>
                </button>
                <button class="btn btn-warning" @onclick="HandleEdit" type="button">
                    <i class="fas fa-edit"></i>
                    <span>Editeaza</span>
                </button>
                <button class="btn btn-danger" @onclick="HandleDelete" type="button">
                    <i class="fas fa-trash"></i>
                    <span>Sterge</span>
                </button>
            </div>
        </div>
    </div>
}
