@page "/administrare/personal-medical"
@rendermode InteractiveServer
@using ValyanClinic.Application.Services
@using ValyanClinic.Domain.Models
@using ValyanClinic.Domain.Enums
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Notifications
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Popups
@using GridSelectionType = Syncfusion.Blazor.Grids.SelectionType
@using GridSelectionMode = Syncfusion.Blazor.Grids.SelectionMode
@using GridSortDirection = Syncfusion.Blazor.Grids.SortDirection
@using GridFilterType = Syncfusion.Blazor.Grids.FilterType
@using PersonalMedicalModel = ValyanClinic.Domain.Models.PersonalMedical

<PageTitle>Administrare Personal Medical - ValyanMed</PageTitle>

@* ADD NAVIGATION COMPONENT AS RECOMMENDED IN USAGE GUIDE *@
<PersonalMedicalNavigation />

<div class="personal-medical-page-container">
    
    @* Error Display *@
    @if (_state.HasError)
    {
        <div class="alert alert-danger d-flex align-items-center">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <div class="flex-1">@_state.ErrorMessage</div>
            <button class="btn-close" @onclick="_state.ClearError" aria-label="Close"></button>
        </div>
    }

    @* Page Header - MEDICAL THEME *@
    <div class="personal-medical-page-header">
        <div class="header-content">
            <div class="header-text">
                <h1 class="personal-medical-page-title">
                    <i class="fas fa-user-md"></i>
                    Administrare Personal Medical
                </h1>
                <p class="personal-medical-page-subtitle">
                    Gestioneaza personalul medical - doctori, asistente și specialiști medicali
                </p>
            </div>
            
            <div class="personal-medical-header-actions">
                <button class="btn btn-outline-success" @onclick="ShowAddPersonalMedicalModal">
                    <i class="fas fa-plus"></i>
                    <span class="btn-text">Adauga Personal Medical</span>
                </button>
                <button class="btn btn-outline-secondary" @onclick="RefreshData">
                    <i class="fas fa-sync-alt"></i>
                    <span class="btn-text">Actualizeaza</span>
                </button>
                
                @* Kebab Menu Button *@
                <div class="kebab-menu-container">
                    <button class="btn btn-outline-secondary kebab-menu-btn" 
                            @onclick="ToggleKebabMenu"
                            @onclick:stopPropagation="true"
                            aria-label="Meniu opțiuni"
                            aria-expanded="@_state.ShowKebabMenu.ToString().ToLower()"
                            aria-haspopup="true">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    
                    @if (_state.ShowKebabMenu)
                    {
                        <div class="kebab-menu-dropdown" 
                             @onclick:stopPropagation="true"
                             role="menu"
                             aria-label="Opțiuni disponibile">
                            <button class="kebab-menu-item" 
                                    @onclick="() => ToggleStatistics()"
                                    role="menuitem"
                                    aria-label="Comută afișarea statisticilor">
                                <i class="fas fa-chart-bar"></i>
                                <span>Statistici</span>
                                @if (_state.ShowStatistics)
                                {
                                    <i class="fas fa-check kebab-check" aria-label="Activat"></i>
                                }
                            </button>
                            <button class="kebab-menu-item" 
                                    @onclick="() => ToggleAdvancedFilters()"
                                    role="menuitem"
                                    aria-label="Comută afișarea filtrelor avansate">
                                <i class="fas fa-filter"></i>
                                <span>Filtrare Avansata</span>
                                @if (_state.ShowAdvancedFilters)
                                {
                                    <i class="fas fa-check kebab-check" aria-label="Activat"></i>
                                }
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    @* Statistics Cards - CONDITIONAL DISPLAY WITH MEDICAL THEME *@
    @if (!_state.IsLoading && _state.ShowStatistics)
    {
        <div class="personal-medical-stats-grid">
            @foreach (var stat in _models.PersonalMedicalStatistics)
            {
                <div class="personal-medical-stat-card @stat.ColorClass">
                    <div class="stat-icon">
                        <i class="@stat.IconClass"></i>
                    </div>
                    <div class="stat-content">
                        <div class="personal-medical-stat-number">@stat.Value</div>
                        <div class="personal-medical-stat-label">@stat.Label</div>
                    </div>
                </div>
            }
        </div>
    }

    @* Toast Notification *@
    <SfToast @ref="ToastRef" Title="ValyanMed - Personal Medical" Target="body" NewestOnTop="true" ShowProgressBar="true"></SfToast>

    @* Advanced Filter Panel - CONDITIONAL DISPLAY WITH MEDICAL THEME *@
    @if (_state.ShowAdvancedFilters)
    {
        <div class="personal-medical-advanced-filter-panel">
            <div class="filter-panel-header">
                <h3>
                    <i class="fas fa-filter"></i>
                    Filtrare Avansata Personal Medical
                </h3>
                <button class="btn btn-secondary btn-sm" @onclick="() => ToggleAdvancedFilters()">
                    <i class="fas fa-chevron-up"></i>
                    <span>Ascunde Filtrele</span>
                </button>
            </div>
            
            <div class="filter-panel-content">
                @* First row - Departament, Pozitie, Status *@
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Departament Medical:</label>
                        <SfDropDownList TItem="DepartamentFilterItem" TValue="string" 
                                       DataSource="@_state.DepartmentOptions" 
                                       @bind-Value="@_state.SelectedDepartment"
                                       Placeholder="Toate departamentele medicale"
                                       AllowFiltering="true"
                                       PopupHeight="200px"
                                       Width="200px">
                            <DropDownListFieldSettings Text="Text" Value="Value" />
                            <DropDownListEvents TItem="DepartamentFilterItem" TValue="string" ValueChange="OnDepartmentFilterChanged" />
                        </SfDropDownList>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Pozitie:</label>
                        <SfDropDownList TItem="PozitieFilterItem" TValue="PozitiePersonalMedical?" 
                                       DataSource="@_state.PozitieOptions" 
                                       @bind-Value="@_state.SelectedPozitie"
                                       Placeholder="Toate pozițiile"
                                       AllowFiltering="true"
                                       PopupHeight="200px"
                                       Width="180px">
                            <DropDownListFieldSettings Text="Text" Value="Value" />
                            <DropDownListEvents TItem="PozitieFilterItem" TValue="PozitiePersonalMedical?" ValueChange="OnPozitieFilterChanged" />
                        </SfDropDownList>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Status:</label>
                        <SfDropDownList TItem="StatusFilterItem" TValue="bool?" 
                                       DataSource="@_state.StatusOptions" 
                                       @bind-Value="@_state.SelectedStatus"
                                       Placeholder="Toate statusurile"
                                       AllowFiltering="true"
                                       PopupHeight="150px"
                                       Width="150px">
                            <DropDownListFieldSettings Text="Text" Value="Value" />
                            <DropDownListEvents TItem="StatusFilterItem" TValue="bool?" ValueChange="OnStatusFilterChanged" />
                        </SfDropDownList>
                    </div>
                </div>
                
                @* Second row - Search text, Activity period *@
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Cautare text:</label>
                        <SfTextBox @bind-Value="@_state.SearchText" 
                                  Placeholder="Cauta in nume, email, specializare, licenta..."
                                  Width="300px"
                                  ShowClearButton="true">
                            <TextBoxEvents ValueChange="OnSearchTextChanged" />
                        </SfTextBox>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Perioada activitate:</label>
                        <SfDropDownList TItem="string" TValue="string" 
                                       DataSource="@_models.ActivityPeriodOptions" 
                                       @bind-Value="@_state.SelectedActivityPeriod"
                                       Placeholder="Orice perioada"
                                       Width="180px">
                            <DropDownListEvents TItem="string" TValue="string" ValueChange="OnActivityPeriodChanged" />
                        </SfDropDownList>
                    </div>
                    
                    @* Empty space for layout balance *@
                    <div class="filter-group"></div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn btn-success btn-sm" @onclick="ApplyAdvancedFilters">
                        <i class="fas fa-check"></i>
                        <span>Aplica Filtrele</span>
                    </button>
                    <button class="btn btn-secondary btn-sm" @onclick="ClearAdvancedFilters">
                        <i class="fas fa-times"></i>
                        <span>Curata Filtrele</span>
                    </button>
                    <button class="btn btn-info btn-sm" @onclick="ExportFilteredData">
                        <i class="fas fa-download"></i>
                        <span>Exporta Rezultate</span>
                    </button>
                </div>
                
                @* Filter Results Summary *@
                <div class="filter-results-summary">
                    <div class="results-info">
                        <span class="results-count">
                            <i class="fas fa-user-md"></i>
                            Rezultate: <strong>@_models.FilteredPersonalMedical.Count</strong> din <strong>@_models.PersonalMedical.Count</strong> personal medical
                        </span>
                        @if (_state.IsAnyFilterActive)
                        {
                            <span class="filtered-indicator">
                                <i class="fas fa-filter"></i>
                                Filtrare activa
                            </span>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    @* Main DataGrid - ADAPTED FOR MEDICAL STAFF *@
    @if (_state.IsLoading)
    {
        <div class="personal-medical-grid-container">
            <div class="loading-indicator text-center p-5">
                <i class="fas fa-spinner fa-spin fa-2x text-success"></i>
                <div class="mt-3">Se incarca personalul medical...</div>
            </div>
        </div>
    }
    else
    {
        <div class="personal-medical-grid-container">
            <SfGrid @ref="GridRef" DataSource="@_models.FilteredPersonalMedical" 
                    AllowPaging="true" 
                    AllowSorting="true" 
                    AllowFiltering="true"
                    AllowGrouping="true"
                    AllowSelection="true"
                    AllowReordering="true"
                    AllowResizing="true"
                    ShowColumnMenu="true">
                
                @* Grid Events *@
                <GridEvents TValue="PersonalMedicalModel" 
                           RowSelected="RowSelected"
                           RowDeselected="RowDeselected">
                </GridEvents>

                @* Selection Settings *@
                <GridSelectionSettings Type="GridSelectionType.Multiple" Mode="GridSelectionMode.Row"></GridSelectionSettings>

                @* Page Settings *@
                <GridPageSettings PageSize="10" PageSizes="@_models.PageSizes"></GridPageSettings>

                @* Sort Settings *@
                <GridSortSettings AllowUnsort="true">
                    <GridSortColumns>
                        <GridSortColumn Field="Nume" Direction="GridSortDirection.Ascending"></GridSortColumn>
                    </GridSortColumns>
                </GridSortSettings>

                @* Filter Settings *@
                <GridFilterSettings Type="GridFilterType.Excel" 
                                  Mode="FilterBarMode.Immediate"
                                  ShowFilterBarStatus="true"
                                  ImmediateModeDelay="500">
                </GridFilterSettings>

                @* Group Settings *@
                <GridGroupSettings ShowDropArea="true" ShowToggleButton="true" ShowGroupedColumn="true">
                    <GridGroupColumns>
                        <GridGroupColumn Field="Departament"></GridGroupColumn>
                    </GridGroupColumns>
                </GridGroupSettings>

                @* Columns Definition - OPTIMIZED FOR MEDICAL STAFF *@
                <GridColumns>
                    <GridColumn Field="@nameof(PersonalMedicalModel.Nume)" HeaderText="Nume" Width="100" AllowFiltering="true" AllowReordering="true"></GridColumn>
                    <GridColumn Field="@nameof(PersonalMedicalModel.Prenume)" HeaderText="Prenume" Width="100" AllowFiltering="true" AllowReordering="true"></GridColumn>
                    <GridColumn Field="@nameof(PersonalMedicalModel.Email)" HeaderText="Email" Width="160" AllowFiltering="true" AllowReordering="true"></GridColumn>
                    <GridColumn Field="@nameof(PersonalMedicalModel.Telefon)" HeaderText="Telefon" Width="90" AllowFiltering="true" AllowReordering="true"></GridColumn>
                    
                    <GridColumn Field="@nameof(PersonalMedicalModel.Pozitie)" HeaderText="Pozitie" Width="120" 
                               AllowFiltering="true" AllowReordering="true">
                        <Template>
                            @{                                               
                                var personalMedical = context as PersonalMedicalModel;
                                if (personalMedical != null)
                                {
                                    <span class="pozitie-badge pozitie-@personalMedical.Pozitie.ToString().ToLower()">
                                        <i class="@GetPozitieIcon(personalMedical.Pozitie ?? PozitiePersonalMedical.AsistentMedical)"></i>
                                        @(personalMedical.Pozitie?.GetDisplayName() ?? "Nespecificat")
                                    </span>
                                }
                            }
                        </Template>
                    </GridColumn>
                    
                    <GridColumn Field="@nameof(PersonalMedicalModel.Specializare)" HeaderText="Specializare" Width="140" AllowFiltering="true" AllowReordering="true"></GridColumn>
                    <GridColumn Field="@nameof(PersonalMedicalModel.NumarLicenta)" HeaderText="Nr. Licenta" Width="100" AllowFiltering="true" AllowReordering="true"></GridColumn>
                               
                    <GridColumn Field="@nameof(PersonalMedicalModel.Departament)" HeaderText="Departament" Width="120" 
                               AllowFiltering="true" AllowReordering="true">
                        <Template>
                            @{                                               
                                var personalMedical = context as PersonalMedicalModel;
                                <span class="departament-badge">
                                    <i class="fas fa-hospital"></i>
                                    @personalMedical!.DepartamentDisplay
                                </span>
                            }
                        </Template>
                    </GridColumn>
                               
                    <GridColumn Field="@nameof(PersonalMedicalModel.EsteActiv)" HeaderText="Status" Width="70" 
                               AllowFiltering="true" AllowReordering="true">
                        <Template>
                            @{                                               
                                var personalMedical = context as PersonalMedicalModel;
                                <span class="status-badge status-@(personalMedical!.EsteActiv ? "activ" : "inactiv")">
                                    <i class="fas @(personalMedical.EsteActiv ? "fa-check-circle" : "fa-times-circle")"></i>
                                    @personalMedical.StatusDisplay
                                </span>
                            }
                        </Template>
                    </GridColumn>
                               
                    <GridColumn Field="@nameof(PersonalMedicalModel.DataCreare)" HeaderText="Data Crearii" Width="100" 
                               Format="dd.MM.yyyy" Type="ColumnType.Date" AllowFiltering="true" AllowReordering="true"></GridColumn>
                               
                    @* Actions Column - FROZEN RIGHT WITH MEDICAL THEME *@
                    <GridColumn HeaderText="Actiuni" Width="120" AllowFiltering="false" AllowSorting="false"
                               IsFrozen = "true" Freeze="FreezeDirection.Right" AllowReordering="false">
                        <Template>
                            @{
                                var personalMedical = context as PersonalMedicalModel;
                                <div class="action-buttons medical-actions">
                                    <button class="btn-action btn-view" @onclick="() => ShowPersonalMedicalDetailModal(personalMedical!)" 
                                            title="Vizualizeaza detaliile personalului medical" aria-label="Vizualizeaza">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn-action btn-edit" @onclick="() => EditPersonalMedical(personalMedical!)" 
                                            title="Modifica personalul medical" aria-label="Modifica">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-action btn-delete" @onclick="() => DeletePersonalMedical(personalMedical!)" 
                                            title="Sterge personalul medical" aria-label="Sterge">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            }
                        </Template>
                    </GridColumn>
                </GridColumns>
            </SfGrid>
        </div>
    }

    @* Personal Medical Detail Modal - WITH MEDICAL THEME *@
    <SfDialog @ref="PersonalMedicalDetailModal" 
              Width="900px" 
              Height="700px"
              IsModal="true" 
              Visible="@_state.IsModalVisible"
              ShowCloseIcon="true"
              AllowDragging="true"
              CssClass="personal-medical-dialog detail-dialog"
              AnimationSettings="@DialogAnimation">
        
        @* TOAST ÎN MODAL *@
        <SfToast @ref="ModalToastRef" 
                 Title="Personal Medical Details" 
                 Target=".personal-medical-dialog" 
                 NewestOnTop="true" 
                 ShowProgressBar="true"
                 CssClass="modal-toast">
        </SfToast>
        
        <DialogEvents Closed="OnModalClosed" />
        <DialogTemplates>
            <Header>
                <div class="modal-header-content medical-header">
                    <i class="fas fa-user-md modal-header-icon"></i>
                    <div>
                        <h3 class="modal-header-title">@_state.SelectedPersonalMedical?.NumeComplet</h3>
                        <p class="modal-header-subtitle">Detalii personal medical</p>
                    </div>
                </div>
            </Header>
            <Content>
                @if (_state.SelectedPersonalMedical != null)
                {
                    @* TODO: Create VizualizeazaPersonalMedical component *@
                    <div class="placeholder-content">
                        <h3>@_state.SelectedPersonalMedical.NumeComplet</h3>
                        <p>Personal medical details will be displayed here when VizualizeazaPersonalMedical component is created.</p>
                        
                        <div class="personal-medical-details">
                            <p><strong>Poziție:</strong> @_state.SelectedPersonalMedical.Pozitie?.GetDisplayName()</p>
                            <p><strong>Specializare:</strong> @_state.SelectedPersonalMedical.Specializare</p>
                            <p><strong>Nr. Licență:</strong> @_state.SelectedPersonalMedical.NumarLicenta</p>
                            <p><strong>Email:</strong> @_state.SelectedPersonalMedical.Email</p>
                            <p><strong>Telefon:</strong> @_state.SelectedPersonalMedical.Telefon</p>
                            <p><strong>Departament:</strong> @_state.SelectedPersonalMedical.DepartamentDisplay</p>
                            <p><strong>Status:</strong> @(_state.SelectedPersonalMedical.EsteActiv ? "Activ" : "Inactiv")</p>
                            <p><strong>Data Creării:</strong> @_state.SelectedPersonalMedical.DataCreare.ToString("dd.MM.yyyy")</p>
                        </div>
                    </div>
                }
            </Content>
            <FooterTemplate>
                <div class="modal-footer-actions">
                    <button class="btn btn-success" @onclick="EditPersonalMedicalFromModal">
                        <i class="fas fa-edit"></i> Editeaza Personal Medical
                    </button>
                    <button class="btn btn-secondary" @onclick="ClosePersonalMedicalDetailModal">
                        <i class="fas fa-times"></i> Inchide
                    </button>
                </div>
            </FooterTemplate>
        </DialogTemplates>
    </SfDialog>

    @* Add/Edit Personal Medical Modal - USING SEPARATE COMPONENT *@
    <SfDialog @ref="AddEditPersonalMedicalModal" 
              Width="900px" 
              Height="700px"
              IsModal="true" 
              Visible="@_state.IsAddEditModalVisible"
              ShowCloseIcon="true"
              AllowDragging="true"
              CssClass="personal-medical-dialog edit-dialog"
              AnimationSettings="@DialogAnimation">
        <DialogEvents Closed="OnAddEditModalClosed" />
        <DialogTemplates>
            <Header>
                <div class="modal-header-content medical-header">
                    <i class="fas fa-user-plus modal-header-icon"></i>
                    <div>
                        <h3 class="modal-header-title">@_state.GetModalTitle()</h3>
                        <p class="modal-header-subtitle">@_state.GetModalSubtitle()</p>
                    </div>
                </div>
            </Header>
            <Content>
                @* TODO: Create AdaugaEditezaPersonalMedical component *@
                <div class="placeholder-content">
                    <h3>@_state.GetModalTitle()</h3>
                    <p>@_state.GetModalSubtitle()</p>
                    
                    <div class="form-placeholder">
                        <p>Add/Edit personal medical form will be displayed here when AdaugaEditezaPersonalMedical component is created.</p>
                        
                        @if (_state.IsEditMode && _state.EditingPersonalMedical != null)
                        {
                            <div class="editing-info">
                                <h4>Editing: @_state.EditingPersonalMedical.NumeComplet</h4>
                                <p>Position: @_state.EditingPersonalMedical.Pozitie?.GetDisplayName()</p>
                                <p>Specialization: @_state.EditingPersonalMedical.Specializare</p>
                            </div>
                        }
                        else
                        {
                            <div class="adding-info">
                                <h4>Adding new medical staff member</h4>
                                <p>Fill in the form to add a new medical professional.</p>
                            </div>
                        }
                    </div>
                </div>
            </Content>
            <FooterTemplate>
                <div class="modal-footer-actions">
                    <button class="btn btn-success" @onclick="HandleFormSubmit" disabled="@_state.IsLoading">
                        <i class="fas fa-save"></i>
                        @(_state.IsEditMode ? "Actualizeaza Personal Medical" : "Adauga Personal Medical")
                    </button>
                    <button class="btn btn-secondary" @onclick="CloseAddEditModal" disabled="@_state.IsLoading">
                        <i class="fas fa-times"></i>
                        Anuleaza
                    </button>
                </div>
            </FooterTemplate>
        </DialogTemplates>
    </SfDialog>
</div>
