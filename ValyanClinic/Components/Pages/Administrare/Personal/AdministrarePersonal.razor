@page "/administrare/personal"
@rendermode InteractiveServer
@using ValyanClinic.Application.Features.PersonalManagement.Queries.GetPersonalList
@using MediatR
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Notifications
@using Syncfusion.Blazor.DropDowns
@using FilterType = Syncfusion.Blazor.Grids.FilterType

<PageTitle>Administrare Personal</PageTitle>

<div class="personal-container">
    <div class="personal-header">
        <h1>
            <i class="fas fa-users"></i>
            Administrare Personal
        </h1>
        <div class="header-actions">
            <button class="btn btn-primary" @onclick="HandleAddNew">
                <i class="fas fa-plus"></i>
                Adauga Personal
            </button>
            <button class="btn btn-secondary" @onclick="HandleRefresh">
                <i class="fas fa-sync-alt"></i>
                Reincarca
            </button>
        </div>
    </div>

    @if (IsLoading)
    {
        <div class="loading-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Se incarca...</span>
            </div>
            <p>Se incarca datele...</p>
        </div>
    }
    else if (HasError)
    {
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            @ErrorMessage
        </div>
    }
    else
    {
        <!-- Page Size Selector -->
        <div class="page-size-selector">
            <div class="selector-wrapper">
                <div class="page-size-controls">
                    <label class="selector-label">
                        <i class="fas fa-list"></i>
                        Inregistrari per pagina:
                    </label>
                    <SfDropDownList TValue="int" TItem="PageSizeOption" 
                                   DataSource="@PageSizeOptions" 
                                   Value="@CurrentPageSize"
                                   ValueChanged="@OnPageSizeChanged"
                                   CssClass="page-size-dropdown"
                                   Width="100px">
                        <DropDownListFieldSettings Text="Text" Value="Value"/>
                    </SfDropDownList>
                </div>
                <div class="total-records">
                    <i class="fas fa-database"></i>
                    <span>Total: <strong>@AllPersonalList.Count</strong> inregistrari</span>
                </div>
            </div>
        </div>

        <div class="grid-container">
            <SfGrid DataSource="@PagedPersonalList"
                    Height="100%"
                    AllowPaging="false"
                    AllowSorting="true"
                    AllowFiltering="true"
                    AllowResizing="true"
                    AllowTextWrap="true"
                    GridLines="GridLine.Both">
                
                <GridFilterSettings Type="FilterType.Menu"></GridFilterSettings>
                
                <GridSelectionSettings Type="SelectionType.Single"></GridSelectionSettings>
                
                <GridEvents TValue="PersonalListDto" 
                           RowSelected="OnRowSelected"
                           CommandClicked="OnCommandClicked">
                </GridEvents>
                
                <GridColumns>
                    <GridColumn Field="@nameof(PersonalListDto.Cod_Angajat)" 
                               HeaderText="Cod" 
                               Width="100"
                               IsPrimaryKey="true">
                    </GridColumn>
                    
                    <GridColumn Field="@nameof(PersonalListDto.Nume)" 
                               HeaderText="Nume" 
                               Width="150">
                    </GridColumn>
                    
                    <GridColumn Field="@nameof(PersonalListDto.Prenume)" 
                               HeaderText="Prenume" 
                               Width="150">
                    </GridColumn>
                    
                    <GridColumn Field="@nameof(PersonalListDto.CNP)" 
                               HeaderText="CNP" 
                               Width="130">
                    </GridColumn>
                    
                    <GridColumn Field="@nameof(PersonalListDto.Telefon_Personal)" 
                               HeaderText="Telefon" 
                               Width="120">
                        <Template>
                            @{
                                var personal = (context as PersonalListDto);
                                if (!string.IsNullOrEmpty(personal?.Telefon_Personal))
                                {
                                    <a href="tel:@personal.Telefon_Personal" class="phone-link">
                                        <i class="fas fa-phone"></i>
                                        @personal.Telefon_Personal
                                    </a>
                                }
                            }
                        </Template>
                    </GridColumn>
                    
                    <GridColumn Field="@nameof(PersonalListDto.Email_Personal)" 
                               HeaderText="Email" 
                               Width="200">
                        <Template>
                            @{
                                var personal = (context as PersonalListDto);
                                if (!string.IsNullOrEmpty(personal?.Email_Personal))
                                {
                                    <a href="mailto:@personal.Email_Personal" class="email-link">
                                        <i class="fas fa-envelope"></i>
                                        @personal.Email_Personal
                                    </a>
                                }
                            }
                        </Template>
                    </GridColumn>
                    
                    <GridColumn Field="@nameof(PersonalListDto.Functia)" 
                               HeaderText="Functie" 
                               Width="150">
                    </GridColumn>
                    
                    <GridColumn Field="@nameof(PersonalListDto.Departament)" 
                               HeaderText="Departament" 
                               Width="150">
                    </GridColumn>
                    
                    <GridColumn Field="@nameof(PersonalListDto.Status_Angajat)" 
                               HeaderText="Status" 
                               Width="100">
                        <Template>
                            @{
                                var personal = (context as PersonalListDto);
                                var statusClass = personal?.Status_Angajat == "Activ" ? "status-active" : "status-inactive";
                                <span class="status-badge @statusClass">
                                    @personal?.Status_Angajat
                                </span>
                            }
                        </Template>
                    </GridColumn>
                    
                    <GridColumn HeaderText="Actiuni" Width="180" TextAlign="TextAlign.Center">
                        <GridCommandColumns>
                            <GridCommandColumn Type="CommandButtonType.None" 
                                             ButtonOption="@(new CommandButtonOptions() 
                                             { 
                                                 Content = "Vizualizeaza", 
                                                 CssClass = "e-flat btn-view",
                                                 IconCss = "fas fa-eye"
                                             })">
                            </GridCommandColumn>
                            <GridCommandColumn Type="CommandButtonType.None" 
                                             ButtonOption="@(new CommandButtonOptions() 
                                             { 
                                                 Content = "Editeaza", 
                                                 CssClass = "e-flat btn-edit",
                                                 IconCss = "fas fa-edit"
                                             })">
                            </GridCommandColumn>
                            <GridCommandColumn Type="CommandButtonType.None" 
                                             ButtonOption="@(new CommandButtonOptions() 
                                             { 
                                                 Content = "Sterge", 
                                                 CssClass = "e-flat btn-delete",
                                                 IconCss = "fas fa-trash"
                                             })">
                            </GridCommandColumn>
                        </GridCommandColumns>
                    </GridColumn>
                </GridColumns>
            </SfGrid>
        </div>

        <!-- Custom Pager -->
        <div class="custom-pager">
            <div class="pager-info">
                <i class="fas fa-info-circle"></i>
                <span>Pagina @GetCurrentPage() din @GetTotalPages()</span>
                <span class="separator">|</span>
                <span>Afisate @GetDisplayedRecordsStart()-@GetDisplayedRecordsEnd() din @AllPersonalList.Count</span>
            </div>
            <div class="pager-controls">
                <button class="pager-btn @(GetCurrentPage() == 1 ? "disabled" : "")" 
                        @onclick="() => GoToPage(1)" 
                        disabled="@(GetCurrentPage() == 1)"
                        title="Prima pagina">
                    <i class="fas fa-angle-double-left"></i>
                </button>
                <button class="pager-btn @(GetCurrentPage() == 1 ? "disabled" : "")" 
                        @onclick="() => GoToPage(GetCurrentPage() - 1)" 
                        disabled="@(GetCurrentPage() == 1)"
                        title="Pagina anterioara">
                    <i class="fas fa-angle-left"></i>
                </button>
                
                @for (int i = GetPagerStart(); i <= GetPagerEnd(); i++)
                {
                    int pageNum = i;
                    <button class="pager-btn page-number @(GetCurrentPage() == pageNum ? "active" : "")" 
                            @onclick="() => GoToPage(pageNum)">
                        @pageNum
                    </button>
                }
                
                <button class="pager-btn @(GetCurrentPage() == GetTotalPages() ? "disabled" : "")" 
                        @onclick="() => GoToPage(GetCurrentPage() + 1)" 
                        disabled="@(GetCurrentPage() == GetTotalPages())"
                        title="Pagina urmatoare">
                    <i class="fas fa-angle-right"></i>
                </button>
                <button class="pager-btn @(GetCurrentPage() == GetTotalPages() ? "disabled" : "")" 
                        @onclick="() => GoToPage(GetTotalPages())" 
                        disabled="@(GetCurrentPage() == GetTotalPages())"
                        title="Ultima pagina">
                    <i class="fas fa-angle-double-right"></i>
                </button>
            </div>
            <div class="jump-to-page">
                <span>Sari la:</span>
                <input type="number" @bind="jumpToPageNumber" @onkeypress="OnJumpToPageKeyPress" 
                       min="1" max="@GetTotalPages()" class="page-input" />
                <button class="pager-btn" @onclick="JumpToPage" title="Sari la pagina">
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    }
</div>

@* Toast pentru notificari *@
<SfToast @ref="ToastRef" Title="@ToastTitle" Content="@ToastContent" CssClass="@ToastCssClass">
    <ToastPosition X="Right" Y="Top"></ToastPosition>
</SfToast>
