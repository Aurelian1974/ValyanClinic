@page "/administrare/personal"
@rendermode InteractiveServer
@using ValyanClinic.Application.Services
@using ValyanClinic.Domain.Models
@using ValyanClinic.Domain.Enums
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Notifications
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Popups
@using GridSelectionType = Syncfusion.Blazor.Grids.SelectionType
@using GridSelectionMode = Syncfusion.Blazor.Grids.SelectionMode
@using GridSortDirection = Syncfusion.Blazor.Grids.SortDirection
@using GridFilterType = Syncfusion.Blazor.Grids.FilterType
@using PersonalModel = ValyanClinic.Domain.Models.Personal

<PageTitle>Administrare Personal - ValyanMed</PageTitle>

@* INCLUDE CSS SPECIFIC PENTRU PERSONAL PAGE *@
<link href="~/css/pages/administrare-personal.css" rel="stylesheet" />

<div class="personal-page-container">
    
    @* Error Display *@
    @if (_state.HasError)
    {
        <div class="alert alert-danger d-flex align-items-center">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <div class="flex-1">@_state.ErrorMessage</div>
            <button class="btn-close" @onclick="_state.ClearError" aria-label="Close"></button>
        </div>
    }

    @* Page Header - UPDATED WITH KEBAB MENU *@
    <div class="personal-page-header">
        <div class="header-content">
            <div class="header-text">
                <h1 class="personal-page-title">
                    <i class="fas fa-users"></i>
                    Administrare Personal
                </h1>
                <p class="personal-page-subtitle">
                    Gestioneaza personalul clinicii - functii administrative si de suport
                </p>
            </div>
            
            <div class="personal-header-actions">
                <button class="btn btn-outline-primary" @onclick="ShowAddPersonalModal">
                    <i class="fas fa-plus"></i>
                    <span class="btn-text">Adauga Personal</span>
                </button>
                <button class="btn btn-outline-secondary" @onclick="RefreshData">
                    <i class="fas fa-sync-alt"></i>
                    <span class="btn-text">Actualizeaza</span>
                </button>
                
                @* Kebab Menu Button *@
                <div class="kebab-menu-container">
                    <button class="btn btn-outline-secondary kebab-menu-btn" 
                            @onclick="ToggleKebabMenu"
                            @onclick:stopPropagation="true"
                            aria-label="Meniu opțiuni"
                            aria-expanded="@_state.ShowKebabMenu.ToString().ToLower()"
                            aria-haspopup="true">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    
                    @if (_state.ShowKebabMenu)
                    {
                        <div class="kebab-menu-dropdown" 
                             @onclick:stopPropagation="true"
                             role="menu"
                             aria-label="Opțiuni disponibile">
                            <button class="kebab-menu-item" 
                                    @onclick="() => ToggleStatistics()"
                                    role="menuitem"
                                    aria-label="Comută afișarea statisticilor">
                                <i class="fas fa-chart-bar"></i>
                                <span>Statistici</span>
                                @if (_state.ShowStatistics)
                                {
                                    <i class="fas fa-check kebab-check" aria-label="Activat"></i>
                                }
                            </button>
                            <button class="kebab-menu-item" 
                                    @onclick="() => ToggleAdvancedFilters()"
                                    role="menuitem"
                                    aria-label="Comută afișarea filtrelor avansate">
                                <i class="fas fa-filter"></i>
                                <span>Filtrare Avansata</span>
                                @if (_state.ShowAdvancedFilters)
                                {
                                    <i class="fas fa-check kebab-check" aria-label="Activat"></i>
                                }
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    @* Statistics Cards - CONDITIONAL DISPLAY *@
    @if (!_state.IsLoading && _state.ShowStatistics)
    {
        <div class="personal-stats-grid">
            @foreach (var stat in _models.PersonalStatistics)
            {
                <div class="personal-stat-card">
                    <div class="personal-stat-number">@stat.Value</div>
                    <div class="personal-stat-label">@stat.Label</div>
                </div>
            }
        </div>
    }

    @* Toast Notification *@
    <SfToast @ref="ToastRef" Title="ValyanMed" Target="body" NewestOnTop="true" ShowProgressBar="true"></SfToast>

    @* Advanced Filter Panel - CONDITIONAL DISPLAY *@
    @if (_state.ShowAdvancedFilters)
    {
        <div class="personal-advanced-filter-panel">
            <div class="filter-panel-header">
                <h3>
                    <i class="fas fa-filter"></i>
                    Filtrare Avansata
                </h3>
                <button class="btn btn-secondary btn-sm" @onclick="() => ToggleAdvancedFilters()">
                    <i class="fas fa-chevron-up"></i>
                    <span>Ascunde Filtrele</span>
                </button>
            </div>
            
            <div class="filter-panel-content">
                @* First row - Departament, Status, Search *@
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Departament:</label>
                        <SfDropDownList TItem="PersonalModels.FilterOption<Departament?>" TValue="Departament?" 
                                       DataSource="@_models.DepartmentFilterOptions" 
                                       @bind-Value="@_state.SelectedDepartmentFilter"
                                       Placeholder="Toate departamentele"
                                       AllowFiltering="true"
                                       PopupHeight="200px"
                                       Width="180px">
                            <DropDownListFieldSettings Text="Text" Value="Value" />
                            <DropDownListEvents TItem="PersonalModels.FilterOption<Departament?>" TValue="Departament?" ValueChange="OnDepartmentFilterChanged" />
                        </SfDropDownList>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Status:</label>
                        <SfDropDownList TItem="PersonalModels.FilterOption<StatusAngajat?>" TValue="StatusAngajat?" 
                                       DataSource="@_models.StatusFilterOptions" 
                                       @bind-Value="@_state.SelectedStatusFilter"
                                       Placeholder="Toate statusurile"
                                       AllowFiltering="true"
                                       PopupHeight="200px"
                                       Width="150px">
                            <DropDownListFieldSettings Text="Text" Value="Value" />
                            <DropDownListEvents TItem="PersonalModels.FilterOption<StatusAngajat?>" TValue="StatusAngajat?" ValueChange="OnStatusFilterChanged" />
                        </SfDropDownList>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Cautare text:</label>
                        <SfTextBox @bind-Value="@_state.SearchText" 
                                  Placeholder="Cauta in nume, prenume, email..."
                                  Width="250px"
                                  ShowClearButton="true">
                            <TextBoxEvents ValueChange="OnSearchTextChanged" />
                        </SfTextBox>
                    </div>
                </div>
                
                @* Second row - Additional filters *@
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Perioada activitate:</label>
                        <SfDropDownList TItem="string" TValue="string" 
                                       DataSource="@_models.ActivityPeriodOptions" 
                                       @bind-Value="@_state.SelectedActivityPeriod"
                                       Placeholder="Orice perioada"
                                       Width="180px">
                            <DropDownListEvents TItem="string" TValue="string" ValueChange="OnActivityPeriodChanged" />
                        </SfDropDownList>
                    </div>
                    
                    @* Empty spaces for layout balance *@
                    <div class="filter-group"></div>
                    <div class="filter-group"></div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn btn-primary btn-sm" @onclick="ApplyAdvancedFilters">
                        <i class="fas fa-check"></i>
                        <span>Aplica Filtrele</span>
                    </button>
                    <button class="btn btn-secondary btn-sm" @onclick="ClearAdvancedFilters">
                        <i class="fas fa-times"></i>
                        <span>Curata Filtrele</span>
                    </button>
                    <button class="btn btn-info btn-sm" @onclick="ExportFilteredData">
                        <i class="fas fa-download"></i>
                        <span>Exporta Rezultate</span>
                    </button>
                </div>
                
                @* Filter Results Summary *@
                <div class="filter-results-summary">
                    <div class="results-info">
                        <span class="results-count">
                            <i class="fas fa-search"></i>
                            Rezultate: <strong>@_models.FilteredPersonal.Count</strong> din <strong>@_models.Personal.Count</strong> angajati
                        </span>
                        @if (_state.IsAnyFilterActive)
                        {
                            <span class="filtered-indicator">
                                <i class="fas fa-filter"></i>
                                Filtrare activa
                            </span>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    @* Main DataGrid - SIMILAR CU UTILIZATORI *@
    @if (_state.IsLoading)
    {
        <div class="personal-grid-container">
            <div class="loading-indicator text-center p-5">
                <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                <div class="mt-3">Se incarca personalul...</div>
            </div>
        </div>
    }
    else
    {
        <div class="personal-grid-container">
            <SfGrid @ref="GridRef" DataSource="@_models.FilteredPersonal" 
                    AllowPaging="true" 
                    AllowSorting="true" 
                    AllowFiltering="true"
                    AllowGrouping="true"
                    AllowSelection="true"
                    AllowReordering="true"
                    AllowResizing="true"
                    ShowColumnMenu="true">
                
                @* Grid Events *@
                <GridEvents TValue="PersonalModel" 
                           RowSelected="RowSelected"
                           RowDeselected="RowDeselected">
                </GridEvents>

                @* Selection Settings *@
                <GridSelectionSettings Type="GridSelectionType.Multiple" Mode="GridSelectionMode.Row"></GridSelectionSettings>

                @* Page Settings *@
                <GridPageSettings PageSize="10" PageSizes="@_models.PageSizes"></GridPageSettings>

                @* Sort Settings *@
                <GridSortSettings AllowUnsort="true">
                    <GridSortColumns>
                        <GridSortColumn Field="Nume" Direction="GridSortDirection.Ascending"></GridSortColumn>
                    </GridSortColumns>
                </GridSortSettings>

                @* Filter Settings *@
                <GridFilterSettings Type="GridFilterType.Excel" 
                                  Mode="FilterBarMode.Immediate"
                                  ShowFilterBarStatus="true"
                                  ImmediateModeDelay="500">
                </GridFilterSettings>

                @* Group Settings *@
                <GridGroupSettings ShowDropArea="true" ShowToggleButton="true" ShowGroupedColumn="true">
                    <GridGroupColumns>
                        <GridGroupColumn Field="Departament"></GridGroupColumn>
                    </GridGroupColumns>
                </GridGroupSettings>

                @* Columns Definition - OPTIMIZED FOR SCREEN WIDTH *@
                <GridColumns>
                    <GridColumn Field="@nameof(PersonalModel.Cod_Angajat)" HeaderText="Cod" Width="80" TextAlign="TextAlign.Center" 
                               IsPrimaryKey="false" AllowFiltering="true" AllowReordering="false"></GridColumn>
                    <GridColumn Field="@nameof(PersonalModel.Nume)" HeaderText="Nume" Width="100" AllowFiltering="true" AllowReordering="true"></GridColumn>
                    <GridColumn Field="@nameof(PersonalModel.Prenume)" HeaderText="Prenume" Width="100" AllowFiltering="true" AllowReordering="true"></GridColumn>
                    <GridColumn Field="@nameof(PersonalModel.Email_Personal)" HeaderText="Email" Width="160" AllowFiltering="true" AllowReordering="true"></GridColumn>
                    <GridColumn Field="@nameof(PersonalModel.Telefon_Personal)" HeaderText="Telefon" Width="90" AllowFiltering="true" AllowReordering="true"></GridColumn>
                    <GridColumn Field="@nameof(PersonalModel.Functia)" HeaderText="Functia" Width="100" AllowFiltering="true" AllowReordering="true"></GridColumn>
                               
                    <GridColumn Field="@nameof(PersonalModel.Departament)" HeaderText="Departament" Width="100" 
                               AllowFiltering="true" AllowReordering="true">
                        <Template>
                            @{                                               
                                var personal = context as PersonalModel;
                                <span>@GetDepartamentDisplay(personal!.Departament)</span>
                            }
                        </Template>
                    </GridColumn>
                               
                    <GridColumn Field="@nameof(PersonalModel.Status_Angajat)" HeaderText="Status" Width="70" 
                               AllowFiltering="true" AllowReordering="true">
                        <Template>
                            @{                                               
                                var personal = context as PersonalModel;
                                <span class="status-badge status-@personal!.Status_Angajat.ToString().ToLower()">
                                    @GetStatusDisplay(personal.Status_Angajat)
                                </span>
                            }
                        </Template>
                    </GridColumn>
                               
                    <GridColumn Field="@nameof(PersonalModel.Data_Crearii)" HeaderText="Data Crearii" Width="90" 
                               Format="dd.MM.yyyy" Type="ColumnType.Date" AllowFiltering="true" AllowReordering="true"></GridColumn>
                               
                    @* Actions Column - FROZEN RIGHT *@
                    <GridColumn HeaderText="Actiuni" Width="120" AllowFiltering="false" AllowSorting="false"
                               IsFrozen = "true" Freeze="FreezeDirection.Right" AllowReordering="false">
                        <Template>
                            @{
                                var personal = context as PersonalModel;
                                <div class="action-buttons">
                                    <button class="btn-action btn-view" @onclick="() => ShowPersonalDetailModal(personal!)" 
                                            title="Vizualizeaza detaliile personalului" aria-label="Vizualizeaza">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn-action btn-edit" @onclick="() => EditPersonal(personal!)" 
                                            title="Modifica personalul" aria-label="Modifica">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-action btn-delete" @onclick="() => DeletePersonal(personal!)" 
                                            title="Sterge personalul" aria-label="Sterge">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            }
                        </Template>
                    </GridColumn>
                </GridColumns>
            </SfGrid>
        </div>
    }

    @* Personal Detail Modal - CU TOAST PROPRIU *@
    <SfDialog @ref="PersonalDetailModal" 
              Width="900px" 
              Height="700px"
              IsModal="true" 
              Visible="@_state.IsModalVisible"
              ShowCloseIcon="true"
              AllowDragging="true"
              CssClass="personal-dialog detail-dialog"
              AnimationSettings="@DialogAnimation">
        
        @* TOAST ÎN MODAL - FĂRĂ PROPRIETATEA POSITION PROBLEMATICĂ *@
        <SfToast @ref="ModalToastRef" 
                 Title="Personal Details" 
                 Target=".personal-dialog" 
                 NewestOnTop="true" 
                 ShowProgressBar="true"
                 CssClass="modal-toast">
        </SfToast>
        
        <DialogEvents Closed="OnModalClosed" />
        <DialogTemplates>
            <Header>
                <div class="modal-header-content">
                    <i class="fas fa-user-circle modal-header-icon"></i>
                    <div>
                        <h3 class="modal-header-title">@_state.SelectedPersonal?.NumeComplet</h3>
                        <p class="modal-header-subtitle">Detalii personal</p>
                    </div>
                </div>
            </Header>
            <Content>
                @if (_state.SelectedPersonal != null)
                {
                    <VizualizeazaPersonal PersonalData="@_state.SelectedPersonal" 
                                        OnToastMessage="@HandleModalToast" />
                }
            </Content>
            <FooterTemplate>
                <div class="modal-footer-actions">
                    <button class="btn btn-primary" @onclick="EditPersonalFromModal">
                        <i class="fas fa-edit"></i> Editeaza Personal
                    </button>
                    <button class="btn btn-secondary" @onclick="ClosePersonalDetailModal">
                        <i class="fas fa-times"></i> Inchide
                    </button>
                </div>
            </FooterTemplate>
        </DialogTemplates>
    </SfDialog>

    @* Add/Edit Personal Modal - USING SEPARATE COMPONENT *@
    <SfDialog @ref="AddEditPersonalModal" 
              Width="900px" 
              Height="700px"
              IsModal="true" 
              Visible="@_state.IsAddEditModalVisible"
              ShowCloseIcon="true"
              AllowDragging="true"
              CssClass="personal-dialog edit-dialog"
              AnimationSettings="@DialogAnimation">
        <DialogEvents Closed="OnAddEditModalClosed" />
        <DialogTemplates>
            <Header>
                <div class="modal-header-content">
                    <i class="fas fa-user-plus modal-header-icon"></i>
                    <div>
                        <h3 class="modal-header-title">@_state.GetModalTitle()</h3>
                        <p class="modal-header-subtitle">@_state.GetModalSubtitle()</p>
                    </div>
                </div>
            </Header>
            <Content>
                @if (_state.IsEditMode && _state.EditingPersonal != null)
                {
                    <AdaugaEditezaPersonal @ref="_currentFormComponent" 
                                          EditingPersonal="@_state.EditingPersonal"
                                          OnSave="@SavePersonal" 
                                          OnCancel="@CloseAddEditModal" />
                }
                else
                {
                    <AdaugaEditezaPersonal @ref="_currentFormComponent" 
                                          OnSave="@SavePersonal" 
                                          OnCancel="@CloseAddEditModal" />
                }
            </Content>
            <FooterTemplate>
                <div class="modal-footer-actions">
                    <button class="btn btn-primary" @onclick="HandleFormSubmit" disabled="@_state.IsLoading">
                        <i class="fas fa-save"></i>
                        @(_state.IsEditMode ? "Actualizeaza Personal" : "Adauga Personal")
                    </button>
                    <button class="btn btn-secondary" @onclick="CloseAddEditModal" disabled="@_state.IsLoading">
                        <i class="fas fa-times"></i>
                        Anuleaza
                    </button>
                </div>
            </FooterTemplate>
        </DialogTemplates>
    </SfDialog>
</div>
