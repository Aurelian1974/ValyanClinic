@page "/administrare/personal"
@rendermode InteractiveServer
@using ValyanClinic.Application.Services
@using ValyanClinic.Domain.Models
@using ValyanClinic.Domain.Enums
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Popups
@using Syncfusion.Blazor.SplitButtons
@using GridSelectionType = Syncfusion.Blazor.Grids.SelectionType
@using GridSelectionMode = Syncfusion.Blazor.Grids.SelectionMode
@using GridSortDirection = Syncfusion.Blazor.Grids.SortDirection
@using GridFilterType = Syncfusion.Blazor.Grids.FilterType
@using PersonalModel = ValyanClinic.Domain.Models.Personal

<PageTitle>Administrare Personal - ValyanMed</PageTitle>

@* INCLUDE CSS SPECIFIC PENTRU PERSONAL PAGE *@
<link href="~/css/pages/administrare-personal.css" rel="stylesheet" />

<div class="personal-page-container">
    
    @* Error Display *@
    @if (_state.HasError)
    {
        <div class="alert alert-danger d-flex align-items-center">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <div class="flex-1">@_state.ErrorMessage</div>
            <button class="btn-close" @onclick="_state.ClearError" aria-label="Close"></button>
        </div>
    }

    @* Page Header - SIMPLIFIED WITHOUT KEBAB MENU *@
    <div class="personal-page-header">
        <div class="header-content">
            <div class="header-text">
                <h1 class="personal-page-title">
                    <i class="fas fa-users"></i>
                    Administrare Personal
                </h1>
                <p class="personal-page-subtitle">
                    Gestioneaza personalul clinicii - functii administrative si de suport
                </p>
            </div>
            
            <div class="personal-header-actions">
                <button class="btn btn-outline-primary" @onclick="ShowAddPersonalModal">
                    <i class="fas fa-plus"></i>
                    <span class="btn-text">Adauga Personal</span>
                </button>
                <button class="btn btn-outline-secondary" @onclick="RefreshData">
                    <i class="fas fa-sync-alt"></i>
                    <span class="btn-text">Actualizeaza</span>
                </button>
            </div>
        </div>
    </div>

    @* Main DataGrid - WITHOUT ADVANCED FILTERING *@
    @if (_state.IsLoading)
    {
        <div class="personal-grid-container">
            <div class="loading-indicator text-center p-5">
                <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                <div class="mt-3">Se incarca personalul...</div>
            </div>
        </div>
    }
    else
    {
        <div class="personal-grid-container">
            <SfGrid @ref="GridRef" DataSource="@_models.FilteredPersonal" 
                    AllowPaging="true" 
                    AllowSorting="true" 
                    AllowFiltering="true"
                    AllowGrouping="true"
                    AllowSelection="true"
                    AllowReordering="true"
                    AllowResizing="true"
                    ShowColumnMenu="true">
                
                @* Grid Events *@
                <GridEvents TValue="PersonalModel" 
                           RowSelected="RowSelected"
                           RowDeselected="RowDeselected">
                </GridEvents>

                @* Selection Settings *@
                <GridSelectionSettings Type="GridSelectionType.Multiple" Mode="GridSelectionMode.Row"></GridSelectionSettings>

                @* Page Settings *@
                <GridPageSettings PageSize="10" PageSizes="@_models.PageSizes"></GridPageSettings>

                @* Sort Settings *@
                <GridSortSettings AllowUnsort="true">
                    <GridSortColumns>
                        <GridSortColumn Field="Nume" Direction="GridSortDirection.Ascending"></GridSortColumn>
                    </GridSortColumns>
                </GridSortSettings>

                @* Filter Settings *@
                <GridFilterSettings Type="GridFilterType.Excel" 
                                  Mode="FilterBarMode.Immediate"
                                  ShowFilterBarStatus="true"
                                  ImmediateModeDelay="500">
                </GridFilterSettings>

                @* Group Settings *@
                <GridGroupSettings ShowDropArea="true" ShowToggleButton="true" ShowGroupedColumn="true">
                    <GridGroupColumns>
                        <GridGroupColumn Field="Departament"></GridGroupColumn>
                    </GridGroupColumns>
                </GridGroupSettings>

                @* Columns Definition - WITH ACTIONS COLUMN *@
                <GridColumns>
                    <GridColumn Field="@nameof(PersonalModel.Cod_Angajat)" HeaderText="Cod" Width="80" TextAlign="TextAlign.Center" 
                               IsPrimaryKey="false" AllowFiltering="true" AllowReordering="false"></GridColumn>
                    <GridColumn Field="@nameof(PersonalModel.Nume)" HeaderText="Nume" Width="100" AllowFiltering="true" AllowReordering="true"></GridColumn>
                    <GridColumn Field="@nameof(PersonalModel.Prenume)" HeaderText="Prenume" Width="100" AllowFiltering="true" AllowReordering="true"></GridColumn>
                    <GridColumn Field="@nameof(PersonalModel.Email_Personal)" HeaderText="Email" Width="150" AllowFiltering="true" AllowReordering="true"></GridColumn>
                    <GridColumn Field="@nameof(PersonalModel.Telefon_Personal)" HeaderText="Telefon" Width="90" AllowFiltering="true" AllowReordering="true"></GridColumn>
                    <GridColumn Field="@nameof(PersonalModel.Functia)" HeaderText="Functia" Width="100" AllowFiltering="true" AllowReordering="true"></GridColumn>
                               
                    <GridColumn Field="@nameof(PersonalModel.Departament)" HeaderText="Departament" Width="100" 
                               AllowFiltering="true" AllowReordering="true">
                        <Template>
                            @{                                               
                                var personal = context as PersonalModel;
                                <span>@GetDepartamentDisplay(personal!.Departament)</span>
                            }
                        </Template>
                    </GridColumn>
                               
                    <GridColumn Field="@nameof(PersonalModel.Status_Angajat)" HeaderText="Status" Width="70" 
                               AllowFiltering="true" AllowReordering="true">
                        <Template>
                            @{                                               
                                var personal = context as PersonalModel;
                                <span class="status-badge status-@personal!.Status_Angajat.ToString().ToLower()">
                                    @GetStatusDisplay(personal.Status_Angajat)
                                </span>
                            }
                        </Template>
                    </GridColumn>
                               
                    <GridColumn Field="@nameof(PersonalModel.Data_Crearii)" HeaderText="Data Crearii" Width="90" 
                               Format="dd.MM.yyyy" Type="ColumnType.Date" AllowFiltering="true" AllowReordering="true"></GridColumn>
                    
                    @* Actions Column with Dropdown - FIXED CONFIGURATION *@
                    <GridColumn HeaderText="Actiuni" Width="70" AllowFiltering="false" AllowSorting="false" 
                               AllowReordering="false" AllowResizing="false" TextAlign="TextAlign.Center">
                        <Template>
                            @{
                                var personal = context as PersonalModel;
                                <div class="action-dropdown-container">
                                    <SfDropDownButton Content="" 
                                                    CssClass="action-dropdown-btn" 
                                                    IconCss="fas fa-ellipsis-v"
                                                    Target="body">
                                        <DropDownButtonEvents ItemSelected="@((args) => OnActionSelected(args, personal!))" />
                                        <DropDownMenuItems>
                                            <DropDownMenuItem Id="view" Text="Vizualizeaza" IconCss="fas fa-eye"></DropDownMenuItem>
                                            <DropDownMenuItem Id="edit" Text="Editeaza" IconCss="fas fa-edit"></DropDownMenuItem>
                                            <DropDownMenuItem Id="delete" Text="Sterge" IconCss="fas fa-trash"></DropDownMenuItem>
                                        </DropDownMenuItems>
                                    </SfDropDownButton>
                                </div>
                            }
                        </Template>
                    </GridColumn>
                </GridColumns>
            </SfGrid>
        </div>
    }

    @* Personal Detail Modal *@
    <SfDialog @ref="PersonalDetailModal" 
              Width="900px" 
              Height="700px"
              IsModal="true" 
              Visible="@_state.IsModalVisible"
              ShowCloseIcon="true"
              AllowDragging="true"
              CssClass="personal-dialog detail-dialog"
              AnimationSettings="@DialogAnimation">
        
        <DialogEvents Closed="OnModalClosed" />
        <DialogTemplates>
            <Header>
                <div class="modal-header-content">
                    <i class="fas fa-user-circle modal-header-icon"></i>
                    <div>
                        <h3 class="modal-header-title">@_state.SelectedPersonal?.NumeComplet</h3>
                        <p class="modal-header-subtitle">Detalii personal</p>
                    </div>
                </div>
            </Header>
            <Content>
                @if (_state.SelectedPersonal != null)
                {
                    <VizualizeazaPersonal PersonalData="@_state.SelectedPersonal" />
                }
            </Content>
            <FooterTemplate>
                <div class="modal-footer-actions">
                    <button class="btn btn-primary" @onclick="EditPersonalFromModal">
                        <i class="fas fa-edit"></i> Editeaza Personal
                    </button>
                    <button class="btn btn-secondary" @onclick="ClosePersonalDetailModal">
                        <i class="fas fa-times"></i> Inchide
                    </button>
                </div>
            </FooterTemplate>
        </DialogTemplates>
    </SfDialog>

    @* Add/Edit Personal Modal - USING SEPARATE COMPONENT *@
    <SfDialog @ref="AddEditPersonalModal" 
              Width="900px" 
              Height="700px"
              IsModal="true" 
              Visible="@_state.IsAddEditModalVisible"
              ShowCloseIcon="true"
              AllowDragging="true"
              CssClass="personal-dialog edit-dialog"
              AnimationSettings="@DialogAnimation">
        <DialogEvents Closed="OnAddEditModalClosed" />
        <DialogTemplates>
            <Header>
                <div class="modal-header-content">
                    <i class="fas fa-user-plus modal-header-icon"></i>
                    <div>
                        <h3 class="modal-header-title">@_state.GetModalTitle()</h3>
                        <p class="modal-header-subtitle">@_state.GetModalSubtitle()</p>
                    </div>
                </div>
            </Header>
            <Content>
                @if (_state.IsEditMode && _state.EditingPersonal != null)
                {
                    <AdaugaEditezaPersonal @ref="_currentFormComponent" 
                                          EditingPersonal="@_state.EditingPersonal"
                                          OnSave="@SavePersonal" 
                                          OnCancel="@CloseAddEditModal" />
                }
                else
                {
                    <AdaugaEditezaPersonal @ref="_currentFormComponent" 
                                          OnSave="@SavePersonal" 
                                          OnCancel="@CloseAddEditModal" />
                }
            </Content>
            <FooterTemplate>
                <div class="modal-footer-actions">
                    <button class="btn btn-primary" @onclick="HandleFormSubmit" disabled="@_state.IsLoading">
                        <i class="fas fa-save"></i>
                        @(_state.IsEditMode ? "Actualizeaza Personal" : "Adauga Personal")
                    </button>
                    <button class="btn btn-secondary" @onclick="CloseAddEditModal" disabled="@_state.IsLoading">
                        <i class="fas fa-times"></i>
                        Anuleaza
                    </button>
                </div>
            </FooterTemplate>
        </DialogTemplates>
    </SfDialog>
</div>
