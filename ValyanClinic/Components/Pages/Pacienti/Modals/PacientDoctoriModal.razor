@using ValyanClinic.Application.Features.PacientPersonalMedicalManagement.DTOs
@using ValyanClinic.Application.Features.PacientPersonalMedicalManagement.Queries.GetDoctoriByPacient
@using ValyanClinic.Application.Features.PacientPersonalMedicalManagement.Commands.RemoveRelatie
@using MediatR

<!-- Modal with CSS classes instead of inline styles -->
<div class="modal-overlay @(IsVisible ? "visible" : "")" @onclick="Close">
    
    <div class="modal-container @(IsVisible ? "show" : "")" @onclick:stopPropagation="true">
   
        <!-- Header ALBASTRU (scoped CSS) -->
        <div class="modal-header">
            <div class="modal-title">
                <i class="fas fa-user-md"></i>
                <h2>Doctori asociați - @PacientNume</h2>
            </div>
            <button type="button" class="btn-close" @onclick="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="modal-body">
            @if (IsLoading)
            {
                <div class="loading-container">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Se încarcă...</span>
                    </div>
                    <p>Se încarcă...</p>
                </div>
            }
            else if (HasError)
            {
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    @ErrorMessage
                </div>
            }
            else
            {
                <!-- Doctori activi -->
                <div class="section">
                    <div class="section-header">
                        <h4>
                            <i class="fas fa-check-circle text-success"></i>
                            Doctori activi (@DoctoriActivi.Count)
                        </h4>
                        <!-- BUTON 1: Adaugă doctor (sus dreapta) - ALBASTRU -->
                        <button class="btn btn-primary btn-sm" @onclick="OpenAddDoctorModal">
                            <i class="fas fa-plus"></i> Adaugă doctor
                        </button>
                    </div>

                    @if (DoctoriActivi.Any())
                    {
                        <div class="doctor-cards">
                            @foreach (var doctor in DoctoriActivi)
                            {
                                <div class="doctor-card">
                                    <div class="doctor-header">
                                        <div>
                                            <h5>
                                                <i class="fas fa-user-md text-primary"></i>
                                                @doctor.DoctorNumeComplet
                                            </h5>
                                            @if (!string.IsNullOrEmpty(doctor.DoctorSpecializare))
                                            {
                                                <p class="specialization">@doctor.DoctorSpecializare</p>
                                            }
                                        </div>
                                        @if (!string.IsNullOrEmpty(doctor.TipRelatie))
                                        {
                                            <span class="badge badge-primary">
                                                @doctor.TipRelatie
                                            </span>
                                        }
                                    </div>

                                    <div class="doctor-info">
                                        <div class="info-row">
                                            <i class="fas fa-calendar-alt"></i>
                                            <span>Asociat: @doctor.DataAsocierii.ToString("dd.MM.yyyy") (@doctor.ZileDeAsociere zile)</span>
                                        </div>
                                        @if (!string.IsNullOrEmpty(doctor.DoctorTelefon))
                                        {
                                            <div class="info-row">
                                                <i class="fas fa-phone"></i>
                                                <span>@doctor.DoctorTelefon</span>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(doctor.Motiv))
                                        {
                                            <div class="info-row">
                                                <i class="fas fa-info-circle"></i>
                                                <span>@doctor.Motiv</span>
                                            </div>
                                        }
                                    </div>

                                    <div class="doctor-actions">
                                        <button class="btn btn-sm btn-danger" @onclick="() => RemoveDoctor(doctor)">
                                            <i class="fas fa-times"></i> Dezactivează
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <!-- Empty State cu BUTON 2: Adaugă primul doctor (centru) - ALBASTRU -->
                        <div class="empty-state">
                            <i class="fas fa-user-md fa-3x"></i>
                            <p>Nu există doctori activi asociați.</p>
                            <button class="btn btn-primary" @onclick="OpenAddDoctorModal">
                                <i class="fas fa-plus"></i> Adaugă primul doctor
                            </button>
                        </div>
                    }
                </div>

                <!-- Doctori inactivi (istoric) -->
                @if (DoctoriInactivi.Any())
                {
                    <div class="section mt-4">
                        <div class="section-header">
                            <h4>
                                <i class="fas fa-history text-muted"></i>
                                Istoric relații inactive (@DoctoriInactivi.Count)
                            </h4>
                        </div>

                        <div class="doctor-cards">
                            @foreach (var doctor in DoctoriInactivi)
                            {
                                <div class="doctor-card inactive">
                                    <div class="doctor-header">
                                        <div>
                                            <h5>
                                                <i class="fas fa-user-md"></i>
                                                @doctor.DoctorNumeComplet
                                            </h5>
                                            @if (!string.IsNullOrEmpty(doctor.DoctorSpecializare))
                                            {
                                                <p class="specialization">@doctor.DoctorSpecializare</p>
                                            }
                                        </div>
                                        <span class="badge badge-secondary">INACTIV</span>
                                    </div>

                                    <div class="doctor-info">
                                        <div class="info-row">
                                            <i class="fas fa-calendar-alt"></i>
                                            <span>
                                                @doctor.DataAsocierii.ToString("dd.MM.yyyy") -
                                                @(doctor.DataDezactivarii?.ToString("dd.MM.yyyy") ?? "N/A")
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            }
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" @onclick="Close">
                <i class="fas fa-times"></i> Închide
            </button>
        </div>
    </div>
</div>

<!-- Modal adaugare doctor -->
@if (ShowAddDoctorModal)
{
    <AddDoctorToPacientModal 
        IsVisible="@ShowAddDoctorModal"
        IsVisibleChanged="@(EventCallback.Factory.Create<bool>(this, value => ShowAddDoctorModal = value))"
        PacientID="@PacientID"
        PacientNume="@PacientNume"
        OnDoctorAdded="OnDoctorAdded" />
}
