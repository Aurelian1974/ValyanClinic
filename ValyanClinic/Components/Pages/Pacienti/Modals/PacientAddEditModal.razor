@attribute [Authorize]
@rendermode InteractiveServer
@using ValyanClinic.Application.Features.PacientManagement.Commands.CreatePacient
@using ValyanClinic.Application.Features.PacientManagement.Commands.UpdatePacient
@using ValyanClinic.Application.Features.PacientManagement.Queries.GetPacientById
@using ValyanClinic.Components.Pages.Pacienti.Modals.Components
@using Syncfusion.Blazor.Calendars
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Inputs
@using MediatR

<div class="modal-overlay @(IsVisible ? "visible" : "")" @onclick="HandleOverlayClick" @onkeydown="HandleKeyDown">
    <div class="modal-container modal-large @(IsVisible ? "show" : "")" @onclick:stopPropagation tabindex="0">
        <div class="modal-header">
            <div class="modal-title">
                <i class="fas fa-@(IsEditMode ? "user-edit" : "user-plus")"></i>
                <h2>@(IsEditMode ? "Editare Pacient" : "Adaugare Pacient Nou")</h2>
                @if (_hasUnsavedChanges)
                {
                    <span class="unsaved-indicator" title="Aveți modificări nesalvate">
                        <i class="fas fa-circle text-warning"></i>
                    </span>
                }
            </div>
            <button class="btn-close" @onclick="TryClose" title="Inchide (Esc)">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="modal-body">
            @if (IsLoading && IsEditMode)
            {
                <div class="loading-container">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Se incarca...</span>
                    </div>
                    <p>Se incarca datele pacientului...</p>
                </div>
            }
            else if (HasError)
            {
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle"></i>
                    @ErrorMessage
                </div>
            }
            else
            {
                <EditForm Model="FormModel" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />
                    
                    <!-- Tabs Navigation -->
                    <div class="tabs-container">
                        <div class="tab-buttons">
                            <button type="button" class="tab-button @(ActiveTab == "personal" ? "active" : "") @GetTabValidationClass("personal")" 
                                    @onclick='() => SetActiveTab("personal")'>
                                <i class="fas fa-user"></i>
                                Date Personale
                                @if (TabValidationState.TryGetValue("personal", out var personalValid) && !personalValid)
                                {
                                    <i class="fas fa-exclamation-circle tab-error-icon"></i>
                                }
                            </button>
                            <button type="button" class="tab-button @(ActiveTab == "contact" ? "active" : "") @GetTabValidationClass("contact")" 
                                    @onclick='() => SetActiveTab("contact")'>
                                <i class="fas fa-address-book"></i>
                                Contact
                                @if (TabValidationState.TryGetValue("contact", out var contactValid) && !contactValid)
                                {
                                    <i class="fas fa-exclamation-circle tab-error-icon"></i>
                                }
                            </button>
                            <button type="button" class="tab-button @(ActiveTab == "adresa" ? "active" : "") @GetTabValidationClass("adresa")" 
                                    @onclick='() => SetActiveTab("adresa")'>
                                <i class="fas fa-map-marker-alt"></i>
                                Adresa
                                @if (TabValidationState.TryGetValue("adresa", out var adresaValid) && !adresaValid)
                                {
                                    <i class="fas fa-exclamation-circle tab-error-icon"></i>
                                }
                            </button>
                            <button type="button" class="tab-button @(ActiveTab == "medical" ? "active" : "") @GetTabValidationClass("medical")" 
                                    @onclick='() => SetActiveTab("medical")'>
                                <i class="fas fa-heartbeat"></i>
                                Date Medicale
                                @if (TabValidationState.TryGetValue("medical", out var medicalValid) && !medicalValid)
                                {
                                    <i class="fas fa-exclamation-circle tab-error-icon"></i>
                                }
                            </button>
                            <button type="button" class="tab-button @(ActiveTab == "asigurare" ? "active" : "") @GetTabValidationClass("asigurare")" 
                                    @onclick='() => SetActiveTab("asigurare")'>
                                <i class="fas fa-shield-alt"></i>
                                Asigurare
                                @if (TabValidationState.TryGetValue("asigurare", out var asigurareValid) && !asigurareValid)
                                {
                                    <i class="fas fa-exclamation-circle tab-error-icon"></i>
                                }
                            </button>
                            @if (IsEditMode)
                            {
                            <button type="button" class="tab-button @(ActiveTab == "doctori" ? "active" : "")" 
                                    @onclick='() => SetActiveTab("doctori")'>
                                <i class="fas fa-user-md"></i>
                                 Doctori (@DoctoriAsociati.Count)
                              </button>
                            }
                        </div>

                        <div class="tab-content">
                            <!-- Tab 1: Date Personale -->
                            @if (ActiveTab == "personal")
                            {
                                <div class="tab-pane active">
                                    <div class="info-card">
                                        <h3 class="card-title">
                                            <i class="fas fa-id-badge"></i>
                                            <span>Identificare</span>
                                        </h3>
                                        <div class="info-grid">
                                            <div class="form-group">
                                                <label for="cod-pacient">Cod Pacient</label>
                                                <SfTextBox ID="cod-pacient" 
                                                          @bind-Value="FormModel.Cod_Pacient"
                                                          Placeholder="Auto-generat"
                                                          Readonly="@(!IsEditMode)"
                                                          CssClass="form-control">
                                                </SfTextBox>
                                                <small class="form-text text-muted">Se genereaza automat la salvare</small>
                                            </div>
                                            @if (CanViewField("CNP"))
                                            {
                                                <div class="form-group">
                                                    <label for="cnp">
                                                        CNP
                                                        @if (!CanEditField("CNP"))
                                                        {
                                                            <i class="fas fa-lock text-muted ms-1" title="Nu aveți permisiunea de editare"></i>
                                                        }
                                                        else
                                                        {
                                                            <small class="text-info ms-1" title="Sexul și data nașterii se completează automat din CNP">
                                                                <i class="fas fa-magic"></i>
                                                            </small>
                                                        }
                                                    </label>
                                                    <SfTextBox ID="cnp" 
                                                              Value="@FormModel.CNP"
                                                              ValueChanged="@((string val) => OnCNPChanged(val))"
                                                              Placeholder="1234567890123"
                                                              MaxLength="13"
                                                              Readonly="@(!CanEditField("CNP"))"
                                                              CssClass="@(CanEditField("CNP") ? "form-control" : "form-control readonly-field")">
                                                    </SfTextBox>
                                                    <ValidationMessage For="@(() => FormModel.CNP)" />
                                                    <small class="form-text text-muted">Optional - 13 cifre. Sexul și data nașterii se completează automat.</small>
                                                </div>
                                            }
                                        </div>
                                    </div>

                                    <div class="info-card">
                                        <h3 class="card-title">
                                            <i class="fas fa-user-circle"></i>
                                            <span>Informatii Generale</span>
                                        </h3>
                                        <div class="info-grid">
                                            <div class="form-group">
                                                <label for="nume"><span class="required">*</span> Nume</label>
                                                <SfTextBox ID="nume" 
                                                          @bind-Value="FormModel.Nume"
                                                          Placeholder="Introduceti numele"
                                                          CssClass="form-control">
                                                </SfTextBox>
                                                <ValidationMessage For="@(() => FormModel.Nume)" />
                                            </div>
                                            <div class="form-group">
                                                <label for="prenume"><span class="required">*</span> Prenume</label>
                                                <SfTextBox ID="prenume" 
                                                          @bind-Value="FormModel.Prenume"
                                                          Placeholder="Introduceti prenumele"
                                                          CssClass="form-control">
                                                </SfTextBox>
                                                <ValidationMessage For="@(() => FormModel.Prenume)" />
                                            </div>
                                            <div class="form-group">
                                                <label for="data-nasterii"><span class="required">*</span> Data Nasterii</label>
                                                <SfDatePicker ID="data-nasterii"
                                                              TValue="DateTime"
                                                              CssClass="form-control"
                                                              @bind-Value="@FormModel.Data_Nasterii"
                                                              Format="dd.MM.yyyy"
                                                              Placeholder="Selecteaza data"
                                                              ShowTodayButton="true">
                                                </SfDatePicker>
                                                <ValidationMessage For="@(() => FormModel.Data_Nasterii)" />
                                            </div>
                                            <div class="form-group">
                                                <label for="sex"><span class="required">*</span> Sex</label>
                                                <SfDropDownList ID="sex"
                                                               TValue="string"
                                                               TItem="string"
                                                               Placeholder="Selecteaza..."
                                                               DataSource="@SexOptions"
                                                               @bind-Value="@FormModel.Sex"
                                                               CssClass="form-control">
                                                </SfDropDownList>
                                                <ValidationMessage For="@(() => FormModel.Sex)" />
                                            </div>
                                            <div class="form-group full-width">
                                                <label class="checkbox-label">
                                                    <InputCheckbox @bind-Value="FormModel.Activ" />
                                                    <span>Pacient Activ</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Tab 2: Contact -->
                            @if (ActiveTab == "contact")
                            {
                                <div class="tab-pane active">
                                    <div class="info-card">
                                        <h3 class="card-title">
                                            <i class="fas fa-phone"></i>
                                            <span>Telefon</span>
                                        </h3>
                                        <div class="info-grid">
                                            <div class="form-group">
                                                <label for="telefon">Telefon Principal</label>
                                                <SfTextBox ID="telefon" 
                                                          @bind-Value="FormModel.Telefon"
                                                          Placeholder="0721234567"
                                                          CssClass="form-control">
                                                </SfTextBox>
                                                <ValidationMessage For="@(() => FormModel.Telefon)" />
                                            </div>
                                            <div class="form-group">
                                                <label for="telefon-secundar">Telefon Secundar</label>
                                                <SfTextBox ID="telefon-secundar" 
                                                          @bind-Value="FormModel.Telefon_Secundar"
                                                          Placeholder="0722345678"
                                                          CssClass="form-control">
                                                </SfTextBox>
                                                <ValidationMessage For="@(() => FormModel.Telefon_Secundar)" />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="info-card">
                                        <h3 class="card-title">
                                            <i class="fas fa-envelope"></i>
                                            <span>Email</span>
                                        </h3>
                                        <div class="info-grid">
                                            <div class="form-group full-width">
                                                <label for="email">Email</label>
                                                <SfTextBox ID="email" 
                                                          @bind-Value="FormModel.Email"
                                                          Placeholder="email@exemplu.com"
                                                          CssClass="form-control">
                                                </SfTextBox>
                                                <ValidationMessage For="@(() => FormModel.Email)" />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="info-card">
                                        <h3 class="card-title">
                                            <i class="fas fa-phone-volume"></i>
                                            <span>Contact Urgenta</span>
                                        </h3>
                                        <div class="info-grid">
                                            <div class="form-group">
                                                <label for="persoana-contact">Persoana Contact</label>
                                                <SfTextBox ID="persoana-contact" 
                                                          @bind-Value="FormModel.Persoana_Contact"
                                                          Placeholder="Nume persoana"
                                                          CssClass="form-control">
                                                </SfTextBox>
                                                <ValidationMessage For="@(() => FormModel.Persoana_Contact)" />
                                            </div>
                                            <div class="form-group">
                                                <label for="relatie">Relatie</label>
                                                <SfTextBox ID="relatie" 
                                                          @bind-Value="FormModel.Relatie_Contact"
                                                          Placeholder="ex: Sotie, Fiu, etc."
                                                          CssClass="form-control">
                                                </SfTextBox>
                                                <ValidationMessage For="@(() => FormModel.Relatie_Contact)" />
                                            </div>
                                            <div class="form-group full-width">
                                                <label for="telefon-urgenta">Telefon Urgenta</label>
                                                <SfTextBox ID="telefon-urgenta" 
                                                          @bind-Value="FormModel.Telefon_Urgenta"
                                                          Placeholder="0722345678"
                                                          CssClass="form-control">
                                                </SfTextBox>
                                                <ValidationMessage For="@(() => FormModel.Telefon_Urgenta)" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Tab 3: Adresa -->
                            @if (ActiveTab == "adresa")
                            {
                                <div class="tab-pane active">
                                    <div class="info-card">
                                        <h3 class="card-title">
                                            <i class="fas fa-home"></i>
                                            <span>Adresa Completa</span>
                                        </h3>
                                        <div class="info-grid">
                                            <div class="form-group full-width">
                                                <label for="adresa">Adresa (Strada, Nr.)</label>
                                                <SfTextBox ID="adresa" 
                                                          @bind-Value="FormModel.Adresa"
                                                          Placeholder="Str. Exemplu nr. 123"
                                                          CssClass="form-control">
                                                </SfTextBox>
                                                <ValidationMessage For="@(() => FormModel.Adresa)" />
                                            </div>
                                            <div class="form-group">
                                                <label for="judet">Judet</label>
                                                <SfDropDownList ID="judet"
                                                               TValue="string"
                                                               TItem="string"
                                                               Placeholder="Selecteaza judet..."
                                                               DataSource="@JudeteList"
                                                               Value="@FormModel.Judet"
                                                               ValueChanged="@((string val) => OnJudetChanged(val))"
                                                               AllowFiltering="true"
                                                               FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains"
                                                               ShowClearButton="true"
                                                               CssClass="form-control">
                                                </SfDropDownList>
                                                <ValidationMessage For="@(() => FormModel.Judet)" />
                                            </div>
                                            <div class="form-group">
                                                <label for="localitate">
                                                    Localitate
                                                    @if (_isLoadingLocalitati)
                                                    {
                                                        <span class="spinner-border spinner-border-sm text-primary ms-1"></span>
                                                    }
                                                </label>
                                                @if (LocalitatiList.Any())
                                                {
                                                    <SfDropDownList ID="localitate"
                                                                   TValue="string"
                                                                   TItem="string"
                                                                   Placeholder="Selecteaza localitate..."
                                                                   DataSource="@LocalitatiList"
                                                                   @bind-Value="@FormModel.Localitate"
                                                                   AllowFiltering="true"
                                                                   FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains"
                                                                   ShowClearButton="true"
                                                                   Enabled="@(!_isLoadingLocalitati)"
                                                                   CssClass="form-control">
                                                    </SfDropDownList>
                                                }
                                                else
                                                {
                                                    <SfTextBox ID="localitate" 
                                                              @bind-Value="FormModel.Localitate"
                                                              Placeholder="@(string.IsNullOrEmpty(FormModel.Judet) ? "Selectează mai întâi județul" : "Introdu localitate")"
                                                              CssClass="form-control">
                                                    </SfTextBox>
                                                }
                                                <ValidationMessage For="@(() => FormModel.Localitate)" />
                                            </div>
                                            <div class="form-group">
                                                <label for="cod-postal">Cod Postal</label>
                                                <SfTextBox ID="cod-postal" 
                                                          @bind-Value="FormModel.Cod_Postal"
                                                          Placeholder="010101"
                                                          MaxLength="6"
                                                          CssClass="form-control">
                                                </SfTextBox>
                                                <ValidationMessage For="@(() => FormModel.Cod_Postal)" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Tab 4: Date Medicale -->
                            @if (ActiveTab == "medical")
                            {
                                <div class="tab-pane active">
                                    @if (CanViewField("Alergii") || CanViewField("BoliCronice"))
                                    {
                                        <div class="info-card">
                                            <h3 class="card-title">
                                                <i class="fas fa-heartbeat"></i>
                                                <span>Informatii Medicale</span>
                                                @if (!CanEditField("Alergii") && !CanEditField("BoliCronice"))
                                                {
                                                    <span class="badge bg-secondary ms-2">Doar vizualizare</span>
                                                }
                                            </h3>
                                            <div class="info-grid">
                                                @if (CanViewField("Alergii"))
                                                {
                                                    <div class="form-group full-width">
                                                        <label for="alergii">
                                                            Alergii
                                                            @if (!CanEditField("Alergii"))
                                                            {
                                                                <i class="fas fa-lock text-muted ms-1" title="Nu aveți permisiunea de editare"></i>
                                                            }
                                                        </label>
                                                        <SfTextBox ID="alergii"
                                                                  @bind-Value="FormModel.Alergii"
                                                                  Placeholder="Alergii cunoscute (ex: Penicilina, Polen, etc.)"
                                                                  Multiline="true"
                                                                  RowCount="3"
                                                                  Readonly="@(!CanEditField("Alergii"))"
                                                                  CssClass="@(CanEditField("Alergii") ? "form-control" : "form-control readonly-field")">
                                                        </SfTextBox>
                                                        <ValidationMessage For="@(() => FormModel.Alergii)" />
                                                    </div>
                                                }
                                                @if (CanViewField("BoliCronice"))
                                                {
                                                    <div class="form-group full-width">
                                                        <label for="boli-cronice">
                                                            Boli Cronice
                                                            @if (!CanEditField("BoliCronice"))
                                                            {
                                                                <i class="fas fa-lock text-muted ms-1" title="Nu aveți permisiunea de editare"></i>
                                                            }
                                                        </label>
                                                        <SfTextBox ID="boli-cronice"
                                                                  @bind-Value="FormModel.Boli_Cronice"
                                                                  Placeholder="Boli cronice diagnosticate"
                                                                  Multiline="true"
                                                                  RowCount="3"
                                                                  Readonly="@(!CanEditField("BoliCronice"))"
                                                                  CssClass="@(CanEditField("BoliCronice") ? "form-control" : "form-control readonly-field")">
                                                        </SfTextBox>
                                                        <ValidationMessage For="@(() => FormModel.Boli_Cronice)" />
                                                    </div>
                                                }
                                                <div class="form-group full-width">
                                                    <label for="medic-familie">Medic de Familie</label>
                                                    <SfTextBox ID="medic-familie" 
                                                              @bind-Value="FormModel.Medic_Familie"
                                                              Placeholder="Dr. Nume Prenume"
                                                              CssClass="form-control">
                                                    </SfTextBox>
                                                    <ValidationMessage For="@(() => FormModel.Medic_Familie)" />
                                                </div>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="alert alert-warning">
                                            <i class="fas fa-lock me-2"></i>
                                            Nu aveți permisiunea de a vizualiza datele medicale ale pacientului.
                                        </div>
                                    }
                                </div>
                            }

                            <!-- Tab 5: Asigurare -->
                            @if (ActiveTab == "asigurare")
                            {
                                <div class="tab-pane active">
                                    <div class="info-card">
                                        <h3 class="card-title">
                                            <i class="fas fa-shield-alt"></i>
                                            <span>Informatii Asigurare</span>
                                        </h3>
                                        <div class="info-grid">
                                            <div class="form-group full-width">
                                                <label class="checkbox-label">
                                                    <InputCheckbox @bind-Value="FormModel.Asigurat" />
                                                    <span>Pacient Asigurat</span>
                                                </label>
                                            </div>
                                            @if (FormModel.Asigurat)
                                            {
                                                <div class="form-group">
                                                    <label for="cnp-asigurat">CNP Asigurat</label>
                                                    <SfTextBox ID="cnp-asigurat" 
                                                              @bind-Value="FormModel.CNP_Asigurat"
                                                              Placeholder="1234567890123"
                                                              MaxLength="13"
                                                              CssClass="form-control">
                                                    </SfTextBox>
                                                    <ValidationMessage For="@(() => FormModel.CNP_Asigurat)" />
                                                    <small class="form-text text-muted">Poate fi diferit de CNP pacient (ex: copii)</small>
                                                </div>
                                                <div class="form-group">
                                                    <label for="card-sanatate">Nr. Card Sanatate</label>
                                                    <SfTextBox ID="card-sanatate" 
                                                              @bind-Value="FormModel.Nr_Card_Sanatate"
                                                              Placeholder="123456789012"
                                                              CssClass="form-control">
                                                    </SfTextBox>
                                                    <ValidationMessage For="@(() => FormModel.Nr_Card_Sanatate)" />
                                                </div>
                                                <div class="form-group full-width">
                                                    <label for="casa-asigurari">Casa de Asigurari</label>
                                                    <SfTextBox ID="casa-asigurari" 
                                                              @bind-Value="FormModel.Casa_Asigurari"
                                                              Placeholder="CNAS"
                                                              CssClass="form-control">
                                                    </SfTextBox>
                                                    <ValidationMessage For="@(() => FormModel.Casa_Asigurari)" />
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Tab 6: Doctori (doar în EditMode) - EXTRACTED TO COMPONENT -->
                            @if (ActiveTab == "doctori" && IsEditMode)
                            {
                                <div class="tab-pane active">
                                    <DoctoriTabContent 
                                        DoctoriAsociati="@DoctoriAsociati"
                                        IsLoading="@IsLoadingDoctori"
                                        OnAddDoctor="@OpenAddDoctorModal"
                                        OnDeactivateDoctor="@RemoveDoctor"
                                        OnReactivateDoctor="@ActivateDoctor" />
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Observatii (vizibil pe toate tab-urile) -->
                    <div class="observatii-section">
                        <div class="info-card">
                            <h3 class="card-title">
                                <i class="fas fa-comment-alt"></i>
                                <span>Observatii</span>
                            </h3>
                            <div class="info-grid">
                                <div class="form-group full-width">
                                    <SfTextBox ID="observatii"
                                              @bind-Value="FormModel.Observatii"
                                              Placeholder="Observatii generale despre pacient..."
                                              Multiline="true"
                                              RowCount="3"
                                              CssClass="form-control">
                                    </SfTextBox>
                                    <ValidationMessage For="@(() => FormModel.Observatii)" />
                                </div>
                            </div>
                        </div>
                    </div>
                </EditForm>
            }
        </div>

        <div class="modal-footer">
            <div class="keyboard-shortcuts-hint">
                <small class="text-muted">
                    <kbd>Ctrl+S</kbd> Salvează | <kbd>Esc</kbd> Închide
                </small>
            </div>
            <div class="footer-buttons">
                <button type="button" class="btn btn-secondary" @onclick="TryClose" disabled="@IsSaving">
                    <i class="fas fa-times"></i>
                    Anuleaza
                </button>
                <button type="button" class="btn btn-primary" @onclick="HandleSubmit" disabled="@IsSaving">
                    @if (IsSaving)
                    {
                        <span class="spinner-border spinner-border-sm" role="status"></span>
                        <span>Se salveaza...</span>
                    }
                    else
                    {
                        <i class="fas fa-save"></i>
                        <span>@(IsEditMode ? "Actualizeaza" : "Salveaza")</span>
                    }
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ✅ Confirm modal pentru închidere cu modificări nesalvate -->
@if (ShowConfirmCloseModal)
{
    <div class="modal-overlay visible" style="z-index: 1060;" @onclick:stopPropagation>
        <div class="modal-container modal-small show" @onclick:stopPropagation>
            <div class="modal-header modal-header-warning">
                <div class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h2>Modificări Nesalvate</h2>
                </div>
            </div>
            <div class="modal-body">
                <div class="confirm-message">
                    <p style="font-size: 1rem; margin-bottom: 1rem;">
                        <i class="fas fa-save text-warning me-2"></i>
                        Aveți modificări nesalvate. Sigur doriți să închideți?
                    </p>
                    <p style="color: #6b7280; font-size: 0.875rem;">
                        Modificările vor fi pierdute dacă nu le salvați.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CancelClose">
                    <i class="fas fa-arrow-left"></i> Continuă editarea
                </button>
                <button type="button" class="btn btn-danger" @onclick="ConfirmCloseAndDiscard">
                    <i class="fas fa-trash"></i> Renunță la modificări
                </button>
            </div>
        </div>
    </div>
}

<!-- Modal adaugare doctor (doar când IsEditMode) -->
@if (IsEditMode && ShowAddDoctorModal)
{
    <AddDoctorToPacientModal 
        IsVisible="@ShowAddDoctorModal"
        IsVisibleChanged="@(EventCallback.Factory.Create<bool>(this, value => ShowAddDoctorModal = value))"
        PacientID="@PacientId"
        PacientNume="@($"{FormModel.Nume} {FormModel.Prenume}")"
        OnDoctorAdded="OnDoctorAdded" />
}

<!-- ✅ Toast pentru notificări -->
<Syncfusion.Blazor.Notifications.SfToast @ref="ToastRef" />

<!-- ✅ Confirm modal pentru dezactivare doctor -->
@if (ShowConfirmRemoveDoctor && DoctorToRemove != null)
{
    <div class="modal-overlay visible" @onclick:stopPropagation>
        <div class="modal-container modal-small show" @onclick:stopPropagation>
     <div class="modal-header modal-header-warning">
      <div class="modal-title">
           <i class="fas fa-exclamation-triangle"></i>
    <h2>Confirmare Dezactivare</h2>
                </div>
            </div>
 <div class="modal-body">
                <div class="confirm-message">
         <p>Sunteți sigur că doriți să dezactivați relația cu <strong>@DoctorToRemove.DoctorNumeComplet</strong>?</p>
              <p style="color: #6b7280; font-size: 0.9rem; margin-top: 0.5rem;">
    Relația va fi marcată ca inactivă și va apărea în istoric.
        </p>
        </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" @onclick="() => { ShowConfirmRemoveDoctor = false; DoctorToRemove = null; }">
            <i class="fas fa-times"></i> Anulează
                </button>
      <button type="button" class="btn btn-danger" @onclick="HandleRemoveDoctorConfirmed">
             <i class="fas fa-check"></i> Confirmare
       </button>
            </div>
        </div>
    </div>
}

<!-- ✅ ADDED: Confirm modal pentru reactivare relație doctor-pacient -->
@if (ShowConfirmActivateDoctor && DoctorToActivate != null)
{
    <div class="modal-overlay visible" @onclick:stopPropagation>
        <div class="modal-container modal-small show" @onclick:stopPropagation>
            <div class="modal-header modal-header-success">
      <div class="modal-title">
            <i class="fas fa-redo"></i>
       <h2>Confirmare Reactivare</h2>
   </div>
   </div>
      <div class="modal-body">
   <div class="confirm-message">
            <p>Sunteți sigur că doriți să reactivați relația cu <strong>@DoctorToActivate.DoctorNumeComplet</strong>?</p>
     @if (!string.IsNullOrEmpty(DoctorToActivate.DoctorSpecializare))
               {
   <p style="color: #6b7280; font-size: 0.9rem; margin-top: 0.5rem;">
     <i class="fas fa-graduation-cap"></i> @DoctorToActivate.DoctorSpecializare
   </p>
 }
        <p style="color: #059669; font-size: 0.9rem; margin-top: 1rem; background: #d1fae5; padding: 0.75rem; border-radius: 8px; border-left: 4px solid #10b981;">
 <i class="fas fa-info-circle"></i> Relația va deveni activă și va apărea în lista doctorilor activi.
         </p>
  </div>
            </div>
  <div class="modal-footer">
     <button type="button" 
            class="btn btn-secondary" 
    @onclick="() => { ShowConfirmActivateDoctor = false; DoctorToActivate = null; }">
        <i class="fas fa-times"></i> Anulează
                </button>
   <button type="button" 
     class="btn btn-success" 
               @onclick="HandleActivateDoctorConfirmed"
         style="background: linear-gradient(135deg, #10b981, #059669); color: white;">
         <i class="fas fa-check"></i> Reactivează
          </button>
    </div>
    </div>
    </div>
}

<!-- ✅ Confirm modal pentru adăugare doctori după creare pacient -->
@if (ShowConfirmAddDoctors)
{
    <div class="modal-overlay visible" @onclick:stopPropagation>
        <div class="modal-container modal-medium show" @onclick:stopPropagation>
            <div class="modal-header modal-header-success">
       <div class="modal-title">
             <i class="fas fa-check-circle"></i>
      <h2>Pacient Creat Cu Succes!</h2>
      </div>
            </div>
            <div class="modal-body">
          <div class="confirm-message">
       <p style="font-size: 1.1rem; margin-bottom: 1rem;">
             Pacientul <strong>@FormModel.Nume @FormModel.Prenume</strong> a fost creat cu succes!
      </p>
    <p style="color: #6b7280;">
    <i class="fas fa-user-md" style="color: #3b82f6;"></i>
      Doriți să adăugați doctori asociați acestui pacient acum?
                 </p>
            </div>
            </div>
            <div class="modal-footer">
   <button type="button" class="btn btn-secondary" @onclick="HandleAddDoctorsDeclined">
        <i class="fas fa-times"></i> Nu, mulțumesc
           </button>
          <button type="button" class="btn btn-primary" @onclick="HandleAddDoctorsConfirmed">
    <i class="fas fa-user-plus"></i> Da, adaugă doctori
       </button>
        </div>
        </div>
    </div>
}

@code {
    private Syncfusion.Blazor.Notifications.SfToast? ToastRef;

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender && ToastRef != null)
        {
    NotificationService.RegisterToast(ToastRef);
 Logger.LogDebug("[PacientAddEditModal] Toast registered successfully");
        }
    }
}
