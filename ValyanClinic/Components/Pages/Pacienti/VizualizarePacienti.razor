@page "/pacienti/vizualizare"
@rendermode InteractiveServer
@using ValyanClinic.Application.Features.PacientManagement.Queries.GetPacientList
@using MediatR
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Notifications
@using Syncfusion.Blazor.DropDowns
@using ValyanClinic.Components.Pages.Pacienti.Modals
@using FilterType = Syncfusion.Blazor.Grids.FilterType

<PageTitle>Vizualizare Pacienti</PageTitle>

<div class="page-wrapper">
    <!-- Floating Background Elements -->
    <div class="bg-decoration">
        <div class="bg-circle bg-circle-1"></div>
        <div class="bg-circle bg-circle-2"></div>
        <div class="bg-circle bg-circle-3"></div>
    </div>

    <!-- Main Content -->
    <div class="pacienti-container">
        <!-- Professional Header -->
        <header class="page-header">
            <div class="header-content">
                <div class="header-left">
                    <div class="header-icon-wrapper">
                        <div class="header-icon">
                            <i class="fas fa-user-injured"></i>
                        </div>
                        <div class="header-icon-pulse"></div>
                    </div>
                    <div class="header-text">
                        <h1>Registru Pacienti</h1>
                        <p class="header-subtitle">
                            <i class="fas fa-clinic-medical"></i>
                            Gestionare si monitorizare pacienti
                        </p>
                    </div>
                </div>
                <div class="header-right">
                    <div class="header-stats">
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-value">@TotalRecords</span>
                                <span class="stat-label">Total Pacienti</span>
                            </div>
                        </div>
                        @if (ActiveFiltersCount > 0)
                        {
                            <div class="stat-item stat-filtered">
                                <div class="stat-icon">
                                    <i class="fas fa-filter"></i>
                                </div>
                                <div class="stat-content">
                                    <span class="stat-value">@ActiveFiltersCount</span>
                                    <span class="stat-label">Filtre Active</span>
                                </div>
                            </div>
                        }
                    </div>
                    <button class="btn-refresh" @onclick="HandleRefresh" title="Reincarca datele">
                        <i class="fas fa-sync-alt @(IsLoading ? "fa-spin" : "")"></i>
                        <span>Actualizeaza</span>
                    </button>
                </div>
            </div>
        </header>

        @if (IsLoading && !DataLoaded)
        {
            <!-- Premium Loading State -->
            <div class="loading-state">
                <div class="loading-content">
                    <div class="loading-spinner">
                        <div class="spinner-ring"></div>
                        <div class="spinner-ring"></div>
                        <div class="spinner-ring"></div>
                        <i class="fas fa-heartbeat loading-icon"></i>
                    </div>
                    <h3>Se incarca datele pacientilor</h3>
                    <p>Va rugam asteptati...</p>
                    <div class="loading-bar">
                        <div class="loading-bar-fill"></div>
                    </div>
                </div>
            </div>
        }
        else if (HasError)
        {
            <!-- Error State -->
            <div class="error-state">
                <div class="error-content">
                    <div class="error-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3>A aparut o eroare</h3>
                    <p>@ErrorMessage</p>
                    <button class="btn-retry" @onclick="HandleRefresh">
                        <i class="fas fa-redo"></i>
                        Incearca din nou
                    </button>
                </div>
            </div>
        }
        else
        {
            <!-- Search & Filter Section -->
            <section class="search-section">
                <div class="search-container">
                    <!-- Global Search -->
                    <div class="search-input-wrapper">
                        <div class="search-icon-container">
                            <i class="fas fa-search"></i>
                        </div>
                        <input type="text" 
                               class="search-input"
                               placeholder="Cauta pacient dupa nume, CNP, telefon sau email..."
                               value="@GlobalSearchText"
                               @oninput="OnSearchInput"
                               @onkeydown="OnSearchKeyDown" />
                        @if (!string.IsNullOrEmpty(GlobalSearchText))
                        {
                            <button class="search-clear" @onclick="ClearSearch" type="button">
                                <i class="fas fa-times-circle"></i>
                            </button>
                        }
                        <div class="search-shortcut">
                            <kbd>Enter</kbd>
                        </div>
                    </div>

                    <!-- Filter Toggle -->
                    <button class="btn-filters @(IsAdvancedFilterExpanded ? "active" : "") @(ActiveFiltersCount > 0 ? "has-filters" : "")" 
                            @onclick="ToggleAdvancedFilter">
                        <i class="fas fa-sliders-h"></i>
                        <span>Filtre</span>
                        @if (ActiveFiltersCount > 0)
                        {
                            <span class="filter-count">@ActiveFiltersCount</span>
                        }
                        <i class="fas fa-chevron-down chevron @(IsAdvancedFilterExpanded ? "rotated" : "")"></i>
                    </button>
                </div>

                <!-- Advanced Filters Panel -->
                <div class="filters-panel @(IsAdvancedFilterExpanded ? "expanded" : "")">
                    <div class="filters-content">
                        <div class="filters-header">
                            <h4>
                                <i class="fas fa-filter"></i>
                                Filtre Avansate
                            </h4>
                            <button class="btn-collapse" @onclick="ToggleAdvancedFilter">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="filters-grid">
                            <div class="filter-group">
                                <label class="filter-label">
                                    <i class="fas fa-map-marker-alt"></i>
                                    Judet
                                </label>
                                <SfDropDownList TValue="string" 
                                               TItem="FilterOption"
                                               DataSource="@JudetOptions"
                                               @bind-Value="@FilterJudet"
                                               Placeholder="Toate judetele"
                                               CssClass="sf-dropdown-modern"
                                               AllowFiltering="true"
                                               ShowClearButton="false"
                                               EnablePersistence="false"
                                               IgnoreAccent="true"
                                               FilterBarPlaceholder="Cauta judet...">
                                    <DropDownListFieldSettings Text="Text" Value="Value"/>
                                </SfDropDownList>
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">
                                    <i class="fas fa-shield-alt"></i>
                                    Status Asigurare
                                </label>
                                <SfDropDownList TValue="string" 
                                               TItem="FilterOption"
                                               DataSource="@AsiguratOptions"
                                               @bind-Value="@FilterAsigurat"
                                               Placeholder="Toate statusurile"
                                               CssClass="sf-dropdown-modern"
                                               AllowFiltering="false"
                                               ShowClearButton="false"
                                               EnablePersistence="false"
                                               IgnoreAccent="true">
                                    <DropDownListFieldSettings Text="Text" Value="Value"/>
                                </SfDropDownList>
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">
                                    <i class="fas fa-toggle-on"></i>
                                    Status Pacient
                                </label>
                                <SfDropDownList TValue="string" 
                                               TItem="FilterOption"
                                               DataSource="@StatusOptions"
                                               @bind-Value="@FilterStatus"
                                               Placeholder="Toate statusurile"
                                               CssClass="sf-dropdown-modern"
                                               AllowFiltering="false"
                                               ShowClearButton="false"
                                               EnablePersistence="false"
                                               IgnoreAccent="true">
                                    <DropDownListFieldSettings Text="Text" Value="Value"/>
                                </SfDropDownList>
                            </div>
                        </div>

                        <div class="filters-actions">
                            <button class="btn-action btn-clear-filters" 
                                    @onclick="ClearAllFilters" 
                                    disabled="@(ActiveFiltersCount == 0)">
                                <i class="fas fa-eraser"></i>
                                Sterge Filtrele
                            </button>
                            <button class="btn-action btn-apply-filters" @onclick="ApplyFilters">
                                <i class="fas fa-check"></i>
                                Aplica Filtrele
                            </button>
                        </div>

                        @if (ActiveFiltersCount > 0)
                        {
                            <div class="active-filters-display">
                                <span class="active-label">
                                    <i class="fas fa-tags"></i>
                                    Filtre aplicate:
                                </span>
                                <div class="filter-tags">
                                    @if (!string.IsNullOrEmpty(GlobalSearchText))
                                    {
                                        <span class="filter-tag">
                                            <i class="fas fa-search"></i>
                                            "@GlobalSearchText"
                                            <button @onclick="() => ClearFilter(nameof(GlobalSearchText))">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </span>
                                    }
                                    @if (!string.IsNullOrEmpty(FilterJudet))
                                    {
                                        <span class="filter-tag">
                                            <i class="fas fa-map-marker-alt"></i>
                                            @FilterJudet
                                            <button @onclick="() => ClearFilter(nameof(FilterJudet))">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </span>
                                    }
                                    @if (!string.IsNullOrEmpty(FilterAsigurat))
                                    {
                                        <span class="filter-tag">
                                            <i class="fas fa-shield-alt"></i>
                                            @(FilterAsigurat == "true" ? "Asigurat" : "Neasigurat")
                                            <button @onclick="() => ClearFilter(nameof(FilterAsigurat))">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </span>
                                    }
                                    @if (!string.IsNullOrEmpty(FilterStatus))
                                    {
                                        <span class="filter-tag">
                                            <i class="fas fa-toggle-on"></i>
                                            @(FilterStatus == "true" ? "Activ" : "Inactiv")
                                            <button @onclick="() => ClearFilter(nameof(FilterStatus))">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </section>

            <!-- Selection Action Bar -->
            <section class="action-bar @(SelectedPacient != null ? "has-selection" : "")">
                <div class="action-bar-content">
                    <div class="selection-info">
                        @if (SelectedPacient != null)
                        {
                            <div class="selected-patient">
                                <div class="patient-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="patient-details">
                                    <span class="patient-name">@SelectedPacient.NumeComplet</span>
                                    <span class="patient-code">
                                        <i class="fas fa-id-badge"></i>
                                        @SelectedPacient.Cod_Pacient
                                    </span>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="no-selection">
                                <i class="fas fa-hand-pointer"></i>
                                <span>Selecteaza un pacient din tabel pentru actiuni</span>
                            </div>
                        }
                    </div>
                    <div class="action-buttons">
                        <button class="btn-action-primary" 
                                @onclick="() => HandleViewSelected()"
                                disabled="@(SelectedPacient == null)">
                            <i class="fas fa-eye"></i>
                            <span>Vizualizeaza</span>
                        </button>
                        <button class="btn-action-secondary" 
                                @onclick="() => HandleManageDoctors()"
                                disabled="@(SelectedPacient == null)">
                            <i class="fas fa-user-md"></i>
                            <span>Doctori</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Data Grid -->
            <section class="data-section">
                <div class="grid-wrapper">
                    <SfGrid @ref="GridRef"
                            DataSource="@CurrentPageData"
                            Height="100%"
                            AllowPaging="true"
                            AllowSorting="true"
                            AllowFiltering="true"
                            AllowResizing="true"
                            AllowReordering="true"
                            AllowTextWrap="true"
                            ShowColumnChooser="true"
                            GridLines="GridLine.Horizontal">
                        
                        <GridPageSettings PageSize="@CurrentPageSize" 
                                         PageCount="5" 
                                         PageSizes="@PageSizeArray">
                        </GridPageSettings>
                        
                        <GridFilterSettings Type="FilterType.Excel"></GridFilterSettings>
                        
                        <GridSelectionSettings Type="GridSelectionType.Single"></GridSelectionSettings>
                        
                        <GridEvents TValue="PacientListDto" 
                                   RowSelected="OnRowSelected"
                                   RowDeselected="OnRowDeselected"
                                   OnActionBegin="OnGridActionBegin"
                                   OnActionComplete="OnGridActionComplete">
                        </GridEvents>
                        
                        <GridColumns>
                            <GridColumn Field="@nameof(PacientListDto.Cod_Pacient)" 
                                       HeaderText="Cod" 
                                       Width="110"
                                       IsPrimaryKey="true">
                                <Template>
                                    @{
                                        var pacient = (context as PacientListDto);
                                        <span class="code-badge">@pacient?.Cod_Pacient</span>
                                    }
                                </Template>
                            </GridColumn>
                            
                            <GridColumn Field="@nameof(PacientListDto.NumeComplet)" 
                                       HeaderText="Pacient" 
                                       Width="220">
                                <Template>
                                    @{
                                        var pacient = (context as PacientListDto);
                                        <div class="patient-cell">
                                            <div class="patient-cell-avatar @(pacient?.Sex == "M" ? "male" : "female")">
                                                <i class="fas @(pacient?.Sex == "M" ? "fa-mars" : "fa-venus")"></i>
                                            </div>
                                            <span class="patient-cell-name">@pacient?.NumeComplet</span>
                                        </div>
                                    }
                                </Template>
                            </GridColumn>
                            
                            <GridColumn Field="@nameof(PacientListDto.CNP)" 
                                       HeaderText="CNP" 
                                       Width="145">
                                <Template>
                                    @{
                                        var pacient = (context as PacientListDto);
                                        <span class="cnp-display">@pacient?.CNP</span>
                                    }
                                </Template>
                            </GridColumn>
                            
                            <GridColumn Field="@nameof(PacientListDto.Data_Nasterii)" 
                                       HeaderText="Data Nasterii" 
                                       Width="125"
                                       Format="dd.MM.yyyy"
                                       Type="ColumnType.Date">
                            </GridColumn>
                            
                            <GridColumn Field="@nameof(PacientListDto.Varsta)" 
                                       HeaderText="Varsta" 
                                       Width="90"
                                       TextAlign="TextAlign.Center">
                                <Template>
                                    @{
                                        var pacient = (context as PacientListDto);
                                        <span class="age-badge">@pacient?.Varsta ani</span>
                                    }
                                </Template>
                            </GridColumn>
                            
                            <GridColumn Field="@nameof(PacientListDto.Telefon)" 
                                       HeaderText="Contact" 
                                       Width="150">
                                <Template>
                                    @{
                                        var pacient = (context as PacientListDto);
                                        <div class="contact-cell">
                                            @if (!string.IsNullOrEmpty(pacient?.Telefon))
                                            {
                                                <a href="tel:@pacient.Telefon" class="contact-link phone">
                                                    <i class="fas fa-phone-alt"></i>
                                                    @pacient.Telefon
                                                </a>
                                            }
                                        </div>
                                    }
                                </Template>
                            </GridColumn>
                            
                            <GridColumn Field="@nameof(PacientListDto.Email)" 
                                       HeaderText="Email" 
                                       Width="200">
                                <Template>
                                    @{
                                        var pacient = (context as PacientListDto);
                                        @if (!string.IsNullOrEmpty(pacient?.Email))
                                        {
                                            <a href="mailto:@pacient.Email" class="contact-link email" title="@pacient.Email">
                                                <i class="fas fa-envelope"></i>
                                                @pacient.Email
                                            </a>
                                        }
                                    }
                                </Template>
                            </GridColumn>
                            
                            <GridColumn Field="@nameof(PacientListDto.Localitate)" 
                                       HeaderText="Localitate" 
                                       Width="140">
                            </GridColumn>
                            
                            <GridColumn Field="@nameof(PacientListDto.Judet)" 
                                       HeaderText="Judet" 
                                       Width="110">
                            </GridColumn>
                            
                            <GridColumn Field="@nameof(PacientListDto.Asigurat)" 
                                       HeaderText="Asigurare" 
                                       Width="110"
                                       TextAlign="TextAlign.Center">
                                <Template>
                                    @{
                                        var pacient = (context as PacientListDto);
                                        @if (pacient != null)
                                        {
                                            <span class="insurance-badge @(pacient.Asigurat ? "insured" : "uninsured")">
                                                <i class="fas fa-@(pacient.Asigurat ? "shield-alt" : "shield")"></i>
                                                @(pacient.Asigurat ? "Asigurat" : "Neasigurat")
                                            </span>
                                        }
                                    }
                                </Template>
                            </GridColumn>
                            
                            <GridColumn Field="@nameof(PacientListDto.Casa_Asigurari)" 
                                       HeaderText="Casa Asigurari" 
                                       Width="150">
                            </GridColumn>
                            
                            <GridColumn Field="@nameof(PacientListDto.Ultima_Vizita)" 
                                       HeaderText="Ultima Vizita" 
                                       Width="125"
                                       Format="dd.MM.yyyy"
                                       Type="ColumnType.Date">
                            </GridColumn>
                            
                            <GridColumn Field="@nameof(PacientListDto.Nr_Total_Vizite)" 
                                       HeaderText="Vizite" 
                                       Width="90"
                                       TextAlign="TextAlign.Center">
                                <Template>
                                    @{
                                        var pacient = (context as PacientListDto);
                                        <span class="visits-badge">
                                            <i class="fas fa-calendar-check"></i>
                                            @pacient?.Nr_Total_Vizite
                                        </span>
                                    }
                                </Template>
                            </GridColumn>
                            
                            <GridColumn Field="@nameof(PacientListDto.Activ)" 
                                       HeaderText="Status" 
                                       Width="105"
                                       TextAlign="TextAlign.Center">
                                <Template>
                                    @{
                                        var pacient = (context as PacientListDto);
                                        <span class="status-pill @(pacient?.Activ == true ? "active" : "inactive")">
                                            <span class="status-dot"></span>
                                            @(pacient?.Activ == true ? "Activ" : "Inactiv")
                                        </span>
                                    }
                                </Template>
                            </GridColumn>
                        </GridColumns>
                    </SfGrid>
                </div>
            </section>
        }
    </div>
</div>

<!-- Toast Notifications -->
<SfToast @ref="ToastRef" Title="@ToastTitle" Content="@ToastContent" CssClass="@ToastCssClass">
    <ToastPosition X="Right" Y="Top"></ToastPosition>
</SfToast>

<!-- Modals -->
<PacientViewModal IsVisible="@ShowViewModal"
                  IsVisibleChanged="@(EventCallback.Factory.Create<bool>(this, value => ShowViewModal = value))"
                  PacientId="@SelectedPacientId"
                  OnClosed="@HandleModalClosed" />

<PacientDoctoriModal IsVisible="@ShowDoctoriModal"
                  IsVisibleChanged="@(EventCallback.Factory.Create<bool>(this, value => ShowDoctoriModal = value))"
                  PacientID="@SelectedPacientId"
                  PacientNume="@SelectedPacientNume" />
