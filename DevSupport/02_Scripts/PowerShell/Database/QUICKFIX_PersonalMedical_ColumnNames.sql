-- =============================================
-- QUICK FIX: Personal Medical - Column Names
-- Ruleaz? acest script în SSMS pentru fix rapid
-- Database: ValyanMed
-- =============================================

USE [ValyanMed]
GO

PRINT ''
PRINT '??????????????????????????????????????????????'
PRINT '?  QUICK FIX: PersonalMedical Column Names  ?'
PRINT '??????????????????????????????????????????????'
PRINT ''

-- Step 1: Drop old SP
IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'sp_PersonalMedical_GetById')
BEGIN
    DROP PROCEDURE [dbo].[sp_PersonalMedical_GetById]
    PRINT '? [1/2] Old SP dropped'
END
ELSE
BEGIN
    PRINT '? [1/2] SP did not exist (first install?)'
END
GO

-- Step 2: Create fixed SP
CREATE PROCEDURE [dbo].[sp_PersonalMedical_GetById]
    @PersonalID UNIQUEIDENTIFIER
AS
BEGIN
    SET NOCOUNT ON;
    
    SELECT 
        pm.PersonalID,
        pm.Nume,
        pm.Prenume,
        pm.Specializare,
        pm.NumarLicenta,
        pm.Telefon,
        pm.Email,
        pm.Departament,
        pm.Pozitie,
        pm.EsteActiv,
        pm.DataCreare,
        pm.CategorieID,
        pm.SpecializareID,
        pm.SubspecializareID,
        d1.DenumireDepartament AS CategorieName,
        d2.DenumireDepartament AS SpecializareName,
        d3.DenumireDepartament AS SubspecializareName
    FROM PersonalMedical pm
    LEFT JOIN Departamente d1 ON pm.CategorieID = d1.IdDepartament
    LEFT JOIN Departamente d2 ON pm.SpecializareID = d2.IdDepartament
    LEFT JOIN Departamente d3 ON pm.SubspecializareID = d3.IdDepartament
    WHERE pm.PersonalID = @PersonalID;
END;
GO

PRINT '? [2/2] Fixed SP created'
PRINT ''

-- Verification
IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'sp_PersonalMedical_GetById')
BEGIN
    PRINT '??????????????????????????????????????????????'
    PRINT '?           ? FIX SUCCESSFUL!               ?'
    PRINT '??????????????????????????????????????????????'
    PRINT ''
    PRINT 'NEXT STEPS:'
    PRINT '  1. Restart your Blazor application'
    PRINT '  2. Navigate to "Personal Medical"'
    PRINT '  3. Verify the grid loads without errors'
    PRINT ''
END
ELSE
BEGIN
    PRINT '??????????????????????????????????????????????'
    PRINT '?           ? FIX FAILED!                   ?'
    PRINT '??????????????????????????????????????????????'
    PRINT ''
    PRINT 'Please check errors above and try again.'
    PRINT ''
END
