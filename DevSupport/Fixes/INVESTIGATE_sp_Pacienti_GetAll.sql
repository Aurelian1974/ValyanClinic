-- =============================================
-- Script de Investigare: sp_Pacienti_GetAll
-- Verificare implementare actual? din baza de date
-- =============================================

USE [ValyanMed]
GO

PRINT '??????????????????????????????????????????????????????????????????????';
PRINT '?   INVESTIGARE: sp_Pacienti_GetAll - Implementare Curent?          ?';
PRINT '??????????????????????????????????????????????????????????????????????';
PRINT '';

-- =============================================
-- 1. Verificare existen?? SP
-- =============================================
PRINT '1. Verificare existen?? Stored Procedure...';
IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'sp_Pacienti_GetAll')
BEGIN
    PRINT '  ? sp_Pacienti_GetAll EXIST? în baza de date';
    
    -- Afi?are metadata
    SELECT 
        name AS 'Nume SP',
        create_date AS 'Data Creare',
        modify_date AS 'Data Modificare'
    FROM sys.objects 
    WHERE type = 'P' AND name = 'sp_Pacienti_GetAll';
END
ELSE
BEGIN
    PRINT '  ? EROARE: sp_Pacienti_GetAll NU EXIST?!';
    PRINT '  ? Trebuie creat SP-ul';
END
PRINT '';

-- =============================================
-- 2. Afi?are cod surs? SP
-- =============================================
PRINT '2. Cod surs? sp_Pacienti_GetAll:';
PRINT '????????????????????????????????????????????????????????????????????';

SELECT OBJECT_DEFINITION(OBJECT_ID('dbo.sp_Pacienti_GetAll')) AS 'SP Definition';

PRINT '';
PRINT '????????????????????????????????????????????????????????????????????';
PRINT '';

-- =============================================
-- 3. Verificare parametri SP
-- =============================================
PRINT '3. Parametri sp_Pacienti_GetAll:';
SELECT 
    p.name AS 'Parameter Name',
    TYPE_NAME(p.user_type_id) AS 'Data Type',
    p.max_length AS 'Max Length',
    p.is_nullable AS 'Is Nullable',
    p.has_default_value AS 'Has Default',
    p.default_value AS 'Default Value'
FROM sys.parameters p
WHERE p.object_id = OBJECT_ID('dbo.sp_Pacienti_GetAll')
ORDER BY p.parameter_id;
PRINT '';

-- =============================================
-- 4. Test LIVE cu parametri NULL
-- =============================================
PRINT '????????????????????????????????????????????????????????????????????';
PRINT '4. TEST LIVE: Executare cu @Activ=NULL, @Asigurat=NULL';
PRINT '????????????????????????????????????????????????????????????????????';
PRINT '';

PRINT '  Parametri:';
PRINT '    @PageNumber = 1';
PRINT '    @PageSize = 10';
PRINT '    @SearchText = NULL';
PRINT '    @Judet = NULL';
PRINT '    @Asigurat = NULL';
PRINT '    @Activ = NULL';
PRINT '';

-- Contorizare înainte de executie
DECLARE @TotalPacientiInDB INT;
SELECT @TotalPacientiInDB = COUNT(*) FROM Pacienti;
PRINT '  Total pacienti în baza de date: ' + CAST(@TotalPacientiInDB AS VARCHAR(10));
PRINT '';

-- Executie SP
PRINT '  Executare sp_Pacienti_GetAll...';
PRINT '  ????????????????????????????????????????????????????????????????????';

DECLARE @StartTime DATETIME2 = GETDATE();

EXEC sp_Pacienti_GetAll 
    @PageNumber = 1, 
    @PageSize = 10,
    @SearchText = NULL,
    @Judet = NULL,
    @Asigurat = NULL,
    @Activ = NULL,
    @SortColumn = 'Nume',
    @SortDirection = 'ASC';

DECLARE @EndTime DATETIME2 = GETDATE();
DECLARE @ExecutionTime INT = DATEDIFF(MILLISECOND, @StartTime, @EndTime);

PRINT '';
PRINT '  ????????????????????????????????????????????????????????????????????';
PRINT '  Timp executie: ' + CAST(@ExecutionTime AS VARCHAR(10)) + ' ms';
PRINT '';

-- =============================================
-- 5. Diagnosticare problem?
-- =============================================
PRINT '????????????????????????????????????????????????????????????????????';
PRINT '5. DIAGNOSTICARE';
PRINT '????????????????????????????????????????????????????????????????????';
PRINT '';

-- Test manual cu WHERE clause suspect
PRINT '  Test manual: SELECT cu filtru incorect (@Activ=NULL)';
DECLARE @TestCount1 INT;
SELECT @TestCount1 = COUNT(*) 
FROM Pacienti 
WHERE Activ = NULL;  -- ? Incorect - întotdeauna 0
PRINT '    WHERE Activ = NULL ? Count: ' + CAST(@TestCount1 AS VARCHAR(10)) + ' (ar trebui 0 - bug)';

-- Test manual cu WHERE clause corect
DECLARE @TestCount2 INT;
SELECT @TestCount2 = COUNT(*) 
FROM Pacienti 
WHERE (@Activ IS NULL OR Activ = @Activ);  -- ? Corect
SET @Activ = NULL;
PRINT '    WHERE (@Activ IS NULL OR Activ = @Activ) ? Count: ' + CAST(@TestCount2 AS VARCHAR(10)) + ' (ar trebui ' + CAST(@TotalPacientiInDB AS VARCHAR(10)) + ')';

PRINT '';

-- =============================================
-- 6. Verificare alte SP-uri conexe
-- =============================================
PRINT '????????????????????????????????????????????????????????????????????';
PRINT '6. Verificare SP-uri conexe';
PRINT '????????????????????????????????????????????????????????????????????';
PRINT '';

-- sp_Pacienti_GetCount
IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'sp_Pacienti_GetCount')
BEGIN
    PRINT '  ? sp_Pacienti_GetCount EXIST?';
    
    PRINT '    Test sp_Pacienti_GetCount cu @Activ=NULL:';
    EXEC sp_Pacienti_GetCount @Activ = NULL;
END
ELSE
BEGIN
    PRINT '  ? sp_Pacienti_GetCount NU EXIST?';
END

PRINT '';

-- sp_Pacienti_GetById
IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'sp_Pacienti_GetById')
    PRINT '  ? sp_Pacienti_GetById EXIST?';
ELSE
    PRINT '  ? sp_Pacienti_GetById NU EXIST?';

PRINT '';

-- =============================================
-- 7. Recomand?ri
-- =============================================
PRINT '????????????????????????????????????????????????????????????????????';
PRINT '7. RECOMAND?RI';
PRINT '????????????????????????????????????????????????????????????????????';
PRINT '';

IF @TestCount2 > 0 AND @TestCount1 = 0
BEGIN
    PRINT '  ??  PROBLEM? CONFIRMAT?: NULL handling incorect în WHERE clause';
    PRINT '';
    PRINT '  Recomandare:';
    PRINT '    1. Rula?i: MASTER_FIX_AdministrarePacienti_NULL_Handling.sql';
    PRINT '    2. Restart aplica?ia Blazor';
    PRINT '    3. Test pagina /pacienti/administrare';
    PRINT '';
    PRINT '  Fix necesar:';
    PRINT '    WHERE Activ = @Activ';
    PRINT '    ? (schimb? în)';
    PRINT '    WHERE (@Activ IS NULL OR Activ = @Activ)';
END
ELSE IF @TestCount2 = @TotalPacientiInDB
BEGIN
    PRINT '  ? NULL handling pare CORECT în test manual';
    PRINT '  ??  Dac? aplica?ia înc? are probleme, verifica?i:';
    PRINT '    1. Repository-ul apeleaz? corect SP-ul';
    PRINT '    2. Parametrii sunt pasa?i corect din C#';
    PRINT '    3. Connection string este corect';
    PRINT '    4. Nu exist? cache-uri învechite';
END
ELSE
BEGIN
    PRINT '  ??  Rezultate nea?teptate - investigare necesar?';
END

PRINT '';
PRINT '????????????????????????????????????????????????????????????????????';
PRINT 'INVESTIGARE COMPLET?';
PRINT '????????????????????????????????????????????????????????????????????';
GO
