-- =============================================
-- Script de Monitoring: Trace SQL Calls din aplica?ie
-- Captureaz? exact ce parametri trimite aplica?ia C# c?tre SQL
-- =============================================

USE [ValyanMed]
GO

PRINT '??????????????????????????????????????????????????????????????????????';
PRINT '?   SQL PROFILER SIMULATOR: Trace sp_Pacienti_GetAll Calls          ?';
PRINT '??????????????????????????????????????????????????????????????????????';
PRINT '';

-- =============================================
-- 1. Create temporary logging table
-- =============================================
IF OBJECT_ID('tempdb..#SPCallLog') IS NOT NULL
    DROP TABLE #SPCallLog;

CREATE TABLE #SPCallLog (
    LogID INT IDENTITY(1,1) PRIMARY KEY,
    LogTime DATETIME2 DEFAULT GETDATE(),
    PageNumber INT,
    PageSize INT,
    SearchText NVARCHAR(255),
    Judet NVARCHAR(50),
    Asigurat BIT,
    Activ BIT,
    SortColumn NVARCHAR(50),
    SortDirection NVARCHAR(4),
    RecordsReturned INT,
    TotalCount INT,
    ExecutionTimeMS INT
);

PRINT '? Tabel temporar #SPCallLog creat pentru logging';
PRINT '';

-- =============================================
-- 2. Create wrapper SP pentru logging
-- =============================================
PRINT 'Creeare wrapper SP: sp_Pacienti_GetAll_WithLogging';

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'sp_Pacienti_GetAll_WithLogging')
    DROP PROCEDURE sp_Pacienti_GetAll_WithLogging;
GO

CREATE PROCEDURE sp_Pacienti_GetAll_WithLogging
    @PageNumber INT = 1,
    @PageSize INT = 25,
    @SearchText NVARCHAR(255) = NULL,
    @Judet NVARCHAR(50) = NULL,
    @Asigurat BIT = NULL,
    @Activ BIT = NULL,
    @SortColumn NVARCHAR(50) = 'Nume',
    @SortDirection NVARCHAR(4) = 'ASC'
AS
BEGIN
    SET NOCOUNT ON;
    
    DECLARE @StartTime DATETIME2 = GETDATE();
    DECLARE @RecordsReturned INT = 0;
    DECLARE @TotalCount INT = 0;
    
    -- Log parameters BEFORE execution
    PRINT '????????????????????????????????????????????????????????????????????';
    PRINT 'TRACE: sp_Pacienti_GetAll called at ' + CONVERT(VARCHAR(23), @StartTime, 121);
    PRINT '????????????????????????????????????????????????????????????????????';
    PRINT 'Parameters:';
    PRINT '  @PageNumber   = ' + ISNULL(CAST(@PageNumber AS VARCHAR(10)), 'NULL');
    PRINT '  @PageSize     = ' + ISNULL(CAST(@PageSize AS VARCHAR(10)), 'NULL');
    PRINT '  @SearchText   = ' + ISNULL('''' + @SearchText + '''', 'NULL');
    PRINT '  @Judet        = ' + ISNULL('''' + @Judet + '''', 'NULL');
    PRINT '  @Asigurat     = ' + ISNULL(CAST(@Asigurat AS VARCHAR(5)), 'NULL');
    PRINT '  @Activ        = ' + ISNULL(CAST(@Activ AS VARCHAR(5)), 'NULL');
    PRINT '  @SortColumn   = ' + ISNULL('''' + @SortColumn + '''', 'NULL');
    PRINT '  @SortDirection= ' + ISNULL('''' + @SortDirection + '''', 'NULL');
    PRINT '';
    
    -- Call original SP
    DECLARE @Results TABLE (
        Id UNIQUEIDENTIFIER,
        Cod_Pacient NVARCHAR(20),
        CNP NVARCHAR(13),
        Nume NVARCHAR(100),
        Prenume NVARCHAR(100),
        NumeComplet NVARCHAR(201),
        Varsta INT,
        Telefon NVARCHAR(15),
        Email NVARCHAR(100),
        Judet NVARCHAR(50),
        Localitate NVARCHAR(100),
        Activ BIT,
        Asigurat BIT
    );
    
    -- Execute and capture results
    INSERT INTO @Results
    EXEC sp_Pacienti_GetAll 
        @PageNumber = @PageNumber,
        @PageSize = @PageSize,
        @SearchText = @SearchText,
        @Judet = @Judet,
        @Asigurat = @Asigurat,
        @Activ = @Activ,
        @SortColumn = @SortColumn,
        @SortDirection = @SortDirection;
    
    SELECT @RecordsReturned = COUNT(*) FROM @Results;
    
    -- Get total count
    EXEC sp_Pacienti_GetCount 
        @SearchText = @SearchText,
        @Judet = @Judet,
        @Asigurat = @Asigurat,
        @Activ = @Activ;
    
    DECLARE @EndTime DATETIME2 = GETDATE();
    DECLARE @ExecutionTimeMS INT = DATEDIFF(MILLISECOND, @StartTime, @EndTime);
    
    -- Log results AFTER execution
    PRINT '????????????????????????????????????????????????????????????????????';
    PRINT 'Results:';
    PRINT '  Records Returned = ' + CAST(@RecordsReturned AS VARCHAR(10));
    PRINT '  Total Count      = ' + CAST(@TotalCount AS VARCHAR(10));
    PRINT '  Execution Time   = ' + CAST(@ExecutionTimeMS AS VARCHAR(10)) + ' ms';
    PRINT '????????????????????????????????????????????????????????????????????';
    
    -- Diagnostic alerts
    IF @RecordsReturned = 0 AND @TotalCount = 0
    BEGIN
        PRINT '??  WARNING: Zero records returned!';
        PRINT '    This might be caused by NULL parameter handling bug';
        PRINT '    Check WHERE clause in sp_Pacienti_GetAll';
        PRINT '';
        PRINT '    Diagnostic:';
        DECLARE @TotalPacienti INT;
        SELECT @TotalPacienti = COUNT(*) FROM Pacienti;
        PRINT '      Total pacienti in DB: ' + CAST(@TotalPacienti AS VARCHAR(10));
        
        IF @TotalPacienti > 0
        BEGIN
            PRINT '      ? Problem CONFIRMED: SP returns 0 but DB has ' + CAST(@TotalPacienti AS VARCHAR(10)) + ' records';
            PRINT '      ? FIX NEEDED: Apply MASTER_FIX_AdministrarePacienti_NULL_Handling.sql';
        END
    END
    ELSE IF @RecordsReturned > 0
    BEGIN
        PRINT '? Records returned successfully';
        
        -- Show sample data
        PRINT '';
        PRINT 'Sample records (first 3):';
        SELECT TOP 3 
            Cod_Pacient,
            NumeComplet,
            Telefon,
            Activ,
            Asigurat
        FROM @Results;
    END
    
    PRINT '????????????????????????????????????????????????????????????????????';
    PRINT '';
    
    -- Return actual results
    SELECT * FROM @Results;
END
GO

PRINT '? sp_Pacienti_GetAll_WithLogging creat cu succes';
PRINT '';

-- =============================================
-- 3. Test wrapper SP
-- =============================================
PRINT '????????????????????????????????????????????????????????????????????';
PRINT 'TEST: Executare sp_Pacienti_GetAll_WithLogging';
PRINT '????????????????????????????????????????????????????????????????????';
PRINT '';

EXEC sp_Pacienti_GetAll_WithLogging
    @PageNumber = 1,
    @PageSize = 10,
    @SearchText = NULL,
    @Judet = NULL,
    @Asigurat = NULL,
    @Activ = NULL,
    @SortColumn = 'Nume',
    @SortDirection = 'ASC';

-- =============================================
-- 4. Instructions pentru monitoring live
-- =============================================
PRINT '';
PRINT '????????????????????????????????????????????????????????????????????';
PRINT 'MONITORING LIVE - INSTRUC?IUNI';
PRINT '????????????????????????????????????????????????????????????????????';
PRINT '';
PRINT 'Pentru a monitoriza apelurile din aplica?ia Blazor:';
PRINT '';
PRINT '1. În PacientRepository.cs, schimba?i temporar:';
PRINT '   "sp_Pacienti_GetAll" ? "sp_Pacienti_GetAll_WithLogging"';
PRINT '';
PRINT '2. Restart aplica?ia Blazor';
PRINT '';
PRINT '3. Accesa?i /pacienti/administrare';
PRINT '';
PRINT '4. Verifica?i log-urile SQL (Messages tab în SSMS)';
PRINT '';
PRINT '5. C?uta?i output-ul cu parametrii exacti trimi?i de C#';
PRINT '';
PRINT 'Alternative: SQL Server Profiler';
PRINT '  - Tools ? SQL Server Profiler';
PRINT '  - File ? New Trace';
PRINT '  - Events: RPC:Completed, SP:StmtCompleted';
PRINT '  - Filters: DatabaseName = ValyanMed';
PRINT '  - Start Trace';
PRINT '';
PRINT '????????????????????????????????????????????????????????????????????';
GO
