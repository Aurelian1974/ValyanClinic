# =============================================
# PowerShell Script: Get SP Definition
# Extrage ?i afi?eaz? defini?ia sp_Pacienti_GetAll
# =============================================

# Configurare culori pentru output
$Host.UI.RawUI.ForegroundColor = "White"

Write-Host ""
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?  PowerShell: Verificare sp_Pacienti_GetAll                    ?" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""

# Parametri conexiune
$ServerInstance = ".\SQLEXPRESS"  # Schimb? dac? ai alt? instan??
$Database = "ValyanMed"

Write-Host "Configurare:" -ForegroundColor Yellow
Write-Host "  Server: $ServerInstance" -ForegroundColor Gray
Write-Host "  Database: $Database" -ForegroundColor Gray
Write-Host ""

# Query SQL
$Query = @"
-- Verificare existen??
IF OBJECT_ID('dbo.sp_Pacienti_GetAll', 'P') IS NOT NULL
BEGIN
    PRINT '? sp_Pacienti_GetAll EXISTS';
    PRINT '';
    
    -- Afi?are defini?ie
    EXEC sp_helptext 'sp_Pacienti_GetAll';
END
ELSE
BEGIN
    PRINT '? sp_Pacienti_GetAll NU EXIST?!';
END
"@

try {
    Write-Host "Conectare la SQL Server..." -ForegroundColor Yellow
    
    # Executare query ?i salvare output
    $Result = Invoke-Sqlcmd -ServerInstance $ServerInstance `
                            -Database $Database `
                            -Query $Query `
                            -QueryTimeout 30 `
                            -ErrorAction Stop
    
    Write-Host "? Conectare reu?it?!" -ForegroundColor Green
    Write-Host ""
    Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host "Defini?ie sp_Pacienti_GetAll:" -ForegroundColor Cyan
    Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host ""
    
    # Afi?are rezultat
    if ($Result) {
        foreach ($row in $Result) {
            Write-Host $row.Text -ForegroundColor White
        }
    }
    else {
        Write-Host "? NU s-a primit niciun rezultat!" -ForegroundColor Red
    }
    
    Write-Host ""
    Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host ""
    
    # Salvare în fi?ier
    $OutputFile = "D:\Lucru\CMS\DevSupport\Fixes\sp_Pacienti_GetAll_Definition.txt"
    Write-Host "Salvare defini?ie în: $OutputFile" -ForegroundColor Yellow
    
    $Result | Select-Object -ExpandProperty Text | Out-File -FilePath $OutputFile -Encoding UTF8
    
    Write-Host "? Defini?ie salvat? cu succes!" -ForegroundColor Green
    Write-Host ""
    Write-Host "?? Deschide fi?ierul pentru a vedea codul complet:" -ForegroundColor Cyan
    Write-Host "   $OutputFile" -ForegroundColor Gray
    Write-Host ""
    
    # Analiz? WHERE clause
    Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host "Analiz? WHERE clause (NULL handling):" -ForegroundColor Cyan
    Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host ""
    
    $FullDefinition = ($Result | Select-Object -ExpandProperty Text) -join "`n"
    
    # Verificare @Activ
    if ($FullDefinition -match '\(@Activ\s+IS\s+NULL\s+OR\s+.*Activ\s*=\s*@Activ\)') {
        Write-Host "? @Activ: CORRECT - Folose?te (@Activ IS NULL OR Activ = @Activ)" -ForegroundColor Green
    }
    elseif ($FullDefinition -match 'WHERE.*Activ\s*=\s*@Activ') {
        Write-Host "? @Activ: BUG - Folose?te WHERE Activ = @Activ (f?r? IS NULL check)" -ForegroundColor Red
        Write-Host "   ? Aplic? MASTER_FIX_AdministrarePacienti_NULL_Handling.sql" -ForegroundColor Yellow
    }
    else {
        Write-Host "??  @Activ: Pattern nerecunoscut - verificare manual? necesar?" -ForegroundColor Yellow
    }
    
    # Verificare @Asigurat
    if ($FullDefinition -match '\(@Asigurat\s+IS\s+NULL\s+OR\s+.*Asigurat\s*=\s*@Asigurat\)') {
        Write-Host "? @Asigurat: CORRECT - Folose?te (@Asigurat IS NULL OR Asigurat = @Asigurat)" -ForegroundColor Green
    }
    elseif ($FullDefinition -match 'WHERE.*Asigurat\s*=\s*@Asigurat') {
        Write-Host "? @Asigurat: BUG - Folose?te WHERE Asigurat = @Asigurat (f?r? IS NULL check)" -ForegroundColor Red
        Write-Host "   ? Aplic? MASTER_FIX_AdministrarePacienti_NULL_Handling.sql" -ForegroundColor Yellow
    }
    else {
        Write-Host "??  @Asigurat: Pattern nerecunoscut - verificare manual? necesar?" -ForegroundColor Yellow
    }
    
    Write-Host ""
    Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "? Script finalizat!" -ForegroundColor Green
    Write-Host ""
}
catch {
    Write-Host ""
    Write-Host "? EROARE la conectarea/executarea query-ului:" -ForegroundColor Red
    Write-Host $_.Exception.Message -ForegroundColor Red
    Write-Host ""
    Write-Host "Verific?ri:" -ForegroundColor Yellow
    Write-Host "  1. SQL Server este pornit?" -ForegroundColor Gray
    Write-Host "  2. Instan?a '$ServerInstance' este corect??" -ForegroundColor Gray
    Write-Host "  3. Database-ul '$Database' exist??" -ForegroundColor Gray
    Write-Host "  4. Ai permisiuni de conectare?" -ForegroundColor Gray
    Write-Host ""
    Write-Host "?? TIP: Schimb? `$ServerInstance la începutul scriptului dac? folose?ti alt? instan??" -ForegroundColor Cyan
    Write-Host ""
}

Write-Host "Press any key to exit..." -ForegroundColor Gray
$null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
