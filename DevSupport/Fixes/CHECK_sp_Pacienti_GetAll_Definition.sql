-- =============================================
-- CHECK: Verificare Defini?ie sp_Pacienti_GetAll
-- Afi?eaz? codul complet al procedurii stocate
-- =============================================

USE [ValyanMed]
GO

PRINT '??????????????????????????????????????????????????????????????????';
PRINT '?  VERIFICARE: Defini?ie sp_Pacienti_GetAll                      ?';
PRINT '??????????????????????????????????????????????????????????????????';
PRINT '';

-- =============================================
-- 1. Verificare existen?? procedur?
-- =============================================
IF OBJECT_ID('dbo.sp_Pacienti_GetAll', 'P') IS NOT NULL
BEGIN
    PRINT '? sp_Pacienti_GetAll EXISTS';
    PRINT '';
    
    -- =============================================
    -- 2. Afi?are defini?ie complet?
    -- =============================================
    PRINT '????????????????????????????????????????????????????????????????';
    PRINT 'Defini?ie complet? procedur?:';
    PRINT '????????????????????????????????????????????????????????????????';
    PRINT '';
    
    EXEC sp_helptext 'sp_Pacienti_GetAll';
    
    PRINT '';
    PRINT '????????????????????????????????????????????????????????????????';
    
    -- =============================================
    -- 3. Analiz? WHERE clause (c?utare text)
    -- =============================================
    PRINT '';
    PRINT '????????????????????????????????????????????????????????????????';
    PRINT 'Analiz? WHERE clause pentru NULL handling:';
    PRINT '????????????????????????????????????????????????????????????????';
    
    DECLARE @SPDefinition NVARCHAR(MAX);
    SELECT @SPDefinition = OBJECT_DEFINITION(OBJECT_ID('dbo.sp_Pacienti_GetAll'));
    
    -- Verificare @Activ handling
    PRINT '';
    PRINT '1. Verificare @Activ handling:';
    IF @SPDefinition LIKE '%(@Activ IS NULL OR%Activ%=%@Activ)%'
    BEGIN
        PRINT '   ? CORRECT: Folose?te (@Activ IS NULL OR Activ = @Activ)';
    END
    ELSE IF @SPDefinition LIKE '%WHERE%Activ%=%@Activ%'
    BEGIN
        PRINT '   ? BUG: Folose?te WHERE Activ = @Activ (f?r? IS NULL check)';
    END
    ELSE
    BEGIN
        PRINT '   ??  Pattern nerecunoscut - verificare manual? necesar?';
    END
    
    -- Verificare @Asigurat handling
    PRINT '';
    PRINT '2. Verificare @Asigurat handling:';
    IF @SPDefinition LIKE '%(@Asigurat IS NULL OR%Asigurat%=%@Asigurat)%'
    BEGIN
        PRINT '   ? CORRECT: Folose?te (@Asigurat IS NULL OR Asigurat = @Asigurat)';
    END
    ELSE IF @SPDefinition LIKE '%WHERE%Asigurat%=%@Asigurat%'
    BEGIN
        PRINT '   ? BUG: Folose?te WHERE Asigurat = @Asigurat (f?r? IS NULL check)';
    END
    ELSE
    BEGIN
        PRINT '   ??  Pattern nerecunoscut - verificare manual? necesar?';
    END
    
    -- Verificare @Judet handling
    PRINT '';
    PRINT '3. Verificare @Judet handling:';
    IF @SPDefinition LIKE '%(@Judet IS NULL OR%Judet%=%@Judet)%'
    BEGIN
        PRINT '   ? CORRECT: Folose?te (@Judet IS NULL OR Judet = @Judet)';
    END
    ELSE IF @SPDefinition LIKE '%WHERE%Judet%=%@Judet%'
    BEGIN
        PRINT '   ? BUG: Folose?te WHERE Judet = @Judet (f?r? IS NULL check)';
    END
    ELSE
    BEGIN
        PRINT '   ??  Pattern nerecunoscut - verificare manual? necesar?';
    END
    
    -- Verificare @SearchText handling
    PRINT '';
    PRINT '4. Verificare @SearchText handling:';
    IF @SPDefinition LIKE '%(@SearchText IS NULL OR%LIKE%@SearchText%'
    BEGIN
        PRINT '   ? CORRECT: Folose?te (@SearchText IS NULL OR ... LIKE ...)';
    END
    ELSE IF @SPDefinition LIKE '%WHERE%LIKE%@SearchText%'
    BEGIN
        PRINT '   ? BUG: Folose?te WHERE ... LIKE @SearchText (f?r? IS NULL check)';
    END
    ELSE
    BEGIN
        PRINT '   ??  Pattern nerecunoscut - verificare manual? necesar?';
    END
    
    PRINT '';
    PRINT '????????????????????????????????????????????????????????????????';
    
    -- =============================================
    -- 4. Test practic cu parametri NULL
    -- =============================================
    PRINT '';
    PRINT '????????????????????????????????????????????????????????????????';
    PRINT 'Test practic: Apel SP cu parametri NULL';
    PRINT '????????????????????????????????????????????????????????????????';
    PRINT '';
    
    -- Count înainte de apel
    DECLARE @TotalInDB INT;
    SELECT @TotalInDB = COUNT(*) FROM Pacienti;
    PRINT 'Total pacien?i în DB: ' + CAST(@TotalInDB AS VARCHAR(10));
    PRINT '';
    
    -- Apel SP
    PRINT 'Executare: EXEC sp_Pacienti_GetAll @PageNumber=1, @PageSize=25, @SearchText=NULL, @Judet=NULL, @Asigurat=NULL, @Activ=NULL, @SortColumn=''Nume'', @SortDirection=''ASC''';
    PRINT '';
    
    -- Cre?m un tabel temporar pentru a conta rezultatele
    CREATE TABLE #TestResults (
        Id UNIQUEIDENTIFIER,
        Cod_Pacient NVARCHAR(20),
        Nume NVARCHAR(100),
        Prenume NVARCHAR(100)
    );
    
    INSERT INTO #TestResults (Id, Cod_Pacient, Nume, Prenume)
    EXEC sp_Pacienti_GetAll
        @PageNumber = 1,
        @PageSize = 25,
        @SearchText = NULL,
        @Judet = NULL,
        @Asigurat = NULL,
        @Activ = NULL,
        @SortColumn = 'Nume',
        @SortDirection = 'ASC';
    
    DECLARE @ResultCount INT;
    SELECT @ResultCount = COUNT(*) FROM #TestResults;
    
    PRINT '';
    PRINT 'Rezultat: SP a returnat ' + CAST(@ResultCount AS VARCHAR(10)) + ' înregistr?ri';
    PRINT '';
    
    IF @ResultCount = 0 AND @TotalInDB > 0
    BEGIN
        PRINT '? BUG CONFIRMAT: SP returneaz? 0 dar DB are ' + CAST(@TotalInDB AS VARCHAR(10)) + ' înregistr?ri';
        PRINT '   ? WHERE clause NU trateaz? corect NULL parameters';
        PRINT '   ? SOLU?IE: Ruleaz? MASTER_FIX_AdministrarePacienti_NULL_Handling.sql';
    END
    ELSE IF @ResultCount > 0
    BEGIN
        PRINT '? SP FUNC?IONEAZ? CORECT: Returneaz? ' + CAST(@ResultCount AS VARCHAR(10)) + ' înregistr?ri';
        PRINT '   ? WHERE clause trateaz? corect NULL parameters';
    END
    ELSE IF @TotalInDB = 0
    BEGIN
        PRINT '??  DB GOOAL?: Nu exist? date de test în tabela Pacienti';
    END
    
    DROP TABLE #TestResults;
    
    PRINT '';
    PRINT '????????????????????????????????????????????????????????????????';
END
ELSE
BEGIN
    PRINT '? sp_Pacienti_GetAll NU EXIST?!';
    PRINT '   ? Procedura trebuie creat?';
    PRINT '   ? Ruleaz? scriptul de creare din DevSupport/01_Database/02_StoredProcedures/';
END

PRINT '';
PRINT '??????????????????????????????????????????????????????????????????';
PRINT '?  FINAL: Verificare complet?                                    ?';
PRINT '??????????????????????????????????????????????????????????????????';
GO
