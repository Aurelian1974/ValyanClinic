-- =============================================
-- INVESTIGARE: Structura exact? a sp_Pacienti_GetAll
-- Verificare coloane returnate de SP
-- =============================================

USE [ValyanMed]
GO

PRINT '??????????????????????????????????????????????????????????????????????';
PRINT '?   INVESTIGARE: Coloane returnate de sp_Pacienti_GetAll            ?';
PRINT '??????????????????????????????????????????????????????????????????????';
PRINT '';

-- =============================================
-- 1. Verificare SP existent
-- =============================================
IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'sp_Pacienti_GetAll')
BEGIN
    PRINT '? sp_Pacienti_GetAll exist?';
    PRINT '';
    
    -- Afi?are cod surs?
    PRINT '????????????????????????????????????????????????????????????????????';
    PRINT 'Cod surs? sp_Pacienti_GetAll:';
    PRINT '????????????????????????????????????????????????????????????????????';
    SELECT OBJECT_DEFINITION(OBJECT_ID('dbo.sp_Pacienti_GetAll')) AS 'SP Definition';
    PRINT '';
END
ELSE
BEGIN
    PRINT '? sp_Pacienti_GetAll NU exist?!';
    GOTO EndScript;
END

-- =============================================
-- 2. Test execu?ie pentru a vedea coloanele
-- =============================================
PRINT '????????????????????????????????????????????????????????????????????';
PRINT 'Test execu?ie - primele 2 records:';
PRINT '????????????????????????????????????????????????????????????????????';

BEGIN TRY
    -- Creare tabel temporar pentru a captura structura
    IF OBJECT_ID('tempdb..#TestResults') IS NOT NULL
        DROP TABLE #TestResults;
    
    -- Execu?ie SP
    CREATE TABLE #TestResults (
        -- Va e?ua dac? structura nu se potrive?te, dar îl putem folosi pentru investigare
        Id UNIQUEIDENTIFIER,
        Cod_Pacient NVARCHAR(20),
        CNP NVARCHAR(13),
        Nume NVARCHAR(100),
        Prenume NVARCHAR(100)
        -- Adaug? mai multe coloane dup? ce vedem eroarea
    );
    
    -- Nu vom insera, doar vom executa pentru a vedea structura
    EXEC sp_Pacienti_GetAll 
        @PageNumber = 1,
        @PageSize = 2,
        @SearchText = NULL,
        @Judet = NULL,
        @Asigurat = NULL,
        @Activ = NULL,
        @SortColumn = 'Nume',
        @SortDirection = 'ASC';
    
    PRINT '? SP executat cu succes';
    PRINT '';
    
    PRINT 'Afi?are metadata coloane:';
    PRINT '????????????????????????????????????????????????????????????????????';
    
    -- Nu putem folosi sp_describe_first_result_set pentru SP cu parametri dinamici
    -- Deci vom executa ?i analiza manual
    
END TRY
BEGIN CATCH
    PRINT '? Eroare la execu?ie SP:';
    PRINT '  Error Number: ' + CAST(ERROR_NUMBER() AS VARCHAR(10));
    PRINT '  Error Message: ' + ERROR_MESSAGE();
    PRINT '  Error Line: ' + CAST(ERROR_LINE() AS VARCHAR(10));
END CATCH

PRINT '';

-- =============================================
-- 3. Verificare structura tabela Pacienti
-- =============================================
PRINT '????????????????????????????????????????????????????????????????????';
PRINT 'Structura tabelei Pacienti (pentru referin??):';
PRINT '????????????????????????????????????????????????????????????????????';

SELECT 
    COLUMN_NAME AS 'Coloana',
    DATA_TYPE AS 'Tip',
    CHARACTER_MAXIMUM_LENGTH AS 'Lungime',
    IS_NULLABLE AS 'NULL?',
    ORDINAL_POSITION AS 'Ordine'
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME = 'Pacienti'
ORDER BY ORDINAL_POSITION;

PRINT '';

-- =============================================
-- 4. Compara?ie cu ce a?teapt? C# (Pacient entity)
-- =============================================
PRINT '????????????????????????????????????????????????????????????????????';
PRINT 'Coloane a?teptate de C# (Pacient entity):';
PRINT '????????????????????????????????????????????????????????????????????';
PRINT '';
PRINT 'Conform PacientRepository.cs, se a?teapt? toate coloanele din tabela Pacienti:';
PRINT '  - Id, Cod_Pacient, CNP, Nume, Prenume';
PRINT '  - NumeComplet (computed), Varsta (computed)';
PRINT '  - Data_Nasterii, Sex';
PRINT '  - Telefon, Telefon_Secundar, Email';
PRINT '  - Judet, Localitate, Adresa, Cod_Postal';
PRINT '  - AdresaCompleta (computed)';
PRINT '  - Asigurat, CNP_Asigurat, Nr_Card_Sanatate, Casa_Asigurari';
PRINT '  - Alergii, Boli_Cronice, Medic_Familie';
PRINT '  - Persoana_Contact, Telefon_Urgenta, Relatie_Contact';
PRINT '  - Data_Inregistrare, Ultima_Vizita, Nr_Total_Vizite';
PRINT '  - Activ, Observatii';
PRINT '  - Data_Crearii, Data_Ultimei_Modificari, Creat_De, Modificat_De';
PRINT '';

-- =============================================
-- 5. Diagnostic Msg 213
-- =============================================
PRINT '????????????????????????????????????????????????????????????????????';
PRINT 'DIAGNOSTIC: Msg 213 Error';
PRINT '????????????????????????????????????????????????????????????????????';
PRINT '';
PRINT 'Eroarea "Column name or number of supplied values does not match"';
PRINT 'apare când:';
PRINT '  1. SP returneaz? mai multe/pu?ine coloane decât se a?teapt?';
PRINT '  2. INSERT în tabel temporar are num?r diferit de coloane';
PRINT '  3. Ordinea coloanelor nu se potrive?te';
PRINT '';
PRINT 'În cazul nostru, problema este probabil:';
PRINT '  - SP MASTER_FIX returneaz? un set de coloane';
PRINT '  - Dar Dapper (în C#) sau TRACE wrapper a?teapt? altceva';
PRINT '';

EndScript:
PRINT '????????????????????????????????????????????????????????????????????';
PRINT 'INVESTIGARE COMPLET?';
PRINT '????????????????????????????????????????????????????????????????????';
GO
