# =============================================
# PowerShell Script: Test sp_Pacienti_GetAll
# Ruleaz? diagnostic complet folosind connection string din appsettings.json
# =============================================

# Configurare culori
$Host.UI.RawUI.ForegroundColor = "White"

Write-Host ""
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?  DIAGNOSTIC: sp_Pacienti_GetAll (din appsettings.json)        ?" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""

# Connection String din appsettings.json
$ServerInstance = "DESKTOP-3Q8HI82\ERP"
$Database = "ValyanMed"

Write-Host "Configurare (din appsettings.json):" -ForegroundColor Yellow
Write-Host "  Server: $ServerInstance" -ForegroundColor Gray
Write-Host "  Database: $Database" -ForegroundColor Gray
Write-Host ""

# Query SQL complet pentru diagnostic
$Query = @"
SET NOCOUNT ON;

PRINT '??????????????????????????????????????????????????????????????????';
PRINT '?  DIAGNOSTIC FINAL: Test Direct sp_Pacienti_GetAll              ?';
PRINT '??????????????????????????????????????????????????????????????????';
PRINT '';

-- =============================================
-- 0. ? PRIMA PRIORITATE: Afi?are defini?ie complet? SP
-- =============================================
PRINT '0. Defini?ie complet? sp_Pacienti_GetAll:';
PRINT '????????????????????????????????????????????????????????????????';
PRINT '(SCROLL UP pentru a vedea toat? defini?ia)';
PRINT '';

EXEC sp_helptext 'sp_Pacienti_GetAll';

PRINT '';
PRINT '????????????????????????????????????????????????????????????????';
PRINT '';

-- =============================================
-- 1. Verificare date în tabela Pacienti
-- =============================================
PRINT '1. Verificare date în tabela Pacienti:';
PRINT '????????????????????????????????????????????????????????????????';

SELECT COUNT(*) AS 'Total_Pacienti_in_DB' FROM Pacienti;
SELECT COUNT(*) AS 'Pacienti_Activi' FROM Pacienti WHERE Activ = 1;
SELECT COUNT(*) AS 'Pacienti_Inactivi' FROM Pacienti WHERE Activ = 0;

PRINT '';

-- Afi?are primii 3 pacien?i
SELECT TOP 3 
    Id,
    Cod_Pacient,
    Nume,
    Prenume,
    CONCAT(Nume, ' ', Prenume) AS NumeComplet,
    Activ,
    Asigurat,
    Data_Crearii
FROM Pacienti
ORDER BY Nume;

PRINT '';
PRINT '????????????????????????????????????????????????????????????????';

-- =============================================
-- 2. Verificare structur? SP (Analiz? automat?)
-- =============================================
PRINT '';
PRINT '2. Verificare WHERE clause în sp_Pacienti_GetAll:';
PRINT '????????????????????????????????????????????????????????????????';

DECLARE @SPDefinition NVARCHAR(MAX);
SELECT @SPDefinition = OBJECT_DEFINITION(OBJECT_ID('dbo.sp_Pacienti_GetAll'));

-- C?utare WHERE clause pentru @Activ
IF @SPDefinition LIKE '%(@Activ IS NULL OR%Activ%=%@Activ)%'
BEGIN
    PRINT '? CORRECT: WHERE (@Activ IS NULL OR Activ = @Activ)';
END
ELSE IF @SPDefinition LIKE '%WHERE%Activ%=%@Activ%'
BEGIN
    PRINT '? PROBLEMATIC: WHERE Activ = @Activ (returneaz? 0 când @Activ este NULL)';
END
ELSE
BEGIN
    PRINT '??  NU g?sit pattern cunoscut pentru @Activ';
END

-- C?utare WHERE clause pentru @Asigurat
IF @SPDefinition LIKE '%(@Asigurat IS NULL OR%Asigurat%=%@Asigurat)%'
BEGIN
    PRINT '? CORRECT: WHERE (@Asigurat IS NULL OR Asigurat = @Asigurat)';
END
ELSE IF @SPDefinition LIKE '%WHERE%Asigurat%=%@Asigurat%'
BEGIN
    PRINT '? PROBLEMATIC: WHERE Asigurat = @Asigurat';
END
ELSE
BEGIN
    PRINT '??  NU g?sit pattern cunoscut pentru @Asigurat';
END

PRINT '';
PRINT '????????????????????????????????????????????????????????????????';

-- =============================================
-- 3. Test manual WHERE clause
-- =============================================
PRINT '';
PRINT '3. Test manual WHERE clause (simulare SP logic):';
PRINT '????????????????????????????????????????????????????????????????';

DECLARE @Activ BIT = NULL;
DECLARE @Asigurat BIT = NULL;

PRINT 'Parametri: @Activ = NULL, @Asigurat = NULL';
PRINT '';

-- Test GRE?IT (cum era înainte)
PRINT 'A) WHERE Activ = @Activ AND Asigurat = @Asigurat (GRE?IT):';
SELECT COUNT(*) AS 'Records_Returned_WRONG'
FROM Pacienti
WHERE Activ = @Activ AND Asigurat = @Asigurat;

PRINT '';

-- Test CORECT (cum ar trebui s? fie)
PRINT 'B) WHERE (@Activ IS NULL OR Activ = @Activ) AND (@Asigurat IS NULL OR Asigurat = @Asigurat) (CORECT):';
SELECT COUNT(*) AS 'Records_Returned_CORRECT'
FROM Pacienti
WHERE (@Activ IS NULL OR Activ = @Activ)
  AND (@Asigurat IS NULL OR Asigurat = @Asigurat);

PRINT '';
PRINT '????????????????????????????????????????????????????????????????';

-- =============================================
-- 4. Test sp_Pacienti_GetAll - SIMPLIFIED (doar COUNT)
-- =============================================
PRINT '';
PRINT '4. Test sp_Pacienti_GetAll cu TO?I parametrii NULL:';
PRINT '????????????????????????????????????????????????????????????????';
PRINT 'Parametri:';
PRINT '  @PageNumber   = 1';
PRINT '  @PageSize     = 25';
PRINT '  @SearchText   = NULL';
PRINT '  @Judet        = NULL';
PRINT '  @Asigurat     = NULL';
PRINT '  @Activ        = NULL';
PRINT '  @SortColumn   = ''Nume''';
PRINT '  @SortDirection= ''ASC''';
PRINT '';

-- ? SIMPLIFIED: Doar cont?m rezultatele (evit?m column mismatch)
DECLARE @SPResultCount INT = 0;

BEGIN TRY
    -- Cre?m un tabel temporar cu TOATE coloanele din Pacienti
    IF OBJECT_ID('tempdb..#TestResults') IS NOT NULL
        DROP TABLE #TestResults;
        
    SELECT TOP 0 * 
    INTO #TestResults
    FROM Pacienti;
    
    -- Insert results from SP
    INSERT INTO #TestResults
    EXEC sp_Pacienti_GetAll
        @PageNumber = 1,
        @PageSize = 25,
        @SearchText = NULL,
        @Judet = NULL,
        @Asigurat = NULL,
        @Activ = NULL,
        @SortColumn = 'Nume',
        @SortDirection = 'ASC';
    
    SELECT @SPResultCount = COUNT(*) FROM #TestResults;
    
    PRINT 'Rezultat SP: ' + CAST(@SPResultCount AS VARCHAR(10)) + ' records returnate';
    
    -- Afi?are primele 3 înregistr?ri returnate
    IF @SPResultCount > 0
    BEGIN
        PRINT '';
        PRINT 'Primele 3 înregistr?ri returnate de SP:';
        SELECT TOP 3 Cod_Pacient, Nume, Prenume, Activ, Asigurat FROM #TestResults ORDER BY Nume;
    END
    
    DROP TABLE #TestResults;
END TRY
BEGIN CATCH
    PRINT '';
    PRINT '? EROARE la executarea SP:';
    PRINT ERROR_MESSAGE();
    PRINT '';
END CATCH

PRINT '';
PRINT '????????????????????????????????????????????????????????????????';

PRINT '';
PRINT '??????????????????????????????????????????????????????????????????';
PRINT '?  CONCLUZIE:                                                     ?';
PRINT '??????????????????????????????????????????????????????????????????';
PRINT '?  Verific? defini?ia SP de la ÎNCEPUTUL output-ului!            ?';
PRINT '?                                                                  ?';
PRINT '?  Dac? Test 4 returneaz? 0 records dar tabela are date:         ?';
PRINT '?  ? SP-ul ARE BUG de NULL handling                               ?';
PRINT '?  ? Aplic?: MASTER_FIX_AdministrarePacienti_NULL_Handling.sql   ?';
PRINT '?                                                                  ?';
PRINT '?  Dac? Test 4 returneaz? records:                                ?';
PRINT '?  ? SP-ul func?ioneaz? CORECT                                    ?';
PRINT '?  ? Problema este în C# (Dapper mapping sau connection)         ?';
PRINT '??????????????????????????????????????????????????????????????????';
"@

try {
    Write-Host "Conectare la SQL Server..." -ForegroundColor Yellow
    
    # Executare query
    $Results = Invoke-Sqlcmd -ServerInstance $ServerInstance `
                             -Database $Database `
                             -Query $Query `
                             -QueryTimeout 60 `
                             -ErrorAction Stop `
                             -Verbose
    
    Write-Host ""
    Write-Host "? Query executat cu succes!" -ForegroundColor Green
    Write-Host ""
    Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host "REZULTATE:" -ForegroundColor Cyan
    Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host ""
    
    # Afi?are rezultate
    $Results | Format-Table -AutoSize
    
    Write-Host ""
    Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host ""
    
    # Salvare rezultate în fi?ier
    $OutputFile = "D:\Lucru\CMS\DevSupport\Fixes\DIAGNOSTIC_RESULTS.txt"
    
    Write-Host "Salvare rezultate în: $OutputFile" -ForegroundColor Yellow
    
    $Results | Out-File -FilePath $OutputFile -Encoding UTF8 -Width 200
    
    Write-Host "? Rezultate salvate!" -ForegroundColor Green
    Write-Host ""
    
    # Analiz? rapid?
    Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host "ANALIZ? RAPID?:" -ForegroundColor Cyan
    Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host ""
    
    $TotalPacienti = ($Results | Where-Object { $_.Column1 -eq 'Total_Pacienti_in_DB' }).ItemArray[1]
    $RecordsWrong = ($Results | Where-Object { $_.Column1 -eq 'Records_Returned_WRONG' }).ItemArray[1]
    $RecordsCorrect = ($Results | Where-Object { $_.Column1 -eq 'Records_Returned_CORRECT' }).ItemArray[1]
    
    Write-Host "Total pacien?i în DB: $TotalPacienti" -ForegroundColor White
    Write-Host ""
    Write-Host "WHERE Activ = @Activ (GRE?IT): $RecordsWrong records" -ForegroundColor $(if ($RecordsWrong -eq 0) { "Red" } else { "Green" })
    Write-Host "WHERE (@Activ IS NULL OR...) (CORECT): $RecordsCorrect records" -ForegroundColor $(if ($RecordsCorrect -gt 0) { "Green" } else { "Red" })
    Write-Host ""
    
    if ($RecordsWrong -eq 0 -and $RecordsCorrect -gt 0 -and $TotalPacienti -gt 0) {
        Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Red
        Write-Host "?  ? BUG CONFIRMAT în sp_Pacienti_GetAll!                       ?" -ForegroundColor Red
        Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Red
        Write-Host "?  SP-ul folose?te WHERE Activ = @Activ (f?r? IS NULL check)    ?" -ForegroundColor Red
        Write-Host "?                                                                 ?" -ForegroundColor Red
        Write-Host "?  SOLU?IE:                                                       ?" -ForegroundColor Yellow
        Write-Host "?  1. Deschide: MASTER_FIX_AdministrarePacienti_NULL_Handling.sql?" -ForegroundColor Yellow
        Write-Host "?  2. Ruleaz? în SSMS (F5)                                        ?" -ForegroundColor Yellow
        Write-Host "?  3. Restart aplica?ia C#                                        ?" -ForegroundColor Yellow
        Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Red
    }
    elseif ($RecordsWrong -gt 0 -and $RecordsCorrect -gt 0) {
        Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Green
        Write-Host "?  ? SP-ul func?ioneaz? CORECT!                                  ?" -ForegroundColor Green
        Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Green
        Write-Host "?  WHERE clause trateaz? corect NULL parameters                  ?" -ForegroundColor Green
        Write-Host "?                                                                 ?" -ForegroundColor Green
        Write-Host "?  Dac? aplica?ia tot arat? 0 records:                           ?" -ForegroundColor Yellow
        Write-Host "?  ? Problema este în C# (Dapper mapping sau connection)        ?" -ForegroundColor Yellow
        Write-Host "?  ? Verific? log-urile din PacientRepository                   ?" -ForegroundColor Yellow
        Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Green
    }
    
    Write-Host ""
    Write-Host "? Diagnostic complet!" -ForegroundColor Green
    Write-Host ""
}
catch {
    Write-Host ""
    Write-Host "? EROARE la executarea query-ului:" -ForegroundColor Red
    Write-Host $_.Exception.Message -ForegroundColor Red
    Write-Host ""
    Write-Host "Stack Trace:" -ForegroundColor Yellow
    Write-Host $_.Exception.StackTrace -ForegroundColor Gray
    Write-Host ""
    Write-Host "Verific?ri:" -ForegroundColor Yellow
    Write-Host "  1. SQL Server este pornit?" -ForegroundColor Gray
    Write-Host "  2. Instan?a 'DESKTOP-3Q8HI82\ERP' este accesibil??" -ForegroundColor Gray
    Write-Host "  3. Database-ul 'ValyanMed' exist??" -ForegroundColor Gray
    Write-Host "  4. Ai permisiuni de conectare?" -ForegroundColor Gray
    Write-Host "  5. Windows Authentication func?ioneaz??" -ForegroundColor Gray
    Write-Host ""
}

Write-Host "Press any key to exit..." -ForegroundColor Gray
$null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
