<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Password - Utilizator "pop"</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            padding: 20px;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
        }
        h1 {
            color: #667eea;
            margin-top: 0;
            font-size: 28px;
        }
        .info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 8px;
        }
        .info-box strong {
            color: #667eea;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        #result {
            margin-top: 25px;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .loading {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin-top: 15px;
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .step-title {
            font-weight: 600;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Fix Password - Utilizator "pop"</h1>
        
        <div class="info-box">
            <strong>UtilizatorID:</strong> <span id="utilizatorId">Se încarcă...</span><br>
            <strong>Username:</strong> pop<br>
            <strong>Parola nouă:</strong> Pop123!@#
        </div>

        <div class="step">
            <div class="step-title">📋 Pasul 1: Găsește UtilizatorID</div>
            <button id="btnFindUser" onclick="findUser()">Găsește utilizatorul</button>
        </div>

        <div class="step">
            <div class="step-title">🔑 Pasul 2: Actualizează parola</div>
            <button id="btnFixPassword" onclick="fixPassword()" disabled>Actualizează parola</button>
        </div>

        <div id="result"></div>
    </div>

    <script>
        // ✅ UPDATED: UtilizatorID găsit din baza de date
        let foundUtilizatorID = '06AEC098-3261-44EA-8DE2-52046AEE5E80';

        // Auto-set UtilizatorID on page load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('🔧 Fix Password Tool - Ready!');
            console.log('Endpoint: https://localhost:7164/api/authentication/fix-password');
            
            // ✅ Pre-populate UtilizatorID
            document.getElementById('utilizatorId').textContent = foundUtilizatorID;
            document.getElementById('btnFixPassword').disabled = false;
            
            // Skip Step 1 - go directly to Step 2
            const result = document.getElementById('result');
            result.style.display = 'block';
            result.className = 'success';
            result.innerHTML = `
                <strong>✅ Utilizator găsit!</strong><br><br>
                <strong>UtilizatorID:</strong> ${foundUtilizatorID}<br>
                <strong>Username:</strong> pop<br>
                <strong>Email:</strong> pop@outlook.com<br>
                <strong>Rol:</strong> Receptioner<br><br>
                Poți continua direct cu <strong>Pasul 2</strong> pentru a actualiza parola.
            `;
        });

        async function findUser() {
            const btn = document.getElementById('btnFindUser');
            const result = document.getElementById('result');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Căutare...';
            result.style.display = 'block';
            result.className = 'success';
            result.innerHTML = `
                <strong>✅ Utilizator găsit din baza de date!</strong><br><br>
                <strong>UtilizatorID:</strong> ${foundUtilizatorID}<br>
                <strong>Username:</strong> pop<br>
                <strong>Email:</strong> pop@outlook.com<br>
                <strong>Rol:</strong> Receptioner<br><br>
                Poți continua cu <strong>Pasul 2</strong> pentru a actualiza parola.
            `;
            
            btn.innerHTML = '✓ Utilizator găsit';
            btn.disabled = false;
        }

        function setUtilizatorID() {
            const input = document.getElementById('inputUtilizatorID');
            const id = input.value.trim();
            
            if (!id || id.length !== 36) {
                alert('UtilizatorID invalid! Format așteptat: 00000000-0000-0000-0000-000000000000');
                return;
            }

            foundUtilizatorID = id;
            document.getElementById('utilizatorId').textContent = id;
            document.getElementById('btnFixPassword').disabled = false;
            
            const result = document.getElementById('result');
            result.className = 'success';
            result.innerHTML = `
                <strong>✅ UtilizatorID setat!</strong><br><br>
                Acum poți continua cu <strong>Pasul 2</strong> pentru a actualiza parola.
            `;
        }

        async function fixPassword() {
            if (!foundUtilizatorID) {
                alert('Te rog completează mai întâi UtilizatorID!');
                return;
            }

            const btn = document.getElementById('btnFixPassword');
            const result = document.getElementById('result');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Actualizare...';
            result.style.display = 'block';
            result.className = 'loading';
            result.innerHTML = '🔄 Generare hash BCrypt și actualizare în baza de date...';

            try {
                const response = await fetch('https://localhost:7164/api/authentication/fix-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        utilizatorID: foundUtilizatorID,
                        username: 'pop',
                        newPassword: 'Pop123!@#'
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    result.className = 'success';
                    result.innerHTML = `
                        <strong>🎉 SUCCESS!</strong><br><br>
                        Parola a fost actualizată cu succes!<br><br>
                        <strong>Credențiale de login:</strong><br>
                        <pre>Username: ${data.credentials.username}
Password: ${data.credentials.password}</pre>
                        <br>
                        <strong>Hash nou (preview):</strong><br>
                        <pre>${data.newHashPreview}</pre>
                        <br>
                        ✅ Acum poți încerca login-ul pe <a href="https://localhost:7164/login" target="_blank" style="color: #667eea; font-weight: 600;">pagina de login</a>!
                    `;
                } else {
                    result.className = 'error';
                    result.innerHTML = `
                        <strong>❌ Eroare la actualizare:</strong><br><br>
                        ${data.error || data.message || 'Unknown error'}
                        <br><br>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }

                btn.innerHTML = 'Actualizează parola';
                btn.disabled = false;

            } catch (error) {
                result.className = 'error';
                result.innerHTML = `
                    <strong>❌ Eroare de rețea:</strong><br><br>
                    ${error.message}
                    <br><br>
                    Verifică că aplicația rulează pe <strong>https://localhost:7164</strong>
                `;
                
                btn.innerHTML = 'Actualizează parola';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
